{"version":3,"sources":["file:///workspace/appflow/src/vs/editor/contrib/semanticTokens/browser/viewportSemanticTokens.ts"],"names":[],"mappings":"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","file":"viewportSemanticTokens.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancelablePromise, createCancelablePromise, RunOnceScheduler } from 'vs/base/common/async';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { ICodeEditor } from 'vs/editor/browser/editorBrowser';\nimport { EditorContributionInstantiation, registerEditorContribution } from 'vs/editor/browser/editorExtensions';\nimport { Range } from 'vs/editor/common/core/range';\nimport { IEditorContribution } from 'vs/editor/common/editorCommon';\nimport { ITextModel } from 'vs/editor/common/model';\nimport { getDocumentRangeSemanticTokens, hasDocumentRangeSemanticTokensProvider } from 'vs/editor/contrib/semanticTokens/common/getSemanticTokens';\nimport { isSemanticColoringEnabled, SEMANTIC_HIGHLIGHTING_SETTING_ID } from 'vs/editor/contrib/semanticTokens/common/semanticTokensConfig';\nimport { toMultilineTokens2 } from 'vs/editor/common/services/semanticTokensProviderStyling';\nimport { IConfigurationService } from 'vs/platform/configuration/common/configuration';\nimport { IThemeService } from 'vs/platform/theme/common/themeService';\nimport { IFeatureDebounceInformation, ILanguageFeatureDebounceService } from 'vs/editor/common/services/languageFeatureDebounce';\nimport { StopWatch } from 'vs/base/common/stopwatch';\nimport { LanguageFeatureRegistry } from 'vs/editor/common/languageFeatureRegistry';\nimport { DocumentRangeSemanticTokensProvider } from 'vs/editor/common/languages';\nimport { ILanguageFeaturesService } from 'vs/editor/common/services/languageFeatures';\nimport { ISemanticTokensStylingService } from 'vs/editor/common/services/semanticTokensStyling';\n\nexport class ViewportSemanticTokensContribution extends Disposable implements IEditorContribution {\n\n\tpublic static readonly ID = 'editor.contrib.viewportSemanticTokens';\n\n\tpublic static get(editor: ICodeEditor): ViewportSemanticTokensContribution | null {\n\t\treturn editor.getContribution<ViewportSemanticTokensContribution>(ViewportSemanticTokensContribution.ID);\n\t}\n\n\tprivate readonly _editor: ICodeEditor;\n\tprivate readonly _provider: LanguageFeatureRegistry<DocumentRangeSemanticTokensProvider>;\n\tprivate readonly _debounceInformation: IFeatureDebounceInformation;\n\tprivate readonly _tokenizeViewport: RunOnceScheduler;\n\tprivate _outstandingRequests: CancelablePromise<any>[];\n\n\tconstructor(\n\t\teditor: ICodeEditor,\n\t\t@ISemanticTokensStylingService private readonly _semanticTokensStylingService: ISemanticTokensStylingService,\n\t\t@IThemeService private readonly _themeService: IThemeService,\n\t\t@IConfigurationService private readonly _configurationService: IConfigurationService,\n\t\t@ILanguageFeatureDebounceService languageFeatureDebounceService: ILanguageFeatureDebounceService,\n\t\t@ILanguageFeaturesService languageFeaturesService: ILanguageFeaturesService,\n\t) {\n\t\tsuper();\n\t\tthis._editor = editor;\n\t\tthis._provider = languageFeaturesService.documentRangeSemanticTokensProvider;\n\t\tthis._debounceInformation = languageFeatureDebounceService.for(this._provider, 'DocumentRangeSemanticTokens', { min: 100, max: 500 });\n\t\tthis._tokenizeViewport = this._register(new RunOnceScheduler(() => this._tokenizeViewportNow(), 100));\n\t\tthis._outstandingRequests = [];\n\t\tconst scheduleTokenizeViewport = () => {\n\t\t\tif (this._editor.hasModel()) {\n\t\t\t\tthis._tokenizeViewport.schedule(this._debounceInformation.get(this._editor.getModel()));\n\t\t\t}\n\t\t};\n\t\tthis._register(this._editor.onDidScrollChange(() => {\n\t\t\tscheduleTokenizeViewport();\n\t\t}));\n\t\tthis._register(this._editor.onDidChangeModel(() => {\n\t\t\tthis._cancelAll();\n\t\t\tscheduleTokenizeViewport();\n\t\t}));\n\t\tthis._register(this._editor.onDidChangeModelContent((e) => {\n\t\t\tthis._cancelAll();\n\t\t\tscheduleTokenizeViewport();\n\t\t}));\n\t\tthis._register(this._provider.onDidChange(() => {\n\t\t\tthis._cancelAll();\n\t\t\tscheduleTokenizeViewport();\n\t\t}));\n\t\tthis._register(this._configurationService.onDidChangeConfiguration(e => {\n\t\t\tif (e.affectsConfiguration(SEMANTIC_HIGHLIGHTING_SETTING_ID)) {\n\t\t\t\tthis._cancelAll();\n\t\t\t\tscheduleTokenizeViewport();\n\t\t\t}\n\t\t}));\n\t\tthis._register(this._themeService.onDidColorThemeChange(() => {\n\t\t\tthis._cancelAll();\n\t\t\tscheduleTokenizeViewport();\n\t\t}));\n\t\tscheduleTokenizeViewport();\n\t}\n\n\tprivate _cancelAll(): void {\n\t\tfor (const request of this._outstandingRequests) {\n\t\t\trequest.cancel();\n\t\t}\n\t\tthis._outstandingRequests = [];\n\t}\n\n\tprivate _removeOutstandingRequest(req: CancelablePromise<any>): void {\n\t\tfor (let i = 0, len = this._outstandingRequests.length; i < len; i++) {\n\t\t\tif (this._outstandingRequests[i] === req) {\n\t\t\t\tthis._outstandingRequests.splice(i, 1);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _tokenizeViewportNow(): void {\n\t\tif (!this._editor.hasModel()) {\n\t\t\treturn;\n\t\t}\n\t\tconst model = this._editor.getModel();\n\t\tif (model.tokenization.hasCompleteSemanticTokens()) {\n\t\t\treturn;\n\t\t}\n\t\tif (!isSemanticColoringEnabled(model, this._themeService, this._configurationService)) {\n\t\t\tif (model.tokenization.hasSomeSemanticTokens()) {\n\t\t\t\tmodel.tokenization.setSemanticTokens(null, false);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tif (!hasDocumentRangeSemanticTokensProvider(this._provider, model)) {\n\t\t\tif (model.tokenization.hasSomeSemanticTokens()) {\n\t\t\t\tmodel.tokenization.setSemanticTokens(null, false);\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t\tconst visibleRanges = this._editor.getVisibleRangesPlusViewportAboveBelow();\n\n\t\tthis._outstandingRequests = this._outstandingRequests.concat(visibleRanges.map(range => this._requestRange(model, range)));\n\t}\n\n\tprivate _requestRange(model: ITextModel, range: Range): CancelablePromise<any> {\n\t\tconst requestVersionId = model.getVersionId();\n\t\tconst request = createCancelablePromise(token => Promise.resolve(getDocumentRangeSemanticTokens(this._provider, model, range, token)));\n\t\tconst sw = new StopWatch(false);\n\t\trequest.then((r) => {\n\t\t\tthis._debounceInformation.update(model, sw.elapsed());\n\t\t\tif (!r || !r.tokens || model.isDisposed() || model.getVersionId() !== requestVersionId) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst { provider, tokens: result } = r;\n\t\t\tconst styling = this._semanticTokensStylingService.getStyling(provider);\n\t\t\tmodel.tokenization.setPartialSemanticTokens(range, toMultilineTokens2(result, styling, model.getLanguageId()));\n\t\t}).then(() => this._removeOutstandingRequest(request), () => this._removeOutstandingRequest(request));\n\t\treturn request;\n\t}\n}\n\nregisterEditorContribution(ViewportSemanticTokensContribution.ID, ViewportSemanticTokensContribution, EditorContributionInstantiation.AfterFirstRender);\n"]}