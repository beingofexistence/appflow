{"version":3,"sources":["vs/editor/contrib/cursorUndo/browser/cursorUndo.ts"],"names":[],"mappings":"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","file":"cursorUndo.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { KeyCode, KeyMod } from 'vs/base/common/keyCodes';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { ICodeEditor } from 'vs/editor/browser/editorBrowser';\nimport { EditorAction, EditorContributionInstantiation, registerEditorAction, registerEditorContribution, ServicesAccessor } from 'vs/editor/browser/editorExtensions';\nimport { Selection } from 'vs/editor/common/core/selection';\nimport { IEditorContribution } from 'vs/editor/common/editorCommon';\nimport { EditorContextKeys } from 'vs/editor/common/editorContextKeys';\nimport * as nls from 'vs/nls';\nimport { KeybindingWeight } from 'vs/platform/keybinding/common/keybindingsRegistry';\n\nclass CursorState {\n\treadonly selections: readonly Selection[];\n\n\tconstructor(selections: readonly Selection[]) {\n\t\tthis.selections = selections;\n\t}\n\n\tpublic equals(other: CursorState): boolean {\n\t\tconst thisLen = this.selections.length;\n\t\tconst otherLen = other.selections.length;\n\t\tif (thisLen !== otherLen) {\n\t\t\treturn false;\n\t\t}\n\t\tfor (let i = 0; i < thisLen; i++) {\n\t\t\tif (!this.selections[i].equalsSelection(other.selections[i])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n}\n\nclass StackElement {\n\tconstructor(\n\t\tpublic readonly cursorState: CursorState,\n\t\tpublic readonly scrollTop: number,\n\t\tpublic readonly scrollLeft: number\n\t) { }\n}\n\nexport class CursorUndoRedoController extends Disposable implements IEditorContribution {\n\n\tpublic static readonly ID = 'editor.contrib.cursorUndoRedoController';\n\n\tpublic static get(editor: ICodeEditor): CursorUndoRedoController | null {\n\t\treturn editor.getContribution<CursorUndoRedoController>(CursorUndoRedoController.ID);\n\t}\n\n\tprivate readonly _editor: ICodeEditor;\n\tprivate _isCursorUndoRedo: boolean;\n\n\tprivate _undoStack: StackElement[];\n\tprivate _redoStack: StackElement[];\n\n\tconstructor(editor: ICodeEditor) {\n\t\tsuper();\n\t\tthis._editor = editor;\n\t\tthis._isCursorUndoRedo = false;\n\n\t\tthis._undoStack = [];\n\t\tthis._redoStack = [];\n\n\t\tthis._register(editor.onDidChangeModel((e) => {\n\t\t\tthis._undoStack = [];\n\t\t\tthis._redoStack = [];\n\t\t}));\n\t\tthis._register(editor.onDidChangeModelContent((e) => {\n\t\t\tthis._undoStack = [];\n\t\t\tthis._redoStack = [];\n\t\t}));\n\t\tthis._register(editor.onDidChangeCursorSelection((e) => {\n\t\t\tif (this._isCursorUndoRedo) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (!e.oldSelections) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (e.oldModelVersionId !== e.modelVersionId) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst prevState = new CursorState(e.oldSelections);\n\t\t\tconst isEqualToLastUndoStack = (this._undoStack.length > 0 && this._undoStack[this._undoStack.length - 1].cursorState.equals(prevState));\n\t\t\tif (!isEqualToLastUndoStack) {\n\t\t\t\tthis._undoStack.push(new StackElement(prevState, editor.getScrollTop(), editor.getScrollLeft()));\n\t\t\t\tthis._redoStack = [];\n\t\t\t\tif (this._undoStack.length > 50) {\n\t\t\t\t\t// keep the cursor undo stack bounded\n\t\t\t\t\tthis._undoStack.shift();\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tpublic cursorUndo(): void {\n\t\tif (!this._editor.hasModel() || this._undoStack.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._redoStack.push(new StackElement(new CursorState(this._editor.getSelections()), this._editor.getScrollTop(), this._editor.getScrollLeft()));\n\t\tthis._applyState(this._undoStack.pop()!);\n\t}\n\n\tpublic cursorRedo(): void {\n\t\tif (!this._editor.hasModel() || this._redoStack.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._undoStack.push(new StackElement(new CursorState(this._editor.getSelections()), this._editor.getScrollTop(), this._editor.getScrollLeft()));\n\t\tthis._applyState(this._redoStack.pop()!);\n\t}\n\n\tprivate _applyState(stackElement: StackElement): void {\n\t\tthis._isCursorUndoRedo = true;\n\t\tthis._editor.setSelections(stackElement.cursorState.selections);\n\t\tthis._editor.setScrollPosition({\n\t\t\tscrollTop: stackElement.scrollTop,\n\t\t\tscrollLeft: stackElement.scrollLeft\n\t\t});\n\t\tthis._isCursorUndoRedo = false;\n\t}\n}\n\nexport class CursorUndo extends EditorAction {\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: 'cursorUndo',\n\t\t\tlabel: nls.localize('cursor.undo', \"Cursor Undo\"),\n\t\t\talias: 'Cursor Undo',\n\t\t\tprecondition: undefined,\n\t\t\tkbOpts: {\n\t\t\t\tkbExpr: EditorContextKeys.textInputFocus,\n\t\t\t\tprimary: KeyMod.CtrlCmd | KeyCode.KeyU,\n\t\t\t\tweight: KeybindingWeight.EditorContrib\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic run(accessor: ServicesAccessor, editor: ICodeEditor, args: any): void {\n\t\tCursorUndoRedoController.get(editor)?.cursorUndo();\n\t}\n}\n\nexport class CursorRedo extends EditorAction {\n\tconstructor() {\n\t\tsuper({\n\t\t\tid: 'cursorRedo',\n\t\t\tlabel: nls.localize('cursor.redo', \"Cursor Redo\"),\n\t\t\talias: 'Cursor Redo',\n\t\t\tprecondition: undefined\n\t\t});\n\t}\n\n\tpublic run(accessor: ServicesAccessor, editor: ICodeEditor, args: any): void {\n\t\tCursorUndoRedoController.get(editor)?.cursorRedo();\n\t}\n}\n\nregisterEditorContribution(CursorUndoRedoController.ID, CursorUndoRedoController, EditorContributionInstantiation.Eager); // eager because it needs to listen to record cursor state ASAP\nregisterEditorAction(CursorUndo);\nregisterEditorAction(CursorRedo);\n"]}