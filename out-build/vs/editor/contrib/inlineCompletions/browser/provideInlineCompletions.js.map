{"version":3,"sources":["file:///workspace/appflow/src/vs/editor/contrib/inlineCompletions/browser/provideInlineCompletions.ts"],"names":[],"mappings":"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","file":"provideInlineCompletions.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { assertNever } from 'vs/base/common/assert';\nimport { DeferredPromise } from 'vs/base/common/async';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { SetMap } from 'vs/base/common/collections';\nimport { onUnexpectedExternalError } from 'vs/base/common/errors';\nimport { IDisposable } from 'vs/base/common/lifecycle';\nimport { ISingleEditOperation } from 'vs/editor/common/core/editOperation';\nimport { Position } from 'vs/editor/common/core/position';\nimport { Range } from 'vs/editor/common/core/range';\nimport { LanguageFeatureRegistry } from 'vs/editor/common/languageFeatureRegistry';\nimport { Command, InlineCompletion, InlineCompletionContext, InlineCompletionProviderGroupId, InlineCompletions, InlineCompletionsProvider } from 'vs/editor/common/languages';\nimport { ILanguageConfigurationService } from 'vs/editor/common/languages/languageConfigurationRegistry';\nimport { ITextModel } from 'vs/editor/common/model';\nimport { fixBracketsInLine } from 'vs/editor/common/model/bracketPairsTextModelPart/fixBrackets';\nimport { SingleTextEdit } from 'vs/editor/contrib/inlineCompletions/browser/singleTextEdit';\nimport { getReadonlyEmptyArray } from 'vs/editor/contrib/inlineCompletions/browser/utils';\nimport { SnippetParser, Text } from 'vs/editor/contrib/snippet/browser/snippetParser';\n\nexport async function provideInlineCompletions(\n\tregistry: LanguageFeatureRegistry<InlineCompletionsProvider>,\n\tposition: Position,\n\tmodel: ITextModel,\n\tcontext: InlineCompletionContext,\n\ttoken: CancellationToken = CancellationToken.None,\n\tlanguageConfigurationService?: ILanguageConfigurationService,\n): Promise<InlineCompletionProviderResult> {\n\t// Important: Don't use position after the await calls, as the model could have been changed in the meantime!\n\tconst defaultReplaceRange = getDefaultRange(position, model);\n\tconst providers = registry.all(model);\n\n\tconst multiMap = new SetMap<InlineCompletionProviderGroupId, InlineCompletionsProvider<any>>();\n\tfor (const provider of providers) {\n\t\tif (provider.groupId) {\n\t\t\tmultiMap.add(provider.groupId, provider);\n\t\t}\n\t}\n\n\tfunction getPreferredProviders(provider: InlineCompletionsProvider<any>): InlineCompletionsProvider<any>[] {\n\t\tif (!provider.yieldsToGroupIds) { return []; }\n\t\tconst result: InlineCompletionsProvider<any>[] = [];\n\t\tfor (const groupId of provider.yieldsToGroupIds || []) {\n\t\t\tconst providers = multiMap.get(groupId);\n\t\t\tfor (const p of providers) {\n\t\t\t\tresult.push(p);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\ttype Result = Promise<InlineCompletions<InlineCompletion> | null | undefined>;\n\tconst states = new Map<InlineCompletionsProvider<InlineCompletions<InlineCompletion>>, Result>();\n\n\tconst seen = new Set<InlineCompletionsProvider<InlineCompletions<InlineCompletion>>>();\n\tfunction findPreferredProviderCircle(provider: InlineCompletionsProvider<any>, stack: InlineCompletionsProvider[]): InlineCompletionsProvider[] | undefined {\n\t\tstack = [...stack, provider];\n\t\tif (seen.has(provider)) { return stack; }\n\n\t\tseen.add(provider);\n\t\ttry {\n\t\t\tconst preferred = getPreferredProviders(provider);\n\t\t\tfor (const p of preferred) {\n\t\t\t\tconst c = findPreferredProviderCircle(p, stack);\n\t\t\t\tif (c) { return c; }\n\t\t\t}\n\t\t} finally {\n\t\t\tseen.delete(provider);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tfunction processProvider(provider: InlineCompletionsProvider<any>): Result {\n\t\tconst state = states.get(provider);\n\t\tif (state) {\n\t\t\treturn state;\n\t\t}\n\n\t\tconst circle = findPreferredProviderCircle(provider, []);\n\t\tif (circle) {\n\t\t\tonUnexpectedExternalError(new Error(`Inline completions: cyclic yield-to dependency detected. Path: ${circle.map(s => s.toString ? s.toString() : ('' + s)).join(' -> ')}`));\n\t\t}\n\n\t\tconst deferredPromise = new DeferredPromise<InlineCompletions<InlineCompletion> | null | undefined>();\n\t\tstates.set(provider, deferredPromise.p);\n\n\t\t(async () => {\n\t\t\tif (!circle) {\n\t\t\t\tconst preferred = getPreferredProviders(provider);\n\t\t\t\tfor (const p of preferred) {\n\t\t\t\t\tconst result = await processProvider(p);\n\t\t\t\t\tif (result && result.items.length > 0) {\n\t\t\t\t\t\t// Skip provider\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tconst completions = await provider.provideInlineCompletions(model, position, context, token);\n\t\t\t\treturn completions;\n\t\t\t} catch (e) {\n\t\t\t\tonUnexpectedExternalError(e);\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t})().then(c => deferredPromise.complete(c), e => deferredPromise.error(e));\n\n\t\treturn deferredPromise.p;\n\t}\n\n\tconst providerResults = await Promise.all(providers.map(async provider => ({ provider, completions: await processProvider(provider) })));\n\n\tconst itemsByHash = new Map<string, InlineCompletionItem>();\n\tconst lists: InlineCompletionList[] = [];\n\tfor (const result of providerResults) {\n\t\tconst completions = result.completions;\n\t\tif (!completions) {\n\t\t\tcontinue;\n\t\t}\n\t\tconst list = new InlineCompletionList(completions, result.provider);\n\t\tlists.push(list);\n\n\t\tfor (const item of completions.items) {\n\t\t\tconst inlineCompletionItem = InlineCompletionItem.from(\n\t\t\t\titem,\n\t\t\t\tlist,\n\t\t\t\tdefaultReplaceRange,\n\t\t\t\tmodel,\n\t\t\t\tlanguageConfigurationService\n\t\t\t);\n\t\t\titemsByHash.set(inlineCompletionItem.hash(), inlineCompletionItem);\n\t\t}\n\t}\n\n\treturn new InlineCompletionProviderResult(Array.from(itemsByHash.values()), new Set(itemsByHash.keys()), lists);\n}\n\nexport class InlineCompletionProviderResult implements IDisposable {\n\n\tconstructor(\n\t\t/**\n\t\t * Free of duplicates.\n\t\t */\n\t\tpublic readonly completions: readonly InlineCompletionItem[],\n\t\tprivate readonly hashs: Set<string>,\n\t\tprivate readonly providerResults: readonly InlineCompletionList[],\n\t) { }\n\n\tpublic has(item: InlineCompletionItem): boolean {\n\t\treturn this.hashs.has(item.hash());\n\t}\n\n\tdispose(): void {\n\t\tfor (const result of this.providerResults) {\n\t\t\tresult.removeRef();\n\t\t}\n\t}\n}\n\n/**\n * A ref counted pointer to the computed `InlineCompletions` and the `InlineCompletionsProvider` that\n * computed them.\n */\nexport class InlineCompletionList {\n\tprivate refCount = 1;\n\tconstructor(\n\t\tpublic readonly inlineCompletions: InlineCompletions,\n\t\tpublic readonly provider: InlineCompletionsProvider,\n\t) { }\n\n\taddRef(): void {\n\t\tthis.refCount++;\n\t}\n\n\tremoveRef(): void {\n\t\tthis.refCount--;\n\t\tif (this.refCount === 0) {\n\t\t\tthis.provider.freeInlineCompletions(this.inlineCompletions);\n\t\t}\n\t}\n}\n\nexport class InlineCompletionItem {\n\tpublic static from(\n\t\tinlineCompletion: InlineCompletion,\n\t\tsource: InlineCompletionList,\n\t\tdefaultReplaceRange: Range,\n\t\ttextModel: ITextModel,\n\t\tlanguageConfigurationService: ILanguageConfigurationService | undefined,\n\t) {\n\t\tlet insertText: string;\n\t\tlet snippetInfo: SnippetInfo | undefined;\n\t\tlet range = inlineCompletion.range ? Range.lift(inlineCompletion.range) : defaultReplaceRange;\n\n\t\tif (typeof inlineCompletion.insertText === 'string') {\n\t\t\tinsertText = inlineCompletion.insertText;\n\n\t\t\tif (languageConfigurationService && inlineCompletion.completeBracketPairs) {\n\t\t\t\tinsertText = closeBrackets(\n\t\t\t\t\tinsertText,\n\t\t\t\t\trange.getStartPosition(),\n\t\t\t\t\ttextModel,\n\t\t\t\t\tlanguageConfigurationService\n\t\t\t\t);\n\n\t\t\t\t// Modify range depending on if brackets are added or removed\n\t\t\t\tconst diff = insertText.length - inlineCompletion.insertText.length;\n\t\t\t\tif (diff !== 0) {\n\t\t\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + diff);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tsnippetInfo = undefined;\n\t\t} else if ('snippet' in inlineCompletion.insertText) {\n\t\t\tconst preBracketCompletionLength = inlineCompletion.insertText.snippet.length;\n\n\t\t\tif (languageConfigurationService && inlineCompletion.completeBracketPairs) {\n\t\t\t\tinlineCompletion.insertText.snippet = closeBrackets(\n\t\t\t\t\tinlineCompletion.insertText.snippet,\n\t\t\t\t\trange.getStartPosition(),\n\t\t\t\t\ttextModel,\n\t\t\t\t\tlanguageConfigurationService\n\t\t\t\t);\n\n\t\t\t\t// Modify range depending on if brackets are added or removed\n\t\t\t\tconst diff = inlineCompletion.insertText.snippet.length - preBracketCompletionLength;\n\t\t\t\tif (diff !== 0) {\n\t\t\t\t\trange = new Range(range.startLineNumber, range.startColumn, range.endLineNumber, range.endColumn + diff);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst snippet = new SnippetParser().parse(inlineCompletion.insertText.snippet);\n\n\t\t\tif (snippet.children.length === 1 && snippet.children[0] instanceof Text) {\n\t\t\t\tinsertText = snippet.children[0].value;\n\t\t\t\tsnippetInfo = undefined;\n\t\t\t} else {\n\t\t\t\tinsertText = snippet.toString();\n\t\t\t\tsnippetInfo = {\n\t\t\t\t\tsnippet: inlineCompletion.insertText.snippet,\n\t\t\t\t\trange: range\n\t\t\t\t};\n\t\t\t}\n\t\t} else {\n\t\t\tassertNever(inlineCompletion.insertText);\n\t\t}\n\n\t\treturn new InlineCompletionItem(\n\t\t\tinsertText,\n\t\t\tinlineCompletion.command,\n\t\t\trange,\n\t\t\tinsertText,\n\t\t\tsnippetInfo,\n\t\t\tinlineCompletion.additionalTextEdits || getReadonlyEmptyArray(),\n\t\t\tinlineCompletion,\n\t\t\tsource,\n\t\t);\n\t}\n\n\tconstructor(\n\t\treadonly filterText: string,\n\t\treadonly command: Command | undefined,\n\t\treadonly range: Range,\n\t\treadonly insertText: string,\n\t\treadonly snippetInfo: SnippetInfo | undefined,\n\n\t\treadonly additionalTextEdits: readonly ISingleEditOperation[],\n\n\n\t\t/**\n\t\t * A reference to the original inline completion this inline completion has been constructed from.\n\t\t * Used for event data to ensure referential equality.\n\t\t*/\n\t\treadonly sourceInlineCompletion: InlineCompletion,\n\n\t\t/**\n\t\t * A reference to the original inline completion list this inline completion has been constructed from.\n\t\t * Used for event data to ensure referential equality.\n\t\t*/\n\t\treadonly source: InlineCompletionList,\n\t) {\n\t\tfilterText = filterText.replace(/\\r\\n|\\r/g, '\\n');\n\t\tinsertText = filterText.replace(/\\r\\n|\\r/g, '\\n');\n\t}\n\n\tpublic withRange(updatedRange: Range): InlineCompletionItem {\n\t\treturn new InlineCompletionItem(\n\t\t\tthis.filterText,\n\t\t\tthis.command,\n\t\t\tupdatedRange,\n\t\t\tthis.insertText,\n\t\t\tthis.snippetInfo,\n\t\t\tthis.additionalTextEdits,\n\t\t\tthis.sourceInlineCompletion,\n\t\t\tthis.source,\n\t\t);\n\t}\n\n\tpublic hash(): string {\n\t\treturn JSON.stringify({ insertText: this.insertText, range: this.range.toString() });\n\t}\n\n\tpublic toSingleTextEdit(): SingleTextEdit {\n\t\treturn new SingleTextEdit(this.range, this.insertText);\n\t}\n}\n\nexport interface SnippetInfo {\n\tsnippet: string;\n\t/* Could be different than the main range */\n\trange: Range;\n}\n\nfunction getDefaultRange(position: Position, model: ITextModel): Range {\n\tconst word = model.getWordAtPosition(position);\n\tconst maxColumn = model.getLineMaxColumn(position.lineNumber);\n\t// By default, always replace up until the end of the current line.\n\t// This default might be subject to change!\n\treturn word\n\t\t? new Range(position.lineNumber, word.startColumn, position.lineNumber, maxColumn)\n\t\t: Range.fromPositions(position, position.with(undefined, maxColumn));\n}\n\nfunction closeBrackets(text: string, position: Position, model: ITextModel, languageConfigurationService: ILanguageConfigurationService): string {\n\tconst lineStart = model.getLineContent(position.lineNumber).substring(0, position.column - 1);\n\tconst newLine = lineStart + text;\n\n\tconst newTokens = model.tokenization.tokenizeLineWithEdit(position, newLine.length - (position.column - 1), text);\n\tconst slicedTokens = newTokens?.sliceAndInflate(position.column - 1, newLine.length, 0);\n\tif (!slicedTokens) {\n\t\treturn text;\n\t}\n\n\tconst newText = fixBracketsInLine(slicedTokens, languageConfigurationService);\n\n\treturn newText;\n}\n"]}