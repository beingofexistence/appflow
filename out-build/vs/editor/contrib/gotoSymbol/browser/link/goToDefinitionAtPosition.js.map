{"version":3,"sources":["vs/editor/contrib/gotoSymbol/browser/link/goToDefinitionAtPosition.ts"],"names":[],"mappings":"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","file":"goToDefinitionAtPosition.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IKeyboardEvent } from 'vs/base/browser/keyboardEvent';\nimport { CancelablePromise, createCancelablePromise } from 'vs/base/common/async';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { onUnexpectedError } from 'vs/base/common/errors';\nimport { MarkdownString } from 'vs/base/common/htmlContent';\nimport { DisposableStore } from 'vs/base/common/lifecycle';\nimport 'vs/css!./goToDefinitionAtPosition';\nimport { CodeEditorStateFlag, EditorState } from 'vs/editor/contrib/editorState/browser/editorState';\nimport { ICodeEditor, MouseTargetType } from 'vs/editor/browser/editorBrowser';\nimport { EditorContributionInstantiation, registerEditorContribution } from 'vs/editor/browser/editorExtensions';\nimport { EditorOption } from 'vs/editor/common/config/editorOptions';\nimport { Position } from 'vs/editor/common/core/position';\nimport { IRange, Range } from 'vs/editor/common/core/range';\nimport { IEditorContribution, IEditorDecorationsCollection } from 'vs/editor/common/editorCommon';\nimport { IModelDeltaDecoration, ITextModel } from 'vs/editor/common/model';\nimport { LocationLink } from 'vs/editor/common/languages';\nimport { ILanguageService } from 'vs/editor/common/languages/language';\nimport { ITextModelService } from 'vs/editor/common/services/resolverService';\nimport { ClickLinkGesture, ClickLinkKeyboardEvent, ClickLinkMouseEvent } from 'vs/editor/contrib/gotoSymbol/browser/link/clickLinkGesture';\nimport { PeekContext } from 'vs/editor/contrib/peekView/browser/peekView';\nimport * as nls from 'vs/nls';\nimport { IContextKeyService } from 'vs/platform/contextkey/common/contextkey';\nimport { ServicesAccessor } from 'vs/platform/instantiation/common/instantiation';\nimport { DefinitionAction } from '../goToCommands';\nimport { getDefinitionsAtPosition } from '../goToSymbol';\nimport { IWordAtPosition } from 'vs/editor/common/core/wordHelper';\nimport { ILanguageFeaturesService } from 'vs/editor/common/services/languageFeatures';\nimport { ModelDecorationInjectedTextOptions } from 'vs/editor/common/model/textModel';\n\nexport class GotoDefinitionAtPositionEditorContribution implements IEditorContribution {\n\n\tpublic static readonly ID = 'editor.contrib.gotodefinitionatposition';\n\tstatic readonly MAX_SOURCE_PREVIEW_LINES = 8;\n\n\tprivate readonly editor: ICodeEditor;\n\tprivate readonly toUnhook = new DisposableStore();\n\tprivate readonly toUnhookForKeyboard = new DisposableStore();\n\tprivate readonly linkDecorations: IEditorDecorationsCollection;\n\tprivate currentWordAtPosition: IWordAtPosition | null = null;\n\tprivate previousPromise: CancelablePromise<LocationLink[] | null> | null = null;\n\n\tconstructor(\n\t\teditor: ICodeEditor,\n\t\t@ITextModelService private readonly textModelResolverService: ITextModelService,\n\t\t@ILanguageService private readonly languageService: ILanguageService,\n\t\t@ILanguageFeaturesService private readonly languageFeaturesService: ILanguageFeaturesService,\n\t) {\n\t\tthis.editor = editor;\n\t\tthis.linkDecorations = this.editor.createDecorationsCollection();\n\n\t\tconst linkGesture = new ClickLinkGesture(editor);\n\t\tthis.toUnhook.add(linkGesture);\n\n\t\tthis.toUnhook.add(linkGesture.onMouseMoveOrRelevantKeyDown(([mouseEvent, keyboardEvent]) => {\n\t\t\tthis.startFindDefinitionFromMouse(mouseEvent, keyboardEvent ?? undefined);\n\t\t}));\n\n\t\tthis.toUnhook.add(linkGesture.onExecute((mouseEvent: ClickLinkMouseEvent) => {\n\t\t\tif (this.isEnabled(mouseEvent)) {\n\t\t\t\tthis.gotoDefinition(mouseEvent.target.position!, mouseEvent.hasSideBySideModifier)\n\t\t\t\t\t.catch((error: Error) => {\n\t\t\t\t\t\tonUnexpectedError(error);\n\t\t\t\t\t})\n\t\t\t\t\t.finally(() => {\n\t\t\t\t\t\tthis.removeLinkDecorations();\n\t\t\t\t\t});\n\t\t\t}\n\t\t}));\n\n\t\tthis.toUnhook.add(linkGesture.onCancel(() => {\n\t\t\tthis.removeLinkDecorations();\n\t\t\tthis.currentWordAtPosition = null;\n\t\t}));\n\t}\n\n\tstatic get(editor: ICodeEditor): GotoDefinitionAtPositionEditorContribution | null {\n\t\treturn editor.getContribution<GotoDefinitionAtPositionEditorContribution>(GotoDefinitionAtPositionEditorContribution.ID);\n\t}\n\n\tasync startFindDefinitionFromCursor(position: Position) {\n\t\t// For issue: https://github.com/microsoft/vscode/issues/46257\n\t\t// equivalent to mouse move with meta/ctrl key\n\n\t\t// First find the definition and add decorations\n\t\t// to the editor to be shown with the content hover widget\n\t\tawait this.startFindDefinition(position);\n\t\t// Add listeners for editor cursor move and key down events\n\t\t// Dismiss the \"extended\" editor decorations when the user hides\n\t\t// the hover widget. There is no event for the widget itself so these\n\t\t// serve as a best effort. After removing the link decorations, the hover\n\t\t// widget is clean and will only show declarations per next request.\n\t\tthis.toUnhookForKeyboard.add(this.editor.onDidChangeCursorPosition(() => {\n\t\t\tthis.currentWordAtPosition = null;\n\t\t\tthis.removeLinkDecorations();\n\t\t\tthis.toUnhookForKeyboard.clear();\n\t\t}));\n\t\tthis.toUnhookForKeyboard.add(this.editor.onKeyDown((e: IKeyboardEvent) => {\n\t\t\tif (e) {\n\t\t\t\tthis.currentWordAtPosition = null;\n\t\t\t\tthis.removeLinkDecorations();\n\t\t\t\tthis.toUnhookForKeyboard.clear();\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate startFindDefinitionFromMouse(mouseEvent: ClickLinkMouseEvent, withKey?: ClickLinkKeyboardEvent): void {\n\n\t\t// check if we are active and on a content widget\n\t\tif (mouseEvent.target.type === MouseTargetType.CONTENT_WIDGET && this.linkDecorations.length > 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.editor.hasModel() || !this.isEnabled(mouseEvent, withKey)) {\n\t\t\tthis.currentWordAtPosition = null;\n\t\t\tthis.removeLinkDecorations();\n\t\t\treturn;\n\t\t}\n\n\t\tconst position = mouseEvent.target.position!;\n\n\t\tthis.startFindDefinition(position);\n\t}\n\n\tprivate async startFindDefinition(position: Position): Promise<void> {\n\n\t\t// Dispose listeners for updating decorations when using keyboard to show definition hover\n\t\tthis.toUnhookForKeyboard.clear();\n\n\t\t// Find word at mouse position\n\t\tconst word = position ? this.editor.getModel()?.getWordAtPosition(position) : null;\n\t\tif (!word) {\n\t\t\tthis.currentWordAtPosition = null;\n\t\t\tthis.removeLinkDecorations();\n\t\t\treturn;\n\t\t}\n\n\t\t// Return early if word at position is still the same\n\t\tif (this.currentWordAtPosition && this.currentWordAtPosition.startColumn === word.startColumn && this.currentWordAtPosition.endColumn === word.endColumn && this.currentWordAtPosition.word === word.word) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.currentWordAtPosition = word;\n\n\t\t// Find definition and decorate word if found\n\t\tconst state = new EditorState(this.editor, CodeEditorStateFlag.Position | CodeEditorStateFlag.Value | CodeEditorStateFlag.Selection | CodeEditorStateFlag.Scroll);\n\n\t\tif (this.previousPromise) {\n\t\t\tthis.previousPromise.cancel();\n\t\t\tthis.previousPromise = null;\n\t\t}\n\n\t\tthis.previousPromise = createCancelablePromise(token => this.findDefinition(position, token));\n\n\t\tlet results: LocationLink[] | null;\n\t\ttry {\n\t\t\tresults = await this.previousPromise;\n\n\t\t} catch (error) {\n\t\t\tonUnexpectedError(error);\n\t\t\treturn;\n\t\t}\n\n\t\tif (!results || !results.length || !state.validate(this.editor)) {\n\t\t\tthis.removeLinkDecorations();\n\t\t\treturn;\n\t\t}\n\n\t\tconst linkRange = results[0].originSelectionRange\n\t\t\t? Range.lift(results[0].originSelectionRange)\n\t\t\t: new Range(position.lineNumber, word.startColumn, position.lineNumber, word.endColumn);\n\n\t\t// Multiple results\n\t\tif (results.length > 1) {\n\n\t\t\tlet combinedRange = linkRange;\n\t\t\tfor (const { originSelectionRange } of results) {\n\t\t\t\tif (originSelectionRange) {\n\t\t\t\t\tcombinedRange = Range.plusRange(combinedRange, originSelectionRange);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.addDecoration(\n\t\t\t\tcombinedRange,\n\t\t\t\tnew MarkdownString().appendText(nls.localize('multipleResults', \"Click to show {0} definitions.\", results.length))\n\t\t\t);\n\t\t} else {\n\t\t\t// Single result\n\t\t\tconst result = results[0];\n\n\t\t\tif (!result.uri) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.textModelResolverService.createModelReference(result.uri).then(ref => {\n\n\t\t\t\tif (!ref.object || !ref.object.textEditorModel) {\n\t\t\t\t\tref.dispose();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst { object: { textEditorModel } } = ref;\n\t\t\t\tconst { startLineNumber } = result.range;\n\n\t\t\t\tif (startLineNumber < 1 || startLineNumber > textEditorModel.getLineCount()) {\n\t\t\t\t\t// invalid range\n\t\t\t\t\tref.dispose();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst previewValue = this.getPreviewValue(textEditorModel, startLineNumber, result);\n\t\t\t\tconst languageId = this.languageService.guessLanguageIdByFilepathOrFirstLine(textEditorModel.uri);\n\t\t\t\tthis.addDecoration(\n\t\t\t\t\tlinkRange,\n\t\t\t\t\tpreviewValue ? new MarkdownString().appendCodeblock(languageId ? languageId : '', previewValue) : undefined\n\t\t\t\t);\n\t\t\t\tref.dispose();\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate getPreviewValue(textEditorModel: ITextModel, startLineNumber: number, result: LocationLink) {\n\t\tlet rangeToUse = result.range;\n\t\tconst numberOfLinesInRange = rangeToUse.endLineNumber - rangeToUse.startLineNumber;\n\t\tif (numberOfLinesInRange >= GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES) {\n\t\t\trangeToUse = this.getPreviewRangeBasedOnIndentation(textEditorModel, startLineNumber);\n\t\t}\n\n\t\tconst previewValue = this.stripIndentationFromPreviewRange(textEditorModel, startLineNumber, rangeToUse);\n\t\treturn previewValue;\n\t}\n\n\tprivate stripIndentationFromPreviewRange(textEditorModel: ITextModel, startLineNumber: number, previewRange: IRange) {\n\t\tconst startIndent = textEditorModel.getLineFirstNonWhitespaceColumn(startLineNumber);\n\t\tlet minIndent = startIndent;\n\n\t\tfor (let endLineNumber = startLineNumber + 1; endLineNumber < previewRange.endLineNumber; endLineNumber++) {\n\t\t\tconst endIndent = textEditorModel.getLineFirstNonWhitespaceColumn(endLineNumber);\n\t\t\tminIndent = Math.min(minIndent, endIndent);\n\t\t}\n\n\t\tconst previewValue = textEditorModel.getValueInRange(previewRange).replace(new RegExp(`^\\\\s{${minIndent - 1}}`, 'gm'), '').trim();\n\t\treturn previewValue;\n\t}\n\n\tprivate getPreviewRangeBasedOnIndentation(textEditorModel: ITextModel, startLineNumber: number) {\n\t\tconst startIndent = textEditorModel.getLineFirstNonWhitespaceColumn(startLineNumber);\n\t\tconst maxLineNumber = Math.min(textEditorModel.getLineCount(), startLineNumber + GotoDefinitionAtPositionEditorContribution.MAX_SOURCE_PREVIEW_LINES);\n\t\tlet endLineNumber = startLineNumber + 1;\n\n\t\tfor (; endLineNumber < maxLineNumber; endLineNumber++) {\n\t\t\tconst endIndent = textEditorModel.getLineFirstNonWhitespaceColumn(endLineNumber);\n\n\t\t\tif (startIndent === endIndent) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn new Range(startLineNumber, 1, endLineNumber + 1, 1);\n\t}\n\n\tprivate addDecoration(range: Range, hoverMessage: MarkdownString | undefined): void {\n\n\t\tconst newDecorations: IModelDeltaDecoration = {\n\t\t\trange: range,\n\t\t\toptions: {\n\t\t\t\tdescription: 'goto-definition-link',\n\t\t\t\tinlineClassName: 'goto-definition-link',\n\t\t\t\thoverMessage\n\t\t\t}\n\t\t};\n\n\t\tthis.linkDecorations.set([newDecorations]);\n\t}\n\n\tprivate removeLinkDecorations(): void {\n\t\tthis.linkDecorations.clear();\n\t}\n\n\tprivate isEnabled(mouseEvent: ClickLinkMouseEvent, withKey?: ClickLinkKeyboardEvent): boolean {\n\t\treturn this.editor.hasModel()\n\t\t\t&& mouseEvent.isLeftClick\n\t\t\t&& mouseEvent.isNoneOrSingleMouseDown\n\t\t\t&& mouseEvent.target.type === MouseTargetType.CONTENT_TEXT\n\t\t\t&& !(mouseEvent.target.detail.injectedText?.options instanceof ModelDecorationInjectedTextOptions)\n\t\t\t&& (mouseEvent.hasTriggerModifier || (withKey ? withKey.keyCodeIsTriggerKey : false))\n\t\t\t&& this.languageFeaturesService.definitionProvider.has(this.editor.getModel());\n\t}\n\n\tprivate findDefinition(position: Position, token: CancellationToken): Promise<LocationLink[] | null> {\n\t\tconst model = this.editor.getModel();\n\t\tif (!model) {\n\t\t\treturn Promise.resolve(null);\n\t\t}\n\n\t\treturn getDefinitionsAtPosition(this.languageFeaturesService.definitionProvider, model, position, token);\n\t}\n\n\tprivate gotoDefinition(position: Position, openToSide: boolean): Promise<any> {\n\t\tthis.editor.setPosition(position);\n\t\treturn this.editor.invokeWithinContext((accessor) => {\n\t\t\tconst canPeek = !openToSide && this.editor.getOption(EditorOption.definitionLinkOpensInPeek) && !this.isInPeekEditor(accessor);\n\t\t\tconst action = new DefinitionAction({ openToSide, openInPeek: canPeek, muteMessage: true }, { title: { value: '', original: '' }, id: '', precondition: undefined });\n\t\t\treturn action.run(accessor);\n\t\t});\n\t}\n\n\tprivate isInPeekEditor(accessor: ServicesAccessor): boolean | undefined {\n\t\tconst contextKeyService = accessor.get(IContextKeyService);\n\t\treturn PeekContext.inPeekEditor.getValue(contextKeyService);\n\t}\n\n\tpublic dispose(): void {\n\t\tthis.toUnhook.dispose();\n\t\tthis.toUnhookForKeyboard.dispose();\n\t}\n}\n\nregisterEditorContribution(GotoDefinitionAtPositionEditorContribution.ID, GotoDefinitionAtPositionEditorContribution, EditorContributionInstantiation.BeforeFirstInteraction);\n"]}