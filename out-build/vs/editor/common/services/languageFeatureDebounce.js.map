{"version":3,"sources":["file:///workspace/appflow/src/vs/editor/common/services/languageFeatureDebounce.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;;;;;IAcnF,QAAA,GAAG,GAA+B,IAAA,mBAAG,EAA8C,iCAAiC,CAAC,CAAC;IAenI,IAAU,YAAY,CAWrB;IAXD,WAAU,YAAY;QACrB,MAAM,OAAO,GAAG,IAAI,OAAO,EAAkB,CAAC;QAC9C,IAAI,IAAI,GAAG,CAAC,CAAC;QACb,SAAgB,EAAE,CAAC,GAAW;YAC7B,IAAI,KAAK,GAAG,OAAO,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;YAC7B,IAAI,KAAK,KAAK,SAAS,EAAE;gBACxB,KAAK,GAAG,EAAE,IAAI,CAAC;gBACf,OAAO,CAAC,GAAG,CAAC,GAAG,EAAE,KAAK,CAAC,CAAC;aACxB;YACD,OAAO,KAAK,CAAC;QACd,CAAC;QAPe,eAAE,KAOjB,CAAA;IACF,CAAC,EAXS,YAAY,KAAZ,YAAY,QAWrB;IAED,MAAM,uBAAuB;QAE5B,YAA6B,CAAgB;YAAhB,MAAC,GAAD,CAAC,CAAe;QAAI,CAAC;QAElD,GAAG,CAAC,MAAkB;YACrB,OAAO,IAAI,CAAC,CAAC,CAAQ;QACtB,CAAC;QACD,MAAM,CAAC,MAAkB,EAAE,MAAc;YACxC,OAAO,IAAI,CAAC,CAAC,CAAQ;QACtB,CAAC;QACD,OAAO;YACN,OAAO,IAAI,CAAC,CAAC,CAAQ;QACtB,CAAC;KACD;IAED,MAAM,0BAA0B;QAI/B,YACkB,CAAgB,EAChB,CAAa,EACb,CAA0C,EAC1C,CAAgB,EAChB,CAAY,EACZ,CAAY;YALZ,MAAC,GAAD,CAAC,CAAe;YAChB,MAAC,GAAD,CAAC,CAAY;YACb,MAAC,GAAD,CAAC,CAAyC;YAC1C,MAAC,GAAD,CAAC,CAAe;YAChB,MAAC,GAAD,CAAC,CAAW;YACZ,MAAC,GAAD,CAAC,CAAW;YARb,MAAC,GAAQ,IAAI,SAAG,CAAoC,EAAE,EAAE,GAAG,CAAC,CAAC;QAS1E,CAAC;QAEG,CAAC,CAAI,KAAiB;YAC7B,OAAO,KAAK,CAAC,EAAE,GAAG,IAAI,CAAC,CAAC,CAAS,GAAG,CAAC,KAAK,CAAC,CAAC,MAAM,CAAC,CAAC,OAAO,EAAE,GAAG,EAAE,EAAE,CAAC,IAAA,UAAG,EAAI,YAAY,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,OAAO,CAAC,EAAE,CAAC,CAAC,CAAC;QAChH,CAAC;QAED,GAAG,CAAC,KAAiB;YACpB,MAAM,GAAG,GAAG,IAAI,CAAC,CAAC,CAAI,KAAK,CAAC,CAAC;YAC7B,MAAM,GAAG,GAAG,IAAI,CAAC,CAAC,CAAM,GAAG,CAAC,GAAG,CAAC,CAAC;YACjC,OAAO,GAAG;gBACT,CAAC,CAAC,IAAA,aAAG,EAAG,GAAG,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC,EAAK,IAAI,CAAC,CAAC,CAAI;gBACxC,CAAC,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;QACnB,CAAC;QAED,MAAM,CAAC,KAAiB,EAAE,KAAa;YACtC,MAAM,GAAG,GAAG,IAAI,CAAC,CAAC,CAAI,KAAK,CAAC,CAAC;YAC7B,IAAI,GAAG,GAAG,IAAI,CAAC,CAAC,CAAM,GAAG,CAAC,GAAG,CAAC,CAAC;YAC/B,IAAI,CAAC,GAAG,EAAE;gBACT,GAAG,GAAG,IAAI,aAAG,CAAkB,CAAC,CAAC,CAAC;gBAClC,IAAI,CAAC,CAAC,CAAM,GAAG,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;aAC1B;YACD,MAAM,QAAQ,GAAG,IAAA,aAAG,EAAG,GAAG,CAAC,MAAM,CAAC,KAAK,CAAC,EAAE,IAAI,CAAC,CAAC,EAAK,IAAI,CAAC,CAAC,CAAI,CAAC;YAChE,IAAI,CAAC,IAAA,YAAG,EAAW,KAAK,CAAC,GAAG,EAAE,QAAQ,CAAC,EAAE;gBACxC,IAAI,CAAC,CAAC,CAAW,KAAK,CAAC,cAAc,IAAI,CAAC,CAAC,SAAa,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,OAAO,QAAQ,IAAI,CAAC,CAAC;aACjG;YACD,OAAO,QAAQ,CAAC;QACjB,CAAC;QAEO,CAAC;YACR,MAAM,MAAM,GAAG,IAAI,aAAG,EAAY,CAAC;YACnC,KAAK,MAAM,CAAC,EAAE,GAAG,CAAC,IAAI,IAAI,CAAC,CAAC,EAAO;gBAClC,MAAM,CAAC,MAAM,CAAC,GAAG,CAAC,KAAK,CAAC,CAAC;aACzB;YACD,OAAO,MAAM,CAAC,KAAK,CAAC;QACrB,CAAC;QAED,OAAO;YACN,MAAM,KAAK,GAAG,CAAC,IAAI,CAAC,CAAC,EAAS,GAAG,CAAC,CAAC,IAAI,IAAI,CAAC,CAAC,CAAQ;YACrD,OAAO,IAAA,aAAG,EAAG,KAAK,EAAE,IAAI,CAAC,CAAC,EAAK,IAAI,CAAC,CAAC,CAAI,CAAC;QAC3C,CAAC;KACD;IAGM,IAAM,GAAG,GAAT,MAAM,GAAG;QAOf,YACc,CAAiC,EACzB,UAAe;YADN,MAAC,GAAD,CAAC,CAAe;YAJ9B,MAAC,GAAO,IAAI,GAAG,EAAuC,CAAC;YAQvE,IAAI,CAAC,CAAC,GAAQ,UAAU,CAAC,sBAAsB,IAAI,CAAC,UAAU,CAAC,OAAO,CAAC;QACxE,CAAC;QAED,GAAG,CAAC,OAAwC,EAAE,IAAY,EAAE,MAAqD;YAChH,MAAM,GAAG,GAAG,MAAM,EAAE,GAAG,IAAI,EAAE,CAAC;YAC9B,MAAM,GAAG,GAAG,MAAM,EAAE,GAAG,IAAI,GAAG,IAAI,CAAC,CAAC;YACpC,MAAM,KAAK,GAAG,MAAM,EAAE,GAAG,IAAI,SAAS,CAAC;YACvC,MAAM,GAAG,GAAG,GAAG,YAAY,CAAC,EAAE,CAAC,OAAO,CAAC,IAAI,GAAG,GAAG,KAAK,CAAC,CAAC,CAAC,GAAG,GAAG,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC;YAC5E,IAAI,IAAI,GAAG,IAAI,CAAC,CAAC,CAAK,GAAG,CAAC,GAAG,CAAC,CAAC;YAC/B,IAAI,CAAC,IAAI,EAAE;gBACV,IAAI,CAAC,IAAI,CAAC,CAAC,EAAO;oBACjB,IAAI,CAAC,CAAC,CAAW,KAAK,CAAC,cAAc,IAAI,iCAAiC,CAAC,CAAC;oBAC5E,IAAI,GAAG,IAAI,uBAAuB,CAAC,GAAG,GAAG,GAAG,CAAC,CAAC;iBAC9C;qBAAM;oBACN,IAAI,GAAG,IAAI,0BAA0B,CACpC,IAAI,CAAC,CAAC,EACN,IAAI,EACJ,OAAO,EACP,CAAC,IAAI,CAAC,CAAC,EAAgB,GAAG,CAAC,CAAC,IAAI,CAAC,GAAG,GAAG,GAAG,CAAC,EAAE,uDAAuD;oBACpG,GAAG,EACH,GAAG,CACH,CAAC;iBACF;gBACD,IAAI,CAAC,CAAC,CAAK,GAAG,CAAC,GAAG,EAAE,IAAI,CAAC,CAAC;aAC1B;YACD,OAAO,IAAI,CAAC;QACb,CAAC;QAEO,CAAC;YACR,2EAA2E;YAC3E,MAAM,MAAM,GAAG,IAAI,aAAG,EAAY,CAAC;YACnC,KAAK,MAAM,IAAI,IAAI,IAAI,CAAC,CAAC,CAAK,MAAM,EAAE,EAAE;gBACvC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC,CAAC;aAC9B;YACD,OAAO,MAAM,CAAC,KAAK,CAAC;QACrB,CAAC;KACD,CAAA;IAhDY,kBAAG;kBAAH,GAAG;QAQb,WAAA,SAAG,CAAA;QACH,WAAA,iBAAG,CAAA;OATO,GAAG,CAgDf;IAED,IAAA,gBAAG,EAAe,WAAG,EAA8B,GAAG,oCAAuD,CAAC","file":"languageFeatureDebounce.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { doHash } from 'vs/base/common/hash';\nimport { LRUCache } from 'vs/base/common/map';\nimport { clamp, MovingAverage, SlidingWindowAverage } from 'vs/base/common/numbers';\nimport { LanguageFeatureRegistry } from 'vs/editor/common/languageFeatureRegistry';\nimport { ITextModel } from 'vs/editor/common/model';\nimport { IEnvironmentService } from 'vs/platform/environment/common/environment';\nimport { InstantiationType, registerSingleton } from 'vs/platform/instantiation/common/extensions';\nimport { createDecorator } from 'vs/platform/instantiation/common/instantiation';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { matchesScheme } from 'vs/platform/opener/common/opener';\n\n\nexport const ILanguageFeatureDebounceService = createDecorator<ILanguageFeatureDebounceService>('ILanguageFeatureDebounceService');\n\nexport interface ILanguageFeatureDebounceService {\n\n\treadonly _serviceBrand: undefined;\n\n\tfor(feature: LanguageFeatureRegistry<object>, debugName: string, config?: { min?: number; max?: number; salt?: string }): IFeatureDebounceInformation;\n}\n\nexport interface IFeatureDebounceInformation {\n\tget(model: ITextModel): number;\n\tupdate(model: ITextModel, value: number): number;\n\tdefault(): number;\n}\n\nnamespace IdentityHash {\n\tconst _hashes = new WeakMap<object, number>();\n\tlet pool = 0;\n\texport function of(obj: object): number {\n\t\tlet value = _hashes.get(obj);\n\t\tif (value === undefined) {\n\t\t\tvalue = ++pool;\n\t\t\t_hashes.set(obj, value);\n\t\t}\n\t\treturn value;\n\t}\n}\n\nclass NullDebounceInformation implements IFeatureDebounceInformation {\n\n\tconstructor(private readonly _default: number) { }\n\n\tget(_model: ITextModel): number {\n\t\treturn this._default;\n\t}\n\tupdate(_model: ITextModel, _value: number): number {\n\t\treturn this._default;\n\t}\n\tdefault(): number {\n\t\treturn this._default;\n\t}\n}\n\nclass FeatureDebounceInformation implements IFeatureDebounceInformation {\n\n\tprivate readonly _cache = new LRUCache<string, SlidingWindowAverage>(50, 0.7);\n\n\tconstructor(\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _name: string,\n\t\tprivate readonly _registry: LanguageFeatureRegistry<object>,\n\t\tprivate readonly _default: number,\n\t\tprivate readonly _min: number,\n\t\tprivate readonly _max: number,\n\t) { }\n\n\tprivate _key(model: ITextModel): string {\n\t\treturn model.id + this._registry.all(model).reduce((hashVal, obj) => doHash(IdentityHash.of(obj), hashVal), 0);\n\t}\n\n\tget(model: ITextModel): number {\n\t\tconst key = this._key(model);\n\t\tconst avg = this._cache.get(key);\n\t\treturn avg\n\t\t\t? clamp(avg.value, this._min, this._max)\n\t\t\t: this.default();\n\t}\n\n\tupdate(model: ITextModel, value: number): number {\n\t\tconst key = this._key(model);\n\t\tlet avg = this._cache.get(key);\n\t\tif (!avg) {\n\t\t\tavg = new SlidingWindowAverage(6);\n\t\t\tthis._cache.set(key, avg);\n\t\t}\n\t\tconst newValue = clamp(avg.update(value), this._min, this._max);\n\t\tif (!matchesScheme(model.uri, 'output')) {\n\t\t\tthis._logService.trace(`[DEBOUNCE: ${this._name}] for ${model.uri.toString()} is ${newValue}ms`);\n\t\t}\n\t\treturn newValue;\n\t}\n\n\tprivate _overall(): number {\n\t\tconst result = new MovingAverage();\n\t\tfor (const [, avg] of this._cache) {\n\t\t\tresult.update(avg.value);\n\t\t}\n\t\treturn result.value;\n\t}\n\n\tdefault() {\n\t\tconst value = (this._overall() | 0) || this._default;\n\t\treturn clamp(value, this._min, this._max);\n\t}\n}\n\n\nexport class LanguageFeatureDebounceService implements ILanguageFeatureDebounceService {\n\n\tdeclare _serviceBrand: undefined;\n\n\tprivate readonly _data = new Map<string, IFeatureDebounceInformation>();\n\tprivate readonly _isDev: boolean;\n\n\tconstructor(\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IEnvironmentService envService: IEnvironmentService,\n\t) {\n\n\t\tthis._isDev = envService.isExtensionDevelopment || !envService.isBuilt;\n\t}\n\n\tfor(feature: LanguageFeatureRegistry<object>, name: string, config?: { min?: number; max?: number; key?: string }): IFeatureDebounceInformation {\n\t\tconst min = config?.min ?? 50;\n\t\tconst max = config?.max ?? min ** 2;\n\t\tconst extra = config?.key ?? undefined;\n\t\tconst key = `${IdentityHash.of(feature)},${min}${extra ? ',' + extra : ''}`;\n\t\tlet info = this._data.get(key);\n\t\tif (!info) {\n\t\t\tif (!this._isDev) {\n\t\t\t\tthis._logService.debug(`[DEBOUNCE: ${name}] is disabled in developed mode`);\n\t\t\t\tinfo = new NullDebounceInformation(min * 1.5);\n\t\t\t} else {\n\t\t\t\tinfo = new FeatureDebounceInformation(\n\t\t\t\t\tthis._logService,\n\t\t\t\t\tname,\n\t\t\t\t\tfeature,\n\t\t\t\t\t(this._overallAverage() | 0) || (min * 1.5), // default is overall default or derived from min-value\n\t\t\t\t\tmin,\n\t\t\t\t\tmax\n\t\t\t\t);\n\t\t\t}\n\t\t\tthis._data.set(key, info);\n\t\t}\n\t\treturn info;\n\t}\n\n\tprivate _overallAverage(): number {\n\t\t// Average of all language features. Not a great value but an approximation\n\t\tconst result = new MovingAverage();\n\t\tfor (const info of this._data.values()) {\n\t\t\tresult.update(info.default());\n\t\t}\n\t\treturn result.value;\n\t}\n}\n\nregisterSingleton(ILanguageFeatureDebounceService, LanguageFeatureDebounceService, InstantiationType.Delayed);\n"]}