{"version":3,"sources":["file:///workspace/appflow/src/vs/base/parts/ipc/node/ipc.cp.ts"],"names":[],"mappings":"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","file":"ipc.cp.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ChildProcess, fork, ForkOptions } from 'child_process';\nimport { createCancelablePromise, Delayer } from 'vs/base/common/async';\nimport { VSBuffer } from 'vs/base/common/buffer';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { isRemoteConsoleLog, log } from 'vs/base/common/console';\nimport * as errors from 'vs/base/common/errors';\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { dispose, IDisposable, toDisposable } from 'vs/base/common/lifecycle';\nimport { deepClone } from 'vs/base/common/objects';\nimport { createQueuedSender } from 'vs/base/node/processes';\nimport { removeDangerousEnvVariables } from 'vs/base/common/processes';\nimport { ChannelClient as IPCClient, ChannelServer as IPCServer, IChannel, IChannelClient } from 'vs/base/parts/ipc/common/ipc';\n\n/**\n * This implementation doesn't perform well since it uses base64 encoding for buffers.\n * We should move all implementations to use named ipc.net, so we stop depending on cp.fork.\n */\n\nexport class Server<TContext extends string> extends IPCServer<TContext> {\n\tconstructor(ctx: TContext) {\n\t\tsuper({\n\t\t\tsend: r => {\n\t\t\t\ttry {\n\t\t\t\t\tprocess.send?.((<Buffer>r.buffer).toString('base64'));\n\t\t\t\t} catch (e) { /* not much to do */ }\n\t\t\t},\n\t\t\tonMessage: Event.fromNodeEventEmitter(process, 'message', msg => VSBuffer.wrap(Buffer.from(msg, 'base64')))\n\t\t}, ctx);\n\n\t\tprocess.once('disconnect', () => this.dispose());\n\t}\n}\n\nexport interface IIPCOptions {\n\n\t/**\n\t * A descriptive name for the server this connection is to. Used in logging.\n\t */\n\tserverName: string;\n\n\t/**\n\t * Time in millies before killing the ipc process. The next request after killing will start it again.\n\t */\n\ttimeout?: number;\n\n\t/**\n\t * Arguments to the module to execute.\n\t */\n\targs?: string[];\n\n\t/**\n\t * Environment key-value pairs to be passed to the process that gets spawned for the ipc.\n\t */\n\tenv?: any;\n\n\t/**\n\t * Allows to assign a debug port for debugging the application executed.\n\t */\n\tdebug?: number;\n\n\t/**\n\t * Allows to assign a debug port for debugging the application and breaking it on the first line.\n\t */\n\tdebugBrk?: number;\n\n\t/**\n\t * If set, starts the fork with empty execArgv. If not set, execArgv from the parent process are inherited,\n\t * except --inspect= and --inspect-brk= which are filtered as they would result in a port conflict.\n\t */\n\tfreshExecArgv?: boolean;\n\n\t/**\n\t * Enables our createQueuedSender helper for this Client. Uses a queue when the internal Node.js queue is\n\t * full of messages - see notes on that method.\n\t */\n\tuseQueue?: boolean;\n}\n\nexport class Client implements IChannelClient, IDisposable {\n\n\tprivate disposeDelayer: Delayer<void> | undefined;\n\tprivate activeRequests = new Set<IDisposable>();\n\tprivate child: ChildProcess | null;\n\tprivate _client: IPCClient | null;\n\tprivate channels = new Map<string, IChannel>();\n\n\tprivate readonly _onDidProcessExit = new Emitter<{ code: number; signal: string }>();\n\treadonly onDidProcessExit = this._onDidProcessExit.event;\n\n\tconstructor(private modulePath: string, private options: IIPCOptions) {\n\t\tconst timeout = options && options.timeout ? options.timeout : 60000;\n\t\tthis.disposeDelayer = new Delayer<void>(timeout);\n\t\tthis.child = null;\n\t\tthis._client = null;\n\t}\n\n\tgetChannel<T extends IChannel>(channelName: string): T {\n\t\tconst that = this;\n\n\t\treturn {\n\t\t\tcall<T>(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T> {\n\t\t\t\treturn that.requestPromise<T>(channelName, command, arg, cancellationToken);\n\t\t\t},\n\t\t\tlisten(event: string, arg?: any) {\n\t\t\t\treturn that.requestEvent(channelName, event, arg);\n\t\t\t}\n\t\t} as T;\n\t}\n\n\tprotected requestPromise<T>(channelName: string, name: string, arg?: any, cancellationToken = CancellationToken.None): Promise<T> {\n\t\tif (!this.disposeDelayer) {\n\t\t\treturn Promise.reject(new Error('disposed'));\n\t\t}\n\n\t\tif (cancellationToken.isCancellationRequested) {\n\t\t\treturn Promise.reject(errors.canceled());\n\t\t}\n\n\t\tthis.disposeDelayer.cancel();\n\n\t\tconst channel = this.getCachedChannel(channelName);\n\t\tconst result = createCancelablePromise(token => channel.call<T>(name, arg, token));\n\t\tconst cancellationTokenListener = cancellationToken.onCancellationRequested(() => result.cancel());\n\n\t\tconst disposable = toDisposable(() => result.cancel());\n\t\tthis.activeRequests.add(disposable);\n\n\t\tresult.finally(() => {\n\t\t\tcancellationTokenListener.dispose();\n\t\t\tthis.activeRequests.delete(disposable);\n\n\t\t\tif (this.activeRequests.size === 0 && this.disposeDelayer) {\n\t\t\t\tthis.disposeDelayer.trigger(() => this.disposeClient());\n\t\t\t}\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tprotected requestEvent<T>(channelName: string, name: string, arg?: any): Event<T> {\n\t\tif (!this.disposeDelayer) {\n\t\t\treturn Event.None;\n\t\t}\n\n\t\tthis.disposeDelayer.cancel();\n\n\t\tlet listener: IDisposable;\n\t\tconst emitter = new Emitter<any>({\n\t\t\tonWillAddFirstListener: () => {\n\t\t\t\tconst channel = this.getCachedChannel(channelName);\n\t\t\t\tconst event: Event<T> = channel.listen(name, arg);\n\n\t\t\t\tlistener = event(emitter.fire, emitter);\n\t\t\t\tthis.activeRequests.add(listener);\n\t\t\t},\n\t\t\tonDidRemoveLastListener: () => {\n\t\t\t\tthis.activeRequests.delete(listener);\n\t\t\t\tlistener.dispose();\n\n\t\t\t\tif (this.activeRequests.size === 0 && this.disposeDelayer) {\n\t\t\t\t\tthis.disposeDelayer.trigger(() => this.disposeClient());\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn emitter.event;\n\t}\n\n\tprivate get client(): IPCClient {\n\t\tif (!this._client) {\n\t\t\tconst args = this.options && this.options.args ? this.options.args : [];\n\t\t\tconst forkOpts: ForkOptions = Object.create(null);\n\n\t\t\tforkOpts.env = { ...deepClone(process.env), 'VSCODE_PARENT_PID': String(process.pid) };\n\n\t\t\tif (this.options && this.options.env) {\n\t\t\t\tforkOpts.env = { ...forkOpts.env, ...this.options.env };\n\t\t\t}\n\n\t\t\tif (this.options && this.options.freshExecArgv) {\n\t\t\t\tforkOpts.execArgv = [];\n\t\t\t}\n\n\t\t\tif (this.options && typeof this.options.debug === 'number') {\n\t\t\t\tforkOpts.execArgv = ['--nolazy', '--inspect=' + this.options.debug];\n\t\t\t}\n\n\t\t\tif (this.options && typeof this.options.debugBrk === 'number') {\n\t\t\t\tforkOpts.execArgv = ['--nolazy', '--inspect-brk=' + this.options.debugBrk];\n\t\t\t}\n\n\t\t\tif (forkOpts.execArgv === undefined) {\n\t\t\t\tforkOpts.execArgv = process.execArgv\t\t\t// if not set, the forked process inherits the execArgv of the parent process\n\t\t\t\t\t.filter(a => !/^--inspect(-brk)?=/.test(a)) // --inspect and --inspect-brk can not be inherited as the port would conflict\n\t\t\t\t\t.filter(a => !a.startsWith('--vscode-')); \t// --vscode-* arguments are unsupported by node.js and thus need to remove\n\t\t\t}\n\n\t\t\tremoveDangerousEnvVariables(forkOpts.env);\n\n\t\t\tthis.child = fork(this.modulePath, args, forkOpts);\n\n\t\t\tconst onMessageEmitter = new Emitter<VSBuffer>();\n\t\t\tconst onRawMessage = Event.fromNodeEventEmitter(this.child, 'message', msg => msg);\n\n\t\t\tonRawMessage(msg => {\n\n\t\t\t\t// Handle remote console logs specially\n\t\t\t\tif (isRemoteConsoleLog(msg)) {\n\t\t\t\t\tlog(msg, `IPC Library: ${this.options.serverName}`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Anything else goes to the outside\n\t\t\t\tonMessageEmitter.fire(VSBuffer.wrap(Buffer.from(msg, 'base64')));\n\t\t\t});\n\n\t\t\tconst sender = this.options.useQueue ? createQueuedSender(this.child) : this.child;\n\t\t\tconst send = (r: VSBuffer) => this.child && this.child.connected && sender.send((<Buffer>r.buffer).toString('base64'));\n\t\t\tconst onMessage = onMessageEmitter.event;\n\t\t\tconst protocol = { send, onMessage };\n\n\t\t\tthis._client = new IPCClient(protocol);\n\n\t\t\tconst onExit = () => this.disposeClient();\n\t\t\tprocess.once('exit', onExit);\n\n\t\t\tthis.child.on('error', err => console.warn('IPC \"' + this.options.serverName + '\" errored with ' + err));\n\n\t\t\tthis.child.on('exit', (code: any, signal: any) => {\n\t\t\t\tprocess.removeListener('exit' as 'loaded', onExit); // https://github.com/electron/electron/issues/21475\n\n\t\t\t\tthis.activeRequests.forEach(r => dispose(r));\n\t\t\t\tthis.activeRequests.clear();\n\n\t\t\t\tif (code !== 0 && signal !== 'SIGTERM') {\n\t\t\t\t\tconsole.warn('IPC \"' + this.options.serverName + '\" crashed with exit code ' + code + ' and signal ' + signal);\n\t\t\t\t}\n\n\t\t\t\tthis.disposeDelayer?.cancel();\n\t\t\t\tthis.disposeClient();\n\t\t\t\tthis._onDidProcessExit.fire({ code, signal });\n\t\t\t});\n\t\t}\n\n\t\treturn this._client;\n\t}\n\n\tprivate getCachedChannel(name: string): IChannel {\n\t\tlet channel = this.channels.get(name);\n\n\t\tif (!channel) {\n\t\t\tchannel = this.client.getChannel(name);\n\t\t\tthis.channels.set(name, channel);\n\t\t}\n\n\t\treturn channel;\n\t}\n\n\tprivate disposeClient() {\n\t\tif (this._client) {\n\t\t\tif (this.child) {\n\t\t\t\tthis.child.kill();\n\t\t\t\tthis.child = null;\n\t\t\t}\n\t\t\tthis._client = null;\n\t\t\tthis.channels.clear();\n\t\t}\n\t}\n\n\tdispose() {\n\t\tthis._onDidProcessExit.dispose();\n\t\tthis.disposeDelayer?.cancel();\n\t\tthis.disposeDelayer = undefined;\n\t\tthis.disposeClient();\n\t\tthis.activeRequests.clear();\n\t}\n}\n"]}