{"version":3,"sources":["file:///workspace/appflow/src/vs/platform/extensionManagement/common/extensionEnablementService.ts"],"names":[],"mappings":"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","file":"extensionEnablementService.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { Disposable, DisposableStore } from 'vs/base/common/lifecycle';\nimport { isUndefinedOrNull } from 'vs/base/common/types';\nimport { DISABLED_EXTENSIONS_STORAGE_PATH, IExtensionIdentifier, IExtensionManagementService, IGlobalExtensionEnablementService, InstallOperation } from 'vs/platform/extensionManagement/common/extensionManagement';\nimport { areSameExtensions } from 'vs/platform/extensionManagement/common/extensionManagementUtil';\nimport { IProfileStorageValueChangeEvent, IStorageService, StorageScope, StorageTarget } from 'vs/platform/storage/common/storage';\n\nexport class GlobalExtensionEnablementService extends Disposable implements IGlobalExtensionEnablementService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate _onDidChangeEnablement = new Emitter<{ readonly extensions: IExtensionIdentifier[]; readonly source?: string }>();\n\treadonly onDidChangeEnablement: Event<{ readonly extensions: IExtensionIdentifier[]; readonly source?: string }> = this._onDidChangeEnablement.event;\n\tprivate readonly storageManger: StorageManager;\n\n\tconstructor(\n\t\t@IStorageService storageService: IStorageService,\n\t\t@IExtensionManagementService extensionManagementService: IExtensionManagementService,\n\t) {\n\t\tsuper();\n\t\tthis.storageManger = this._register(new StorageManager(storageService));\n\t\tthis._register(this.storageManger.onDidChange(extensions => this._onDidChangeEnablement.fire({ extensions, source: 'storage' })));\n\t\tthis._register(extensionManagementService.onDidInstallExtensions(e => e.forEach(({ local, operation }) => {\n\t\t\tif (local && operation === InstallOperation.Migrate) {\n\t\t\t\tthis._removeFromDisabledExtensions(local.identifier); /* Reset migrated extensions */\n\t\t\t}\n\t\t})));\n\t}\n\n\tasync enableExtension(extension: IExtensionIdentifier, source?: string): Promise<boolean> {\n\t\tif (this._removeFromDisabledExtensions(extension)) {\n\t\t\tthis._onDidChangeEnablement.fire({ extensions: [extension], source });\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tasync disableExtension(extension: IExtensionIdentifier, source?: string): Promise<boolean> {\n\t\tif (this._addToDisabledExtensions(extension)) {\n\t\t\tthis._onDidChangeEnablement.fire({ extensions: [extension], source });\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tgetDisabledExtensions(): IExtensionIdentifier[] {\n\t\treturn this._getExtensions(DISABLED_EXTENSIONS_STORAGE_PATH);\n\t}\n\n\tasync getDisabledExtensionsAsync(): Promise<IExtensionIdentifier[]> {\n\t\treturn this.getDisabledExtensions();\n\t}\n\n\tprivate _addToDisabledExtensions(identifier: IExtensionIdentifier): boolean {\n\t\tconst disabledExtensions = this.getDisabledExtensions();\n\t\tif (disabledExtensions.every(e => !areSameExtensions(e, identifier))) {\n\t\t\tdisabledExtensions.push(identifier);\n\t\t\tthis._setDisabledExtensions(disabledExtensions);\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate _removeFromDisabledExtensions(identifier: IExtensionIdentifier): boolean {\n\t\tconst disabledExtensions = this.getDisabledExtensions();\n\t\tfor (let index = 0; index < disabledExtensions.length; index++) {\n\t\t\tconst disabledExtension = disabledExtensions[index];\n\t\t\tif (areSameExtensions(disabledExtension, identifier)) {\n\t\t\t\tdisabledExtensions.splice(index, 1);\n\t\t\t\tthis._setDisabledExtensions(disabledExtensions);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate _setDisabledExtensions(disabledExtensions: IExtensionIdentifier[]): void {\n\t\tthis._setExtensions(DISABLED_EXTENSIONS_STORAGE_PATH, disabledExtensions);\n\t}\n\n\tprivate _getExtensions(storageId: string): IExtensionIdentifier[] {\n\t\treturn this.storageManger.get(storageId, StorageScope.PROFILE);\n\t}\n\n\tprivate _setExtensions(storageId: string, extensions: IExtensionIdentifier[]): void {\n\t\tthis.storageManger.set(storageId, extensions, StorageScope.PROFILE);\n\t}\n\n}\n\nexport class StorageManager extends Disposable {\n\n\tprivate storage: { [key: string]: string } = Object.create(null);\n\n\tprivate _onDidChange: Emitter<IExtensionIdentifier[]> = this._register(new Emitter<IExtensionIdentifier[]>());\n\treadonly onDidChange: Event<IExtensionIdentifier[]> = this._onDidChange.event;\n\n\tconstructor(private storageService: IStorageService) {\n\t\tsuper();\n\t\tthis._register(storageService.onDidChangeValue(StorageScope.PROFILE, undefined, this._register(new DisposableStore()))(e => this.onDidStorageChange(e)));\n\t}\n\n\tget(key: string, scope: StorageScope): IExtensionIdentifier[] {\n\t\tlet value: string;\n\t\tif (scope === StorageScope.PROFILE) {\n\t\t\tif (isUndefinedOrNull(this.storage[key])) {\n\t\t\t\tthis.storage[key] = this._get(key, scope);\n\t\t\t}\n\t\t\tvalue = this.storage[key];\n\t\t} else {\n\t\t\tvalue = this._get(key, scope);\n\t\t}\n\t\treturn JSON.parse(value);\n\t}\n\n\tset(key: string, value: IExtensionIdentifier[], scope: StorageScope): void {\n\t\tconst newValue: string = JSON.stringify(value.map(({ id, uuid }) => (<IExtensionIdentifier>{ id, uuid })));\n\t\tconst oldValue = this._get(key, scope);\n\t\tif (oldValue !== newValue) {\n\t\t\tif (scope === StorageScope.PROFILE) {\n\t\t\t\tif (value.length) {\n\t\t\t\t\tthis.storage[key] = newValue;\n\t\t\t\t} else {\n\t\t\t\t\tdelete this.storage[key];\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._set(key, value.length ? newValue : undefined, scope);\n\t\t}\n\t}\n\n\tprivate onDidStorageChange(storageChangeEvent: IProfileStorageValueChangeEvent): void {\n\t\tif (!isUndefinedOrNull(this.storage[storageChangeEvent.key])) {\n\t\t\tconst newValue = this._get(storageChangeEvent.key, storageChangeEvent.scope);\n\t\t\tif (newValue !== this.storage[storageChangeEvent.key]) {\n\t\t\t\tconst oldValues = this.get(storageChangeEvent.key, storageChangeEvent.scope);\n\t\t\t\tdelete this.storage[storageChangeEvent.key];\n\t\t\t\tconst newValues = this.get(storageChangeEvent.key, storageChangeEvent.scope);\n\t\t\t\tconst added = oldValues.filter(oldValue => !newValues.some(newValue => areSameExtensions(oldValue, newValue)));\n\t\t\t\tconst removed = newValues.filter(newValue => !oldValues.some(oldValue => areSameExtensions(oldValue, newValue)));\n\t\t\t\tif (added.length || removed.length) {\n\t\t\t\t\tthis._onDidChange.fire([...added, ...removed]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _get(key: string, scope: StorageScope): string {\n\t\treturn this.storageService.get(key, scope, '[]');\n\t}\n\n\tprivate _set(key: string, value: string | undefined, scope: StorageScope): void {\n\t\tif (value) {\n\t\t\t// Enablement state is synced separately through extensions\n\t\t\tthis.storageService.store(key, value, scope, StorageTarget.MACHINE);\n\t\t} else {\n\t\t\tthis.storageService.remove(key, scope);\n\t\t}\n\t}\n}\n"]}