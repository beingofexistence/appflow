{"version":3,"sources":["file:///workspace/appflow/src/vs/platform/extensionManagement/node/extensionLifecycle.ts"],"names":[],"mappings":"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","file":"extensionLifecycle.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ChildProcess, fork } from 'child_process';\nimport { Limiter } from 'vs/base/common/async';\nimport { toErrorMessage } from 'vs/base/common/errorMessage';\nimport { Event } from 'vs/base/common/event';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { Schemas } from 'vs/base/common/network';\nimport { join } from 'vs/base/common/path';\nimport { Promises } from 'vs/base/node/pfs';\nimport { ILocalExtension } from 'vs/platform/extensionManagement/common/extensionManagement';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { IUserDataProfilesService } from 'vs/platform/userDataProfile/common/userDataProfile';\n\nexport class ExtensionsLifecycle extends Disposable {\n\n\tprivate processesLimiter: Limiter<void> = new Limiter(5); // Run max 5 processes in parallel\n\n\tconstructor(\n\t\t@IUserDataProfilesService private userDataProfilesService: IUserDataProfilesService,\n\t\t@ILogService private readonly logService: ILogService\n\t) {\n\t\tsuper();\n\t}\n\n\tasync postUninstall(extension: ILocalExtension): Promise<void> {\n\t\tconst script = this.parseScript(extension, 'uninstall');\n\t\tif (script) {\n\t\t\tthis.logService.info(extension.identifier.id, extension.manifest.version, `Running post uninstall script`);\n\t\t\tawait this.processesLimiter.queue(async () => {\n\t\t\t\ttry {\n\t\t\t\t\tawait this.runLifecycleHook(script.script, 'uninstall', script.args, true, extension);\n\t\t\t\t\tthis.logService.info(`Finished running post uninstall script`, extension.identifier.id, extension.manifest.version);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logService.error('Failed to run post uninstall script', extension.identifier.id, extension.manifest.version);\n\t\t\t\t\tthis.logService.error(error);\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t\ttry {\n\t\t\tawait Promises.rm(this.getExtensionStoragePath(extension));\n\t\t} catch (error) {\n\t\t\tthis.logService.error('Error while removing extension storage path', extension.identifier.id);\n\t\t\tthis.logService.error(error);\n\t\t}\n\t}\n\n\tprivate parseScript(extension: ILocalExtension, type: string): { script: string; args: string[] } | null {\n\t\tconst scriptKey = `vscode:${type}`;\n\t\tif (extension.location.scheme === Schemas.file && extension.manifest && extension.manifest['scripts'] && typeof extension.manifest['scripts'][scriptKey] === 'string') {\n\t\t\tconst script = (<string>extension.manifest['scripts'][scriptKey]).split(' ');\n\t\t\tif (script.length < 2 || script[0] !== 'node' || !script[1]) {\n\t\t\t\tthis.logService.warn(extension.identifier.id, extension.manifest.version, `${scriptKey} should be a node script`);\n\t\t\t\treturn null;\n\t\t\t}\n\t\t\treturn { script: join(extension.location.fsPath, script[1]), args: script.slice(2) || [] };\n\t\t}\n\t\treturn null;\n\t}\n\n\tprivate runLifecycleHook(lifecycleHook: string, lifecycleType: string, args: string[], timeout: boolean, extension: ILocalExtension): Promise<void> {\n\t\treturn new Promise<void>((c, e) => {\n\n\t\t\tconst extensionLifecycleProcess = this.start(lifecycleHook, lifecycleType, args, extension);\n\t\t\tlet timeoutHandler: any;\n\n\t\t\tconst onexit = (error?: string) => {\n\t\t\t\tif (timeoutHandler) {\n\t\t\t\t\tclearTimeout(timeoutHandler);\n\t\t\t\t\ttimeoutHandler = null;\n\t\t\t\t}\n\t\t\t\tif (error) {\n\t\t\t\t\te(error);\n\t\t\t\t} else {\n\t\t\t\t\tc(undefined);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// on error\n\t\t\textensionLifecycleProcess.on('error', (err) => {\n\t\t\t\tonexit(toErrorMessage(err) || 'Unknown');\n\t\t\t});\n\n\t\t\t// on exit\n\t\t\textensionLifecycleProcess.on('exit', (code: number, signal: string) => {\n\t\t\t\tonexit(code ? `post-${lifecycleType} process exited with code ${code}` : undefined);\n\t\t\t});\n\n\t\t\tif (timeout) {\n\t\t\t\t// timeout: kill process after waiting for 5s\n\t\t\t\ttimeoutHandler = setTimeout(() => {\n\t\t\t\t\ttimeoutHandler = null;\n\t\t\t\t\textensionLifecycleProcess.kill();\n\t\t\t\t\te('timed out');\n\t\t\t\t}, 5000);\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate start(uninstallHook: string, lifecycleType: string, args: string[], extension: ILocalExtension): ChildProcess {\n\t\tconst opts = {\n\t\t\tsilent: true,\n\t\t\texecArgv: undefined\n\t\t};\n\t\tconst extensionUninstallProcess = fork(uninstallHook, [`--type=extension-post-${lifecycleType}`, ...args], opts);\n\n\t\t// Catch all output coming from the process\n\t\ttype Output = { data: string; format: string[] };\n\t\textensionUninstallProcess.stdout!.setEncoding('utf8');\n\t\textensionUninstallProcess.stderr!.setEncoding('utf8');\n\n\t\tconst onStdout = Event.fromNodeEventEmitter<string>(extensionUninstallProcess.stdout!, 'data');\n\t\tconst onStderr = Event.fromNodeEventEmitter<string>(extensionUninstallProcess.stderr!, 'data');\n\n\t\t// Log output\n\t\tonStdout(data => this.logService.info(extension.identifier.id, extension.manifest.version, `post-${lifecycleType}`, data));\n\t\tonStderr(data => this.logService.error(extension.identifier.id, extension.manifest.version, `post-${lifecycleType}`, data));\n\n\t\tconst onOutput = Event.any(\n\t\t\tEvent.map(onStdout, o => ({ data: `%c${o}`, format: [''] })),\n\t\t\tEvent.map(onStderr, o => ({ data: `%c${o}`, format: ['color: red'] }))\n\t\t);\n\t\t// Debounce all output, so we can render it in the Chrome console as a group\n\t\tconst onDebouncedOutput = Event.debounce<Output>(onOutput, (r, o) => {\n\t\t\treturn r\n\t\t\t\t? { data: r.data + o.data, format: [...r.format, ...o.format] }\n\t\t\t\t: { data: o.data, format: o.format };\n\t\t}, 100);\n\n\t\t// Print out output\n\t\tonDebouncedOutput(data => {\n\t\t\tconsole.group(extension.identifier.id);\n\t\t\tconsole.log(data.data, ...data.format);\n\t\t\tconsole.groupEnd();\n\t\t});\n\n\t\treturn extensionUninstallProcess;\n\t}\n\n\tprivate getExtensionStoragePath(extension: ILocalExtension): string {\n\t\treturn join(this.userDataProfilesService.defaultProfile.globalStorageHome.fsPath, extension.identifier.id.toLowerCase());\n\t}\n}\n"]}