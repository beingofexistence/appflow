{"version":3,"sources":["file:///workspace/appflow/src/vs/platform/userDataSync/common/userDataProfilesManifestMerge.ts"],"names":[],"mappings":"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","file":"userDataProfilesManifestMerge.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { equals } from 'vs/base/common/objects';\nimport { IUserDataProfile, UseDefaultProfileFlags } from 'vs/platform/userDataProfile/common/userDataProfile';\nimport { ISyncUserDataProfile } from 'vs/platform/userDataSync/common/userDataSync';\n\ninterface IRelaxedMergeResult {\n\tlocal: { added: ISyncUserDataProfile[]; removed: IUserDataProfile[]; updated: ISyncUserDataProfile[] };\n\tremote: { added: IUserDataProfile[]; removed: ISyncUserDataProfile[]; updated: IUserDataProfile[] } | null;\n}\n\nexport type IMergeResult = Required<IRelaxedMergeResult>;\n\ninterface IUserDataProfileInfo {\n\treadonly id: string;\n\treadonly name: string;\n\treadonly shortName?: string;\n\treadonly useDefaultFlags?: UseDefaultProfileFlags;\n}\n\nexport function merge(local: IUserDataProfile[], remote: ISyncUserDataProfile[] | null, lastSync: ISyncUserDataProfile[] | null, ignored: string[]): IMergeResult {\n\tconst localResult: { added: ISyncUserDataProfile[]; removed: IUserDataProfile[]; updated: ISyncUserDataProfile[] } = { added: [], removed: [], updated: [] };\n\tlet remoteResult: { added: IUserDataProfile[]; removed: ISyncUserDataProfile[]; updated: IUserDataProfile[] } | null = { added: [], removed: [], updated: [] };\n\n\tif (!remote) {\n\t\tconst added = local.filter(({ id }) => !ignored.includes(id));\n\t\tif (added.length) {\n\t\t\tremoteResult.added = added;\n\t\t} else {\n\t\t\tremoteResult = null;\n\t\t}\n\t\treturn {\n\t\t\tlocal: localResult,\n\t\t\tremote: remoteResult\n\t\t};\n\t}\n\n\tconst localToRemote = compare(local, remote, ignored);\n\tif (localToRemote.added.length > 0 || localToRemote.removed.length > 0 || localToRemote.updated.length > 0) {\n\n\t\tconst baseToLocal = compare(lastSync, local, ignored);\n\t\tconst baseToRemote = compare(lastSync, remote, ignored);\n\n\t\t// Remotely removed profiles\n\t\tfor (const id of baseToRemote.removed) {\n\t\t\tconst e = local.find(profile => profile.id === id);\n\t\t\tif (e) {\n\t\t\t\tlocalResult.removed.push(e);\n\t\t\t}\n\t\t}\n\n\t\t// Remotely added profiles\n\t\tfor (const id of baseToRemote.added) {\n\t\t\tconst remoteProfile = remote.find(profile => profile.id === id)!;\n\t\t\t// Got added in local\n\t\t\tif (baseToLocal.added.includes(id)) {\n\t\t\t\t// Is different from local to remote\n\t\t\t\tif (localToRemote.updated.includes(id)) {\n\t\t\t\t\t// Remote wins always\n\t\t\t\t\tlocalResult.updated.push(remoteProfile);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tlocalResult.added.push(remoteProfile);\n\t\t\t}\n\t\t}\n\n\t\t// Remotely updated profiles\n\t\tfor (const id of baseToRemote.updated) {\n\t\t\t// Remote wins always\n\t\t\tlocalResult.updated.push(remote.find(profile => profile.id === id)!);\n\t\t}\n\n\t\t// Locally added profiles\n\t\tfor (const id of baseToLocal.added) {\n\t\t\t// Not there in remote\n\t\t\tif (!baseToRemote.added.includes(id)) {\n\t\t\t\tremoteResult.added.push(local.find(profile => profile.id === id)!);\n\t\t\t}\n\t\t}\n\n\t\t// Locally updated profiles\n\t\tfor (const id of baseToLocal.updated) {\n\t\t\t// If removed in remote\n\t\t\tif (baseToRemote.removed.includes(id)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// If not updated in remote\n\t\t\tif (!baseToRemote.updated.includes(id)) {\n\t\t\t\tremoteResult.updated.push(local.find(profile => profile.id === id)!);\n\t\t\t}\n\t\t}\n\n\t\t// Locally removed profiles\n\t\tfor (const id of baseToLocal.removed) {\n\t\t\tconst removedProfile = remote.find(profile => profile.id === id);\n\t\t\tif (removedProfile) {\n\t\t\t\tremoteResult.removed.push(removedProfile);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (remoteResult.added.length === 0 && remoteResult.removed.length === 0 && remoteResult.updated.length === 0) {\n\t\tremoteResult = null;\n\t}\n\n\treturn { local: localResult, remote: remoteResult };\n}\n\nfunction compare(from: IUserDataProfileInfo[] | null, to: IUserDataProfileInfo[], ignoredProfiles: string[]): { added: string[]; removed: string[]; updated: string[] } {\n\tfrom = from ? from.filter(({ id }) => !ignoredProfiles.includes(id)) : [];\n\tto = to.filter(({ id }) => !ignoredProfiles.includes(id));\n\tconst fromKeys = from.map(({ id }) => id);\n\tconst toKeys = to.map(({ id }) => id);\n\tconst added = toKeys.filter(key => !fromKeys.includes(key));\n\tconst removed = fromKeys.filter(key => !toKeys.includes(key));\n\tconst updated: string[] = [];\n\n\tfor (const { id, name, shortName, useDefaultFlags } of from) {\n\t\tif (removed.includes(id)) {\n\t\t\tcontinue;\n\t\t}\n\t\tconst toProfile = to.find(p => p.id === id);\n\t\tif (!toProfile\n\t\t\t|| toProfile.name !== name\n\t\t\t|| toProfile.shortName !== shortName\n\t\t\t|| !equals(toProfile.useDefaultFlags, useDefaultFlags)\n\t\t) {\n\t\t\tupdated.push(id);\n\t\t}\n\t}\n\n\treturn { added, removed, updated };\n}\n"]}