{"version":3,"sources":["file:///workspace/appflow/src/vs/platform/userDataSync/common/userDataSyncServiceIpc.ts"],"names":[],"mappings":"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","file":"userDataSyncServiceIpc.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { URI } from 'vs/base/common/uri';\nimport { IChannel, IServerChannel } from 'vs/base/parts/ipc/common/ipc';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { IUserDataProfilesService, reviveProfile } from 'vs/platform/userDataProfile/common/userDataProfile';\nimport {\n\tIUserDataManualSyncTask, IUserDataSyncResourceConflicts, IUserDataSyncResourceError, IUserDataSyncResource, ISyncResourceHandle, IUserDataSyncTask, IUserDataSyncService,\n\tSyncResource, SyncStatus, UserDataSyncError\n} from 'vs/platform/userDataSync/common/userDataSync';\n\ntype ManualSyncTaskEvent<T> = { manualSyncTaskId: string; data: T };\n\nfunction reviewSyncResource(syncResource: IUserDataSyncResource, userDataProfilesService: IUserDataProfilesService): IUserDataSyncResource {\n\treturn { ...syncResource, profile: reviveProfile(syncResource.profile, userDataProfilesService.profilesHome.scheme) };\n}\n\nfunction reviewSyncResourceHandle(syncResourceHandle: ISyncResourceHandle): ISyncResourceHandle {\n\treturn { created: syncResourceHandle.created, uri: URI.revive(syncResourceHandle.uri) };\n}\n\nexport class UserDataSyncChannel implements IServerChannel {\n\n\tprivate readonly manualSyncTasks = new Map<string, IUserDataManualSyncTask>();\n\tprivate readonly onManualSynchronizeResources = new Emitter<ManualSyncTaskEvent<[SyncResource, URI[]][]>>();\n\n\tconstructor(\n\t\tprivate readonly service: IUserDataSyncService,\n\t\tprivate readonly userDataProfilesService: IUserDataProfilesService,\n\t\tprivate readonly logService: ILogService\n\t) { }\n\n\tlisten(_: unknown, event: string): Event<any> {\n\t\tswitch (event) {\n\t\t\t// sync\n\t\t\tcase 'onDidChangeStatus': return this.service.onDidChangeStatus;\n\t\t\tcase 'onDidChangeConflicts': return this.service.onDidChangeConflicts;\n\t\t\tcase 'onDidChangeLocal': return this.service.onDidChangeLocal;\n\t\t\tcase 'onDidChangeLastSyncTime': return this.service.onDidChangeLastSyncTime;\n\t\t\tcase 'onSyncErrors': return this.service.onSyncErrors;\n\t\t\tcase 'onDidResetLocal': return this.service.onDidResetLocal;\n\t\t\tcase 'onDidResetRemote': return this.service.onDidResetRemote;\n\n\t\t\t// manual sync\n\t\t\tcase 'manualSync/onSynchronizeResources': return this.onManualSynchronizeResources.event;\n\t\t}\n\n\t\tthrow new Error(`Event not found: ${event}`);\n\t}\n\n\tasync call(context: any, command: string, args?: any): Promise<any> {\n\t\ttry {\n\t\t\tconst result = await this._call(context, command, args);\n\t\t\treturn result;\n\t\t} catch (e) {\n\t\t\tthis.logService.error(e);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\tprivate async _call(context: any, command: string, args?: any): Promise<any> {\n\t\tswitch (command) {\n\n\t\t\t// sync\n\t\t\tcase '_getInitialData': return Promise.resolve([this.service.status, this.service.conflicts, this.service.lastSyncTime]);\n\t\t\tcase 'reset': return this.service.reset();\n\t\t\tcase 'resetRemote': return this.service.resetRemote();\n\t\t\tcase 'resetLocal': return this.service.resetLocal();\n\t\t\tcase 'hasPreviouslySynced': return this.service.hasPreviouslySynced();\n\t\t\tcase 'hasLocalData': return this.service.hasLocalData();\n\t\t\tcase 'resolveContent': return this.service.resolveContent(URI.revive(args[0]));\n\t\t\tcase 'accept': return this.service.accept(reviewSyncResource(args[0], this.userDataProfilesService), URI.revive(args[1]), args[2], args[3]);\n\t\t\tcase 'replace': return this.service.replace(reviewSyncResourceHandle(args[0]));\n\t\t\tcase 'cleanUpRemoteData': return this.service.cleanUpRemoteData();\n\t\t\tcase 'getRemoteActivityData': return this.service.saveRemoteActivityData(URI.revive(args[0]));\n\t\t\tcase 'extractActivityData': return this.service.extractActivityData(URI.revive(args[0]), URI.revive(args[1]));\n\n\t\t\tcase 'createManualSyncTask': return this.createManualSyncTask();\n\t\t}\n\n\t\t// manual sync\n\t\tif (command.startsWith('manualSync/')) {\n\t\t\tconst manualSyncTaskCommand = command.substring('manualSync/'.length);\n\t\t\tconst manualSyncTaskId = args[0];\n\t\t\tconst manualSyncTask = this.getManualSyncTask(manualSyncTaskId);\n\t\t\targs = (<Array<any>>args).slice(1);\n\n\t\t\tswitch (manualSyncTaskCommand) {\n\t\t\t\tcase 'merge': return manualSyncTask.merge();\n\t\t\t\tcase 'apply': return manualSyncTask.apply().then(() => this.manualSyncTasks.delete(this.createKey(manualSyncTask.id)));\n\t\t\t\tcase 'stop': return manualSyncTask.stop().finally(() => this.manualSyncTasks.delete(this.createKey(manualSyncTask.id)));\n\t\t\t}\n\t\t}\n\n\t\tthrow new Error('Invalid call');\n\t}\n\n\tprivate getManualSyncTask(manualSyncTaskId: string): IUserDataManualSyncTask {\n\t\tconst manualSyncTask = this.manualSyncTasks.get(this.createKey(manualSyncTaskId));\n\t\tif (!manualSyncTask) {\n\t\t\tthrow new Error(`Manual sync taks not found: ${manualSyncTaskId}`);\n\t\t}\n\t\treturn manualSyncTask;\n\t}\n\n\tprivate async createManualSyncTask(): Promise<string> {\n\t\tconst manualSyncTask = await this.service.createManualSyncTask();\n\t\tthis.manualSyncTasks.set(this.createKey(manualSyncTask.id), manualSyncTask);\n\t\treturn manualSyncTask.id;\n\t}\n\n\tprivate createKey(manualSyncTaskId: string): string { return `manualSyncTask-${manualSyncTaskId}`; }\n\n}\n\nexport class UserDataSyncChannelClient extends Disposable implements IUserDataSyncService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly channel: IChannel;\n\n\tprivate _status: SyncStatus = SyncStatus.Uninitialized;\n\tget status(): SyncStatus { return this._status; }\n\tprivate _onDidChangeStatus: Emitter<SyncStatus> = this._register(new Emitter<SyncStatus>());\n\treadonly onDidChangeStatus: Event<SyncStatus> = this._onDidChangeStatus.event;\n\n\tget onDidChangeLocal(): Event<SyncResource> { return this.channel.listen<SyncResource>('onDidChangeLocal'); }\n\n\tprivate _conflicts: IUserDataSyncResourceConflicts[] = [];\n\tget conflicts(): IUserDataSyncResourceConflicts[] { return this._conflicts; }\n\tprivate _onDidChangeConflicts = this._register(new Emitter<IUserDataSyncResourceConflicts[]>());\n\treadonly onDidChangeConflicts = this._onDidChangeConflicts.event;\n\n\tprivate _lastSyncTime: number | undefined = undefined;\n\tget lastSyncTime(): number | undefined { return this._lastSyncTime; }\n\tprivate _onDidChangeLastSyncTime: Emitter<number> = this._register(new Emitter<number>());\n\treadonly onDidChangeLastSyncTime: Event<number> = this._onDidChangeLastSyncTime.event;\n\n\tprivate _onSyncErrors = this._register(new Emitter<IUserDataSyncResourceError[]>());\n\treadonly onSyncErrors = this._onSyncErrors.event;\n\n\tget onDidResetLocal(): Event<void> { return this.channel.listen<void>('onDidResetLocal'); }\n\tget onDidResetRemote(): Event<void> { return this.channel.listen<void>('onDidResetRemote'); }\n\n\tconstructor(\n\t\tuserDataSyncChannel: IChannel,\n\t\t@IUserDataProfilesService private readonly userDataProfilesService: IUserDataProfilesService,\n\t) {\n\t\tsuper();\n\t\tthis.channel = {\n\t\t\tcall<T>(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T> {\n\t\t\t\treturn userDataSyncChannel.call(command, arg, cancellationToken)\n\t\t\t\t\t.then(null, error => { throw UserDataSyncError.toUserDataSyncError(error); });\n\t\t\t},\n\t\t\tlisten<T>(event: string, arg?: any): Event<T> {\n\t\t\t\treturn userDataSyncChannel.listen(event, arg);\n\t\t\t}\n\t\t};\n\t\tthis.channel.call<[SyncStatus, IUserDataSyncResourceConflicts[], number | undefined]>('_getInitialData').then(([status, conflicts, lastSyncTime]) => {\n\t\t\tthis.updateStatus(status);\n\t\t\tthis.updateConflicts(conflicts);\n\t\t\tif (lastSyncTime) {\n\t\t\t\tthis.updateLastSyncTime(lastSyncTime);\n\t\t\t}\n\t\t\tthis._register(this.channel.listen<SyncStatus>('onDidChangeStatus')(status => this.updateStatus(status)));\n\t\t\tthis._register(this.channel.listen<number>('onDidChangeLastSyncTime')(lastSyncTime => this.updateLastSyncTime(lastSyncTime)));\n\t\t});\n\t\tthis._register(this.channel.listen<IUserDataSyncResourceConflicts[]>('onDidChangeConflicts')(conflicts => this.updateConflicts(conflicts)));\n\t\tthis._register(this.channel.listen<IUserDataSyncResourceError[]>('onSyncErrors')(errors => this._onSyncErrors.fire(errors.map(syncError => ({ ...syncError, error: UserDataSyncError.toUserDataSyncError(syncError.error) })))));\n\t}\n\n\tcreateSyncTask(): Promise<IUserDataSyncTask> {\n\t\tthrow new Error('not supported');\n\t}\n\n\tasync createManualSyncTask(): Promise<IUserDataManualSyncTask> {\n\t\tconst id = await this.channel.call<string>('createManualSyncTask');\n\t\tconst that = this;\n\t\tconst manualSyncTaskChannelClient = new ManualSyncTaskChannelClient(id, {\n\t\t\tasync call<T>(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T> {\n\t\t\t\treturn that.channel.call<T>(`manualSync/${command}`, [id, ...(Array.isArray(arg) ? arg : [arg])], cancellationToken);\n\t\t\t},\n\t\t\tlisten<T>(): Event<T> {\n\t\t\t\tthrow new Error('not supported');\n\t\t\t}\n\t\t});\n\t\treturn manualSyncTaskChannelClient;\n\t}\n\n\treset(): Promise<void> {\n\t\treturn this.channel.call('reset');\n\t}\n\n\tresetRemote(): Promise<void> {\n\t\treturn this.channel.call('resetRemote');\n\t}\n\n\tresetLocal(): Promise<void> {\n\t\treturn this.channel.call('resetLocal');\n\t}\n\n\thasPreviouslySynced(): Promise<boolean> {\n\t\treturn this.channel.call('hasPreviouslySynced');\n\t}\n\n\thasLocalData(): Promise<boolean> {\n\t\treturn this.channel.call('hasLocalData');\n\t}\n\n\taccept(syncResource: IUserDataSyncResource, resource: URI, content: string | null, apply: boolean | { force: boolean }): Promise<void> {\n\t\treturn this.channel.call('accept', [syncResource, resource, content, apply]);\n\t}\n\n\tresolveContent(resource: URI): Promise<string | null> {\n\t\treturn this.channel.call('resolveContent', [resource]);\n\t}\n\n\tcleanUpRemoteData(): Promise<void> {\n\t\treturn this.channel.call('cleanUpRemoteData');\n\t}\n\n\treplace(syncResourceHandle: ISyncResourceHandle): Promise<void> {\n\t\treturn this.channel.call('replace', [syncResourceHandle]);\n\t}\n\n\tsaveRemoteActivityData(location: URI): Promise<void> {\n\t\treturn this.channel.call('getRemoteActivityData', [location]);\n\t}\n\n\textractActivityData(activityDataResource: URI, location: URI): Promise<void> {\n\t\treturn this.channel.call('extractActivityData', [activityDataResource, location]);\n\t}\n\n\tprivate async updateStatus(status: SyncStatus): Promise<void> {\n\t\tthis._status = status;\n\t\tthis._onDidChangeStatus.fire(status);\n\t}\n\n\tprivate async updateConflicts(conflicts: IUserDataSyncResourceConflicts[]): Promise<void> {\n\t\t// Revive URIs\n\t\tthis._conflicts = conflicts.map(syncConflict =>\n\t\t({\n\t\t\tsyncResource: syncConflict.syncResource,\n\t\t\tprofile: reviveProfile(syncConflict.profile, this.userDataProfilesService.profilesHome.scheme),\n\t\t\tconflicts: syncConflict.conflicts.map(r =>\n\t\t\t({\n\t\t\t\t...r,\n\t\t\t\tbaseResource: URI.revive(r.baseResource),\n\t\t\t\tlocalResource: URI.revive(r.localResource),\n\t\t\t\tremoteResource: URI.revive(r.remoteResource),\n\t\t\t\tpreviewResource: URI.revive(r.previewResource),\n\t\t\t}))\n\t\t}));\n\t\tthis._onDidChangeConflicts.fire(this._conflicts);\n\t}\n\n\tprivate updateLastSyncTime(lastSyncTime: number): void {\n\t\tif (this._lastSyncTime !== lastSyncTime) {\n\t\t\tthis._lastSyncTime = lastSyncTime;\n\t\t\tthis._onDidChangeLastSyncTime.fire(lastSyncTime);\n\t\t}\n\t}\n}\n\nclass ManualSyncTaskChannelClient extends Disposable implements IUserDataManualSyncTask {\n\n\tconstructor(\n\t\treadonly id: string,\n\t\tprivate readonly channel: IChannel,\n\t) {\n\t\tsuper();\n\t}\n\n\tasync merge(): Promise<void> {\n\t\treturn this.channel.call('merge');\n\t}\n\n\tasync apply(): Promise<void> {\n\t\treturn this.channel.call('apply');\n\t}\n\n\tstop(): Promise<void> {\n\t\treturn this.channel.call('stop');\n\t}\n\n\toverride dispose(): void {\n\t\tthis.channel.call('dispose');\n\t}\n\n}\n"]}