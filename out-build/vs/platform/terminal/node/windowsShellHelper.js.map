{"version":3,"sources":["file:///workspace/appflow/src/vs/platform/terminal/node/windowsShellHelper.ts"],"names":[],"mappings":"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","file":"windowsShellHelper.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { timeout } from 'vs/base/common/async';\nimport { debounce } from 'vs/base/common/decorators';\nimport { Emitter, Event } from 'vs/base/common/event';\nimport { Disposable, IDisposable } from 'vs/base/common/lifecycle';\nimport { isWindows, platform } from 'vs/base/common/platform';\nimport { TerminalShellType, WindowsShellType } from 'vs/platform/terminal/common/terminal';\nimport type * as WindowsProcessTreeType from '@vscode/windows-process-tree';\n\nexport interface IWindowsShellHelper extends IDisposable {\n\treadonly onShellNameChanged: Event<string>;\n\treadonly onShellTypeChanged: Event<TerminalShellType | undefined>;\n\tgetShellType(title: string): TerminalShellType | undefined;\n\tgetShellName(): Promise<string>;\n}\n\nconst SHELL_EXECUTABLES = [\n\t'cmd.exe',\n\t'powershell.exe',\n\t'pwsh.exe',\n\t'bash.exe',\n\t'wsl.exe',\n\t'ubuntu.exe',\n\t'ubuntu1804.exe',\n\t'kali.exe',\n\t'debian.exe',\n\t'opensuse-42.exe',\n\t'sles-12.exe'\n];\n\nlet windowsProcessTree: typeof WindowsProcessTreeType;\n\nexport class WindowsShellHelper extends Disposable implements IWindowsShellHelper {\n\tprivate _currentRequest: Promise<string> | undefined;\n\tprivate _shellType: TerminalShellType | undefined;\n\tget shellType(): TerminalShellType | undefined { return this._shellType; }\n\tprivate _shellTitle: string = '';\n\tget shellTitle(): string { return this._shellTitle; }\n\tprivate readonly _onShellNameChanged = new Emitter<string>();\n\tget onShellNameChanged(): Event<string> { return this._onShellNameChanged.event; }\n\tprivate readonly _onShellTypeChanged = new Emitter<TerminalShellType | undefined>();\n\tget onShellTypeChanged(): Event<TerminalShellType | undefined> { return this._onShellTypeChanged.event; }\n\n\tconstructor(\n\t\tprivate _rootProcessId: number\n\t) {\n\t\tsuper();\n\n\t\tif (!isWindows) {\n\t\t\tthrow new Error(`WindowsShellHelper cannot be instantiated on ${platform}`);\n\t\t}\n\n\t\tthis._startMonitoringShell();\n\t}\n\n\tprivate async _startMonitoringShell(): Promise<void> {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.checkShell();\n\t}\n\n\t@debounce(500)\n\tasync checkShell(): Promise<void> {\n\t\tif (isWindows) {\n\t\t\t// Wait to give the shell some time to actually launch a process, this\n\t\t\t// could lead to a race condition but it would be recovered from when\n\t\t\t// data stops and should cover the majority of cases\n\t\t\tawait timeout(300);\n\t\t\tthis.getShellName().then(title => {\n\t\t\t\tconst type = this.getShellType(title);\n\t\t\t\tif (type !== this._shellType) {\n\t\t\t\t\tthis._onShellTypeChanged.fire(type);\n\t\t\t\t\tthis._onShellNameChanged.fire(title);\n\t\t\t\t\tthis._shellType = type;\n\t\t\t\t\tthis._shellTitle = title;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate traverseTree(tree: any): string {\n\t\tif (!tree) {\n\t\t\treturn '';\n\t\t}\n\t\tif (SHELL_EXECUTABLES.indexOf(tree.name) === -1) {\n\t\t\treturn tree.name;\n\t\t}\n\t\tif (!tree.children || tree.children.length === 0) {\n\t\t\treturn tree.name;\n\t\t}\n\t\tlet favouriteChild = 0;\n\t\tfor (; favouriteChild < tree.children.length; favouriteChild++) {\n\t\t\tconst child = tree.children[favouriteChild];\n\t\t\tif (!child.children || child.children.length === 0) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (child.children[0].name !== 'conhost.exe') {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (favouriteChild >= tree.children.length) {\n\t\t\treturn tree.name;\n\t\t}\n\t\treturn this.traverseTree(tree.children[favouriteChild]);\n\t}\n\n\t/**\n\t * Returns the innermost shell executable running in the terminal\n\t */\n\tasync getShellName(): Promise<string> {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn Promise.resolve('');\n\t\t}\n\t\t// Prevent multiple requests at once, instead return current request\n\t\tif (this._currentRequest) {\n\t\t\treturn this._currentRequest;\n\t\t}\n\t\tif (!windowsProcessTree) {\n\t\t\twindowsProcessTree = await import('@vscode/windows-process-tree');\n\t\t}\n\t\tthis._currentRequest = new Promise<string>(resolve => {\n\t\t\twindowsProcessTree.getProcessTree(this._rootProcessId, tree => {\n\t\t\t\tconst name = this.traverseTree(tree);\n\t\t\t\tthis._currentRequest = undefined;\n\t\t\t\tresolve(name);\n\t\t\t});\n\t\t});\n\t\treturn this._currentRequest;\n\t}\n\n\tgetShellType(executable: string): TerminalShellType | undefined {\n\t\tswitch (executable.toLowerCase()) {\n\t\t\tcase 'cmd.exe':\n\t\t\t\treturn WindowsShellType.CommandPrompt;\n\t\t\tcase 'powershell.exe':\n\t\t\tcase 'pwsh.exe':\n\t\t\t\treturn WindowsShellType.PowerShell;\n\t\t\tcase 'bash.exe':\n\t\t\tcase 'git-cmd.exe':\n\t\t\t\treturn WindowsShellType.GitBash;\n\t\t\tcase 'wsl.exe':\n\t\t\tcase 'ubuntu.exe':\n\t\t\tcase 'ubuntu1804.exe':\n\t\t\tcase 'kali.exe':\n\t\t\tcase 'debian.exe':\n\t\t\tcase 'opensuse-42.exe':\n\t\t\tcase 'sles-12.exe':\n\t\t\t\treturn WindowsShellType.Wsl;\n\t\t\tdefault:\n\t\t\t\treturn undefined;\n\t\t}\n\t}\n}\n"]}