{"version":3,"sources":["file:///workspace/appflow/src/vs/platform/update/electron-main/updateService.win32.ts"],"names":[],"mappings":"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","file":"updateService.win32.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { spawn } from 'child_process';\nimport * as fs from 'fs';\nimport { tmpdir } from 'os';\nimport { timeout } from 'vs/base/common/async';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { memoize } from 'vs/base/common/decorators';\nimport * as path from 'vs/base/common/path';\nimport { URI } from 'vs/base/common/uri';\nimport { checksum } from 'vs/base/node/crypto';\nimport * as pfs from 'vs/base/node/pfs';\nimport { IConfigurationService } from 'vs/platform/configuration/common/configuration';\nimport { IEnvironmentMainService } from 'vs/platform/environment/electron-main/environmentMainService';\nimport { IFileService } from 'vs/platform/files/common/files';\nimport { ILifecycleMainService, IRelaunchHandler, IRelaunchOptions } from 'vs/platform/lifecycle/electron-main/lifecycleMainService';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { INativeHostMainService } from 'vs/platform/native/electron-main/nativeHostMainService';\nimport { IProductService } from 'vs/platform/product/common/productService';\nimport { asJson, IRequestService } from 'vs/platform/request/common/request';\nimport { ITelemetryService } from 'vs/platform/telemetry/common/telemetry';\nimport { AvailableForDownload, DisablementReason, IUpdate, State, StateType, UpdateType } from 'vs/platform/update/common/update';\nimport { AbstractUpdateService, createUpdateURL, UpdateNotAvailableClassification } from 'vs/platform/update/electron-main/abstractUpdateService';\n\nasync function pollUntil(fn: () => boolean, millis = 1000): Promise<void> {\n\twhile (!fn()) {\n\t\tawait timeout(millis);\n\t}\n}\n\ninterface IAvailableUpdate {\n\tpackagePath: string;\n\tupdateFilePath?: string;\n}\n\nlet _updateType: UpdateType | undefined = undefined;\nfunction getUpdateType(): UpdateType {\n\tif (typeof _updateType === 'undefined') {\n\t\t_updateType = fs.existsSync(path.join(path.dirname(process.execPath), 'unins000.exe'))\n\t\t\t? UpdateType.Setup\n\t\t\t: UpdateType.Archive;\n\t}\n\n\treturn _updateType;\n}\n\nexport class Win32UpdateService extends AbstractUpdateService implements IRelaunchHandler {\n\n\tprivate availableUpdate: IAvailableUpdate | undefined;\n\n\t@memoize\n\tget cachePath(): Promise<string> {\n\t\tconst result = path.join(tmpdir(), `vscode-${this.productService.quality}-${this.productService.target}-${process.arch}`);\n\t\treturn pfs.Promises.mkdir(result, { recursive: true }).then(() => result);\n\t}\n\n\tconstructor(\n\t\t@ILifecycleMainService lifecycleMainService: ILifecycleMainService,\n\t\t@IConfigurationService configurationService: IConfigurationService,\n\t\t@ITelemetryService private readonly telemetryService: ITelemetryService,\n\t\t@IEnvironmentMainService environmentMainService: IEnvironmentMainService,\n\t\t@IRequestService requestService: IRequestService,\n\t\t@ILogService logService: ILogService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@INativeHostMainService private readonly nativeHostMainService: INativeHostMainService,\n\t\t@IProductService productService: IProductService\n\t) {\n\t\tsuper(lifecycleMainService, configurationService, environmentMainService, requestService, logService, productService);\n\n\t\tlifecycleMainService.setRelaunchHandler(this);\n\t}\n\n\thandleRelaunch(options?: IRelaunchOptions): boolean {\n\t\tif (options?.addArgs || options?.removeArgs) {\n\t\t\treturn false; // we cannot apply an update and restart with different args\n\t\t}\n\n\t\tif (this.state.type !== StateType.Ready || !this.availableUpdate) {\n\t\t\treturn false; // we only handle the relaunch when we have a pending update\n\t\t}\n\n\t\tthis.logService.trace('update#handleRelaunch(): running raw#quitAndInstall()');\n\t\tthis.doQuitAndInstall();\n\n\t\treturn true;\n\t}\n\n\tprotected override async initialize(): Promise<void> {\n\t\tif (this.productService.target === 'user' && await this.nativeHostMainService.isAdmin(undefined)) {\n\t\t\tthis.setState(State.Disabled(DisablementReason.RunningAsAdmin));\n\t\t\tthis.logService.info('update#ctor - updates are disabled due to running as Admin in user setup');\n\t\t\treturn;\n\t\t}\n\n\t\tawait super.initialize();\n\t}\n\n\tprotected buildUpdateFeedUrl(quality: string): string | undefined {\n\t\tlet platform = 'win32';\n\n\t\tif (process.arch !== 'ia32') {\n\t\t\tplatform += `-${process.arch}`;\n\t\t}\n\n\t\tif (getUpdateType() === UpdateType.Archive) {\n\t\t\tplatform += '-archive';\n\t\t} else if (this.productService.target === 'user') {\n\t\t\tplatform += '-user';\n\t\t}\n\n\t\treturn createUpdateURL(platform, quality, this.productService);\n\t}\n\n\tprotected doCheckForUpdates(context: any): void {\n\t\tif (!this.url) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.setState(State.CheckingForUpdates(context));\n\n\t\tthis.requestService.request({ url: this.url }, CancellationToken.None)\n\t\t\t.then<IUpdate | null>(asJson)\n\t\t\t.then(update => {\n\t\t\t\tconst updateType = getUpdateType();\n\n\t\t\t\tif (!update || !update.url || !update.version || !update.productVersion) {\n\t\t\t\t\tthis.telemetryService.publicLog2<{ explicit: boolean }, UpdateNotAvailableClassification>('update:notAvailable', { explicit: !!context });\n\n\t\t\t\t\tthis.setState(State.Idle(updateType));\n\t\t\t\t\treturn Promise.resolve(null);\n\t\t\t\t}\n\n\t\t\t\tif (updateType === UpdateType.Archive) {\n\t\t\t\t\tthis.setState(State.AvailableForDownload(update));\n\t\t\t\t\treturn Promise.resolve(null);\n\t\t\t\t}\n\n\t\t\t\tthis.setState(State.Downloading(update));\n\n\t\t\t\treturn this.cleanup(update.version).then(() => {\n\t\t\t\t\treturn this.getUpdatePackagePath(update.version).then(updatePackagePath => {\n\t\t\t\t\t\treturn pfs.Promises.exists(updatePackagePath).then(exists => {\n\t\t\t\t\t\t\tif (exists) {\n\t\t\t\t\t\t\t\treturn Promise.resolve(updatePackagePath);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst url = update.url;\n\t\t\t\t\t\t\tconst hash = update.hash;\n\t\t\t\t\t\t\tconst downloadPath = `${updatePackagePath}.tmp`;\n\n\t\t\t\t\t\t\treturn this.requestService.request({ url }, CancellationToken.None)\n\t\t\t\t\t\t\t\t.then(context => this.fileService.writeFile(URI.file(downloadPath), context.stream))\n\t\t\t\t\t\t\t\t.then(hash ? () => checksum(downloadPath, update.hash) : () => undefined)\n\t\t\t\t\t\t\t\t.then(() => pfs.Promises.rename(downloadPath, updatePackagePath, false /* no retry */))\n\t\t\t\t\t\t\t\t.then(() => updatePackagePath);\n\t\t\t\t\t\t});\n\t\t\t\t\t}).then(packagePath => {\n\t\t\t\t\t\tconst fastUpdatesEnabled = this.configurationService.getValue('update.enableWindowsBackgroundUpdates');\n\n\t\t\t\t\t\tthis.availableUpdate = { packagePath };\n\n\t\t\t\t\t\tif (fastUpdatesEnabled) {\n\t\t\t\t\t\t\tif (this.productService.target === 'user') {\n\t\t\t\t\t\t\t\tthis.doApplyUpdate();\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tthis.setState(State.Downloaded(update));\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tthis.setState(State.Ready(update));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t});\n\t\t\t})\n\t\t\t.then(undefined, err => {\n\t\t\t\tthis.logService.error(err);\n\t\t\t\tthis.telemetryService.publicLog2<{ explicit: boolean }, UpdateNotAvailableClassification>('update:notAvailable', { explicit: !!context });\n\n\t\t\t\t// only show message when explicitly checking for updates\n\t\t\t\tconst message: string | undefined = !!context ? (err.message || err) : undefined;\n\t\t\t\tthis.setState(State.Idle(getUpdateType(), message));\n\t\t\t});\n\t}\n\n\tprotected override async doDownloadUpdate(state: AvailableForDownload): Promise<void> {\n\t\tif (state.update.url) {\n\t\t\tthis.nativeHostMainService.openExternal(undefined, state.update.url);\n\t\t}\n\t\tthis.setState(State.Idle(getUpdateType()));\n\t}\n\n\tprivate async getUpdatePackagePath(version: string): Promise<string> {\n\t\tconst cachePath = await this.cachePath;\n\t\treturn path.join(cachePath, `CodeSetup-${this.productService.quality}-${version}.exe`);\n\t}\n\n\tprivate async cleanup(exceptVersion: string | null = null): Promise<any> {\n\t\tconst filter = exceptVersion ? (one: string) => !(new RegExp(`${this.productService.quality}-${exceptVersion}\\\\.exe$`).test(one)) : () => true;\n\n\t\tconst cachePath = await this.cachePath;\n\t\tconst versions = await pfs.Promises.readdir(cachePath);\n\n\t\tconst promises = versions.filter(filter).map(async one => {\n\t\t\ttry {\n\t\t\t\tawait pfs.Promises.unlink(path.join(cachePath, one));\n\t\t\t} catch (err) {\n\t\t\t\t// ignore\n\t\t\t}\n\t\t});\n\n\t\tawait Promise.all(promises);\n\t}\n\n\tprotected override async doApplyUpdate(): Promise<void> {\n\t\tif (this.state.type !== StateType.Downloaded && this.state.type !== StateType.Downloading) {\n\t\t\treturn Promise.resolve(undefined);\n\t\t}\n\n\t\tif (!this.availableUpdate) {\n\t\t\treturn Promise.resolve(undefined);\n\t\t}\n\n\t\tconst update = this.state.update;\n\t\tthis.setState(State.Updating(update));\n\n\t\tconst cachePath = await this.cachePath;\n\n\t\tthis.availableUpdate.updateFilePath = path.join(cachePath, `CodeSetup-${this.productService.quality}-${update.version}.flag`);\n\n\t\tawait pfs.Promises.writeFile(this.availableUpdate.updateFilePath, 'flag');\n\t\tconst child = spawn(this.availableUpdate.packagePath, ['/verysilent', '/log', `/update=\"${this.availableUpdate.updateFilePath}\"`, '/nocloseapplications', '/mergetasks=runcode,!desktopicon,!quicklaunchicon'], {\n\t\t\tdetached: true,\n\t\t\tstdio: ['ignore', 'ignore', 'ignore'],\n\t\t\twindowsVerbatimArguments: true\n\t\t});\n\n\t\tchild.once('exit', () => {\n\t\t\tthis.availableUpdate = undefined;\n\t\t\tthis.setState(State.Idle(getUpdateType()));\n\t\t});\n\n\t\tconst readyMutexName = `${this.productService.win32MutexName}-ready`;\n\t\tconst mutex = await import('@vscode/windows-mutex');\n\n\t\t// poll for mutex-ready\n\t\tpollUntil(() => mutex.isActive(readyMutexName))\n\t\t\t.then(() => this.setState(State.Ready(update)));\n\t}\n\n\tprotected override doQuitAndInstall(): void {\n\t\tif (this.state.type !== StateType.Ready || !this.availableUpdate) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.logService.trace('update#quitAndInstall(): running raw#quitAndInstall()');\n\n\t\tif (this.availableUpdate.updateFilePath) {\n\t\t\tfs.unlinkSync(this.availableUpdate.updateFilePath);\n\t\t} else {\n\t\t\tspawn(this.availableUpdate.packagePath, ['/silent', '/log', '/mergetasks=runcode,!desktopicon,!quicklaunchicon'], {\n\t\t\t\tdetached: true,\n\t\t\t\tstdio: ['ignore', 'ignore', 'ignore']\n\t\t\t});\n\t\t}\n\t}\n\n\tprotected override getUpdateType(): UpdateType {\n\t\treturn getUpdateType();\n\t}\n\n\toverride async _applySpecificUpdate(packagePath: string): Promise<void> {\n\t\tif (this.state.type !== StateType.Idle) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst fastUpdatesEnabled = this.configurationService.getValue('update.enableWindowsBackgroundUpdates');\n\t\tconst update: IUpdate = { version: 'unknown', productVersion: 'unknown' };\n\n\t\tthis.setState(State.Downloading(update));\n\t\tthis.availableUpdate = { packagePath };\n\n\t\tif (fastUpdatesEnabled) {\n\t\t\tif (this.productService.target === 'user') {\n\t\t\t\tthis.doApplyUpdate();\n\t\t\t} else {\n\t\t\t\tthis.setState(State.Downloaded(update));\n\t\t\t}\n\t\t} else {\n\t\t\tthis.setState(State.Ready(update));\n\t\t}\n\t}\n}\n"]}