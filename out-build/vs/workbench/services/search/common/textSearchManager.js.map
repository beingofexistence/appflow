{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/services/search/common/textSearchManager.ts"],"names":[],"mappings":"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","file":"textSearchManager.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { flatten, mapArrayOrNot } from 'vs/base/common/arrays';\nimport { isThenable } from 'vs/base/common/async';\nimport { CancellationToken, CancellationTokenSource } from 'vs/base/common/cancellation';\nimport { toErrorMessage } from 'vs/base/common/errorMessage';\nimport { Schemas } from 'vs/base/common/network';\nimport * as path from 'vs/base/common/path';\nimport * as resources from 'vs/base/common/resources';\nimport { URI } from 'vs/base/common/uri';\nimport { hasSiblingPromiseFn, IExtendedExtensionSearchOptions, IFileMatch, IFolderQuery, IPatternInfo, ISearchCompleteStats, ITextQuery, ITextSearchContext, ITextSearchMatch, ITextSearchResult, ITextSearchStats, QueryGlobTester, resolvePatternsForProvider } from 'vs/workbench/services/search/common/search';\nimport { Range, TextSearchComplete, TextSearchMatch, TextSearchOptions, TextSearchProvider, TextSearchQuery, TextSearchResult } from 'vs/workbench/services/search/common/searchExtTypes';\n\nexport interface IFileUtils {\n\treaddir: (resource: URI) => Promise<string[]>;\n\ttoCanonicalName: (encoding: string) => string;\n}\n\nexport class TextSearchManager {\n\n\tprivate collector: TextSearchResultsCollector | null = null;\n\n\tprivate isLimitHit = false;\n\tprivate resultCount = 0;\n\n\tconstructor(private query: ITextQuery, private provider: TextSearchProvider, private fileUtils: IFileUtils, private processType: ITextSearchStats['type']) { }\n\n\tsearch(onProgress: (matches: IFileMatch[]) => void, token: CancellationToken): Promise<ISearchCompleteStats> {\n\t\tconst folderQueries = this.query.folderQueries || [];\n\t\tconst tokenSource = new CancellationTokenSource(token);\n\n\t\treturn new Promise<ISearchCompleteStats>((resolve, reject) => {\n\t\t\tthis.collector = new TextSearchResultsCollector(onProgress);\n\n\t\t\tlet isCanceled = false;\n\t\t\tconst onResult = (result: TextSearchResult, folderIdx: number) => {\n\t\t\t\tif (isCanceled) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!this.isLimitHit) {\n\t\t\t\t\tconst resultSize = this.resultSize(result);\n\t\t\t\t\tif (extensionResultIsMatch(result) && typeof this.query.maxResults === 'number' && this.resultCount + resultSize > this.query.maxResults) {\n\t\t\t\t\t\tthis.isLimitHit = true;\n\t\t\t\t\t\tisCanceled = true;\n\t\t\t\t\t\ttokenSource.cancel();\n\n\t\t\t\t\t\tresult = this.trimResultToSize(result, this.query.maxResults - this.resultCount);\n\t\t\t\t\t}\n\n\t\t\t\t\tconst newResultSize = this.resultSize(result);\n\t\t\t\t\tthis.resultCount += newResultSize;\n\t\t\t\t\tif (newResultSize > 0 || !extensionResultIsMatch(result)) {\n\t\t\t\t\t\tthis.collector!.add(result, folderIdx);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t// For each root folder\n\t\t\tPromise.all(folderQueries.map((fq, i) => {\n\t\t\t\treturn this.searchInFolder(fq, r => onResult(r, i), tokenSource.token);\n\t\t\t})).then(results => {\n\t\t\t\ttokenSource.dispose();\n\t\t\t\tthis.collector!.flush();\n\n\t\t\t\tconst someFolderHitLImit = results.some(result => !!result && !!result.limitHit);\n\t\t\t\tresolve({\n\t\t\t\t\tlimitHit: this.isLimitHit || someFolderHitLImit,\n\t\t\t\t\tmessages: flatten(results.map(result => {\n\t\t\t\t\t\tif (!result?.message) { return []; }\n\t\t\t\t\t\tif (Array.isArray(result.message)) { return result.message; }\n\t\t\t\t\t\telse { return [result.message]; }\n\t\t\t\t\t})),\n\t\t\t\t\tstats: {\n\t\t\t\t\t\ttype: this.processType\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}, (err: Error) => {\n\t\t\t\ttokenSource.dispose();\n\t\t\t\tconst errMsg = toErrorMessage(err);\n\t\t\t\treject(new Error(errMsg));\n\t\t\t});\n\t\t});\n\t}\n\n\tprivate resultSize(result: TextSearchResult): number {\n\t\tif (extensionResultIsMatch(result)) {\n\t\t\treturn Array.isArray(result.ranges) ?\n\t\t\t\tresult.ranges.length :\n\t\t\t\t1;\n\t\t}\n\t\telse {\n\t\t\t// #104400 context lines shoudn't count towards result count\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tprivate trimResultToSize(result: TextSearchMatch, size: number): TextSearchMatch {\n\t\tconst rangesArr = Array.isArray(result.ranges) ? result.ranges : [result.ranges];\n\t\tconst matchesArr = Array.isArray(result.preview.matches) ? result.preview.matches : [result.preview.matches];\n\n\t\treturn {\n\t\t\tranges: rangesArr.slice(0, size),\n\t\t\tpreview: {\n\t\t\t\tmatches: matchesArr.slice(0, size),\n\t\t\t\ttext: result.preview.text\n\t\t\t},\n\t\t\turi: result.uri\n\t\t};\n\t}\n\n\tprivate async searchInFolder(folderQuery: IFolderQuery<URI>, onResult: (result: TextSearchResult) => void, token: CancellationToken): Promise<TextSearchComplete | null | undefined> {\n\t\tconst queryTester = new QueryGlobTester(this.query, folderQuery);\n\t\tconst testingPs: Promise<void>[] = [];\n\t\tconst progress = {\n\t\t\treport: (result: TextSearchResult) => {\n\t\t\t\tif (!this.validateProviderResult(result)) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst hasSibling = folderQuery.folder.scheme === Schemas.file ?\n\t\t\t\t\thasSiblingPromiseFn(() => {\n\t\t\t\t\t\treturn this.fileUtils.readdir(resources.dirname(result.uri));\n\t\t\t\t\t}) :\n\t\t\t\t\tundefined;\n\n\t\t\t\tconst relativePath = resources.relativePath(folderQuery.folder, result.uri);\n\t\t\t\tif (relativePath) {\n\t\t\t\t\t// This method is only async when the exclude contains sibling clauses\n\t\t\t\t\tconst included = queryTester.includedInQuery(relativePath, path.basename(relativePath), hasSibling);\n\t\t\t\t\tif (isThenable(included)) {\n\t\t\t\t\t\ttestingPs.push(\n\t\t\t\t\t\t\tincluded.then(isIncluded => {\n\t\t\t\t\t\t\t\tif (isIncluded) {\n\t\t\t\t\t\t\t\t\tonResult(result);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}));\n\t\t\t\t\t} else if (included) {\n\t\t\t\t\t\tonResult(result);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\n\t\tconst searchOptions = this.getSearchOptionsForFolder(folderQuery);\n\t\tconst result = await this.provider.provideTextSearchResults(patternInfoToQuery(this.query.contentPattern), searchOptions, progress, token);\n\t\tif (testingPs.length) {\n\t\t\tawait Promise.all(testingPs);\n\t\t}\n\n\t\treturn result;\n\t}\n\n\tprivate validateProviderResult(result: TextSearchResult): boolean {\n\t\tif (extensionResultIsMatch(result)) {\n\t\t\tif (Array.isArray(result.ranges)) {\n\t\t\t\tif (!Array.isArray(result.preview.matches)) {\n\t\t\t\t\tconsole.warn('INVALID - A text search provider match\\'s`ranges` and`matches` properties must have the same type.');\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\n\t\t\t\tif ((<Range[]>result.preview.matches).length !== result.ranges.length) {\n\t\t\t\t\tconsole.warn('INVALID - A text search provider match\\'s`ranges` and`matches` properties must have the same length.');\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (Array.isArray(result.preview.matches)) {\n\t\t\t\t\tconsole.warn('INVALID - A text search provider match\\'s`ranges` and`matches` properties must have the same length.');\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tprivate getSearchOptionsForFolder(fq: IFolderQuery<URI>): TextSearchOptions {\n\t\tconst includes = resolvePatternsForProvider(this.query.includePattern, fq.includePattern);\n\t\tconst excludes = resolvePatternsForProvider(this.query.excludePattern, fq.excludePattern);\n\n\t\tconst options = <TextSearchOptions>{\n\t\t\tfolder: URI.from(fq.folder),\n\t\t\texcludes,\n\t\t\tincludes,\n\t\t\tuseIgnoreFiles: !fq.disregardIgnoreFiles,\n\t\t\tuseGlobalIgnoreFiles: !fq.disregardGlobalIgnoreFiles,\n\t\t\tuseParentIgnoreFiles: !fq.disregardParentIgnoreFiles,\n\t\t\tfollowSymlinks: !fq.ignoreSymlinks,\n\t\t\tencoding: fq.fileEncoding && this.fileUtils.toCanonicalName(fq.fileEncoding),\n\t\t\tmaxFileSize: this.query.maxFileSize,\n\t\t\tmaxResults: this.query.maxResults,\n\t\t\tpreviewOptions: this.query.previewOptions,\n\t\t\tafterContext: this.query.afterContext,\n\t\t\tbeforeContext: this.query.beforeContext\n\t\t};\n\t\t(<IExtendedExtensionSearchOptions>options).usePCRE2 = this.query.usePCRE2;\n\t\treturn options;\n\t}\n}\n\nfunction patternInfoToQuery(patternInfo: IPatternInfo): TextSearchQuery {\n\treturn <TextSearchQuery>{\n\t\tisCaseSensitive: patternInfo.isCaseSensitive || false,\n\t\tisRegExp: patternInfo.isRegExp || false,\n\t\tisWordMatch: patternInfo.isWordMatch || false,\n\t\tisMultiline: patternInfo.isMultiline || false,\n\t\tpattern: patternInfo.pattern\n\t};\n}\n\nexport class TextSearchResultsCollector {\n\tprivate _batchedCollector: BatchedCollector<IFileMatch>;\n\n\tprivate _currentFolderIdx: number = -1;\n\tprivate _currentUri: URI | undefined;\n\tprivate _currentFileMatch: IFileMatch | null = null;\n\n\tconstructor(private _onResult: (result: IFileMatch[]) => void) {\n\t\tthis._batchedCollector = new BatchedCollector<IFileMatch>(512, items => this.sendItems(items));\n\t}\n\n\tadd(data: TextSearchResult, folderIdx: number): void {\n\t\t// Collects TextSearchResults into IInternalFileMatches and collates using BatchedCollector.\n\t\t// This is efficient for ripgrep which sends results back one file at a time. It wouldn't be efficient for other search\n\t\t// providers that send results in random order. We could do this step afterwards instead.\n\t\tif (this._currentFileMatch && (this._currentFolderIdx !== folderIdx || !resources.isEqual(this._currentUri, data.uri))) {\n\t\t\tthis.pushToCollector();\n\t\t\tthis._currentFileMatch = null;\n\t\t}\n\n\t\tif (!this._currentFileMatch) {\n\t\t\tthis._currentFolderIdx = folderIdx;\n\t\t\tthis._currentFileMatch = {\n\t\t\t\tresource: data.uri,\n\t\t\t\tresults: []\n\t\t\t};\n\t\t}\n\n\t\tthis._currentFileMatch.results!.push(extensionResultToFrontendResult(data));\n\t}\n\n\tprivate pushToCollector(): void {\n\t\tconst size = this._currentFileMatch && this._currentFileMatch.results ?\n\t\t\tthis._currentFileMatch.results.length :\n\t\t\t0;\n\t\tthis._batchedCollector.addItem(this._currentFileMatch!, size);\n\t}\n\n\tflush(): void {\n\t\tthis.pushToCollector();\n\t\tthis._batchedCollector.flush();\n\t}\n\n\tprivate sendItems(items: IFileMatch[]): void {\n\t\tthis._onResult(items);\n\t}\n}\n\nfunction extensionResultToFrontendResult(data: TextSearchResult): ITextSearchResult {\n\t// Warning: result from RipgrepTextSearchEH has fake Range. Don't depend on any other props beyond these...\n\tif (extensionResultIsMatch(data)) {\n\t\treturn <ITextSearchMatch>{\n\t\t\tpreview: {\n\t\t\t\tmatches: mapArrayOrNot(data.preview.matches, m => ({\n\t\t\t\t\tstartLineNumber: m.start.line,\n\t\t\t\t\tstartColumn: m.start.character,\n\t\t\t\t\tendLineNumber: m.end.line,\n\t\t\t\t\tendColumn: m.end.character\n\t\t\t\t})),\n\t\t\t\ttext: data.preview.text\n\t\t\t},\n\t\t\tranges: mapArrayOrNot(data.ranges, r => ({\n\t\t\t\tstartLineNumber: r.start.line,\n\t\t\t\tstartColumn: r.start.character,\n\t\t\t\tendLineNumber: r.end.line,\n\t\t\t\tendColumn: r.end.character\n\t\t\t}))\n\t\t};\n\t} else {\n\t\treturn <ITextSearchContext>{\n\t\t\ttext: data.text,\n\t\t\tlineNumber: data.lineNumber\n\t\t};\n\t}\n}\n\nexport function extensionResultIsMatch(data: TextSearchResult): data is TextSearchMatch {\n\treturn !!(<TextSearchMatch>data).preview;\n}\n\n/**\n * Collects items that have a size - before the cumulative size of collected items reaches START_BATCH_AFTER_COUNT, the callback is called for every\n * set of items collected.\n * But after that point, the callback is called with batches of maxBatchSize.\n * If the batch isn't filled within some time, the callback is also called.\n */\nexport class BatchedCollector<T> {\n\tprivate static readonly TIMEOUT = 4000;\n\n\t// After START_BATCH_AFTER_COUNT items have been collected, stop flushing on timeout\n\tprivate static readonly START_BATCH_AFTER_COUNT = 50;\n\n\tprivate totalNumberCompleted = 0;\n\tprivate batch: T[] = [];\n\tprivate batchSize = 0;\n\tprivate timeoutHandle: any;\n\n\tconstructor(private maxBatchSize: number, private cb: (items: T[]) => void) {\n\t}\n\n\taddItem(item: T, size: number): void {\n\t\tif (!item) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.addItemToBatch(item, size);\n\t}\n\n\taddItems(items: T[], size: number): void {\n\t\tif (!items) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.addItemsToBatch(items, size);\n\t}\n\n\tprivate addItemToBatch(item: T, size: number): void {\n\t\tthis.batch.push(item);\n\t\tthis.batchSize += size;\n\t\tthis.onUpdate();\n\t}\n\n\tprivate addItemsToBatch(item: T[], size: number): void {\n\t\tthis.batch = this.batch.concat(item);\n\t\tthis.batchSize += size;\n\t\tthis.onUpdate();\n\t}\n\n\tprivate onUpdate(): void {\n\t\tif (this.totalNumberCompleted < BatchedCollector.START_BATCH_AFTER_COUNT) {\n\t\t\t// Flush because we aren't batching yet\n\t\t\tthis.flush();\n\t\t} else if (this.batchSize >= this.maxBatchSize) {\n\t\t\t// Flush because the batch is full\n\t\t\tthis.flush();\n\t\t} else if (!this.timeoutHandle) {\n\t\t\t// No timeout running, start a timeout to flush\n\t\t\tthis.timeoutHandle = setTimeout(() => {\n\t\t\t\tthis.flush();\n\t\t\t}, BatchedCollector.TIMEOUT);\n\t\t}\n\t}\n\n\tflush(): void {\n\t\tif (this.batchSize) {\n\t\t\tthis.totalNumberCompleted += this.batchSize;\n\t\t\tthis.cb(this.batch);\n\t\t\tthis.batch = [];\n\t\t\tthis.batchSize = 0;\n\n\t\t\tif (this.timeoutHandle) {\n\t\t\t\tclearTimeout(this.timeoutHandle);\n\t\t\t\tthis.timeoutHandle = 0;\n\t\t\t}\n\t\t}\n\t}\n}\n"]}