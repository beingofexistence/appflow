{"version":3,"sources":["vs/workbench/services/textfile/common/textFileEditorModel.ts"],"names":[],"mappings":"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","file":"textFileEditorModel.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { localize } from 'vs/nls';\nimport { Emitter } from 'vs/base/common/event';\nimport { URI } from 'vs/base/common/uri';\nimport { mark } from 'vs/base/common/performance';\nimport { assertIsDefined } from 'vs/base/common/types';\nimport { EncodingMode, ITextFileService, TextFileEditorModelState, ITextFileEditorModel, ITextFileStreamContent, ITextFileResolveOptions, IResolvedTextFileEditorModel, ITextFileSaveOptions, TextFileResolveReason, ITextFileEditorModelSaveEvent } from 'vs/workbench/services/textfile/common/textfiles';\nimport { IRevertOptions, SaveReason, SaveSourceRegistry } from 'vs/workbench/common/editor';\nimport { BaseTextEditorModel } from 'vs/workbench/common/editor/textEditorModel';\nimport { IWorkingCopyBackupService, IResolvedWorkingCopyBackup } from 'vs/workbench/services/workingCopy/common/workingCopyBackup';\nimport { IFileService, FileOperationError, FileOperationResult, FileChangesEvent, FileChangeType, IFileStatWithMetadata, ETAG_DISABLED, NotModifiedSinceFileOperationError } from 'vs/platform/files/common/files';\nimport { ILanguageService } from 'vs/editor/common/languages/language';\nimport { IModelService } from 'vs/editor/common/services/model';\nimport { timeout, TaskSequentializer } from 'vs/base/common/async';\nimport { ITextBufferFactory, ITextModel } from 'vs/editor/common/model';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { basename } from 'vs/base/common/path';\nimport { IWorkingCopyService } from 'vs/workbench/services/workingCopy/common/workingCopyService';\nimport { IWorkingCopyBackup, WorkingCopyCapabilities, NO_TYPE_ID, IWorkingCopyBackupMeta } from 'vs/workbench/services/workingCopy/common/workingCopy';\nimport { IFilesConfigurationService } from 'vs/workbench/services/filesConfiguration/common/filesConfigurationService';\nimport { ILabelService } from 'vs/platform/label/common/label';\nimport { CancellationToken, CancellationTokenSource } from 'vs/base/common/cancellation';\nimport { UTF16be, UTF16le, UTF8, UTF8_with_bom } from 'vs/workbench/services/textfile/common/encoding';\nimport { createTextBufferFactoryFromStream } from 'vs/editor/common/model/textModel';\nimport { ILanguageDetectionService } from 'vs/workbench/services/languageDetection/common/languageDetectionWorkerService';\nimport { IPathService } from 'vs/workbench/services/path/common/pathService';\nimport { extUri } from 'vs/base/common/resources';\nimport { IAccessibilityService } from 'vs/platform/accessibility/common/accessibility';\nimport { PLAINTEXT_LANGUAGE_ID } from 'vs/editor/common/languages/modesRegistry';\nimport { IExtensionService } from 'vs/workbench/services/extensions/common/extensions';\nimport { IMarkdownString } from 'vs/base/common/htmlContent';\n\ninterface IBackupMetaData extends IWorkingCopyBackupMeta {\n\tmtime: number;\n\tctime: number;\n\tsize: number;\n\tetag: string;\n\torphaned: boolean;\n}\n\n/**\n * The text file editor model listens to changes to its underlying code editor model and saves these changes through the file service back to the disk.\n */\nexport class TextFileEditorModel extends BaseTextEditorModel implements ITextFileEditorModel {\n\n\tprivate static readonly TEXTFILE_SAVE_ENCODING_SOURCE = SaveSourceRegistry.registerSource('textFileEncoding.source', localize('textFileCreate.source', \"File Encoding Changed\"));\n\n\t//#region Events\n\n\tprivate readonly _onDidChangeContent = this._register(new Emitter<void>());\n\treadonly onDidChangeContent = this._onDidChangeContent.event;\n\n\tprivate readonly _onDidResolve = this._register(new Emitter<TextFileResolveReason>());\n\treadonly onDidResolve = this._onDidResolve.event;\n\n\tprivate readonly _onDidChangeDirty = this._register(new Emitter<void>());\n\treadonly onDidChangeDirty = this._onDidChangeDirty.event;\n\n\tprivate readonly _onDidSaveError = this._register(new Emitter<void>());\n\treadonly onDidSaveError = this._onDidSaveError.event;\n\n\tprivate readonly _onDidSave = this._register(new Emitter<ITextFileEditorModelSaveEvent>());\n\treadonly onDidSave = this._onDidSave.event;\n\n\tprivate readonly _onDidRevert = this._register(new Emitter<void>());\n\treadonly onDidRevert = this._onDidRevert.event;\n\n\tprivate readonly _onDidChangeEncoding = this._register(new Emitter<void>());\n\treadonly onDidChangeEncoding = this._onDidChangeEncoding.event;\n\n\tprivate readonly _onDidChangeOrphaned = this._register(new Emitter<void>());\n\treadonly onDidChangeOrphaned = this._onDidChangeOrphaned.event;\n\n\tprivate readonly _onDidChangeReadonly = this._register(new Emitter<void>());\n\treadonly onDidChangeReadonly = this._onDidChangeReadonly.event;\n\n\t//#endregion\n\n\treadonly typeId = NO_TYPE_ID; // IMPORTANT: never change this to not break existing assumptions (e.g. backups)\n\n\treadonly capabilities = WorkingCopyCapabilities.None;\n\n\treadonly name = basename(this.labelService.getUriLabel(this.resource));\n\tprivate resourceHasExtension: boolean = !!extUri.extname(this.resource);\n\n\tprivate contentEncoding: string | undefined; // encoding as reported from disk\n\n\tprivate versionId = 0;\n\tprivate bufferSavedVersionId: number | undefined;\n\n\tprivate ignoreDirtyOnModelContentChange = false;\n\tprivate ignoreSaveFromSaveParticipants = false;\n\n\tprivate static readonly UNDO_REDO_SAVE_PARTICIPANTS_AUTO_SAVE_THROTTLE_THRESHOLD = 500;\n\tprivate lastModelContentChangeFromUndoRedo: number | undefined = undefined;\n\n\tlastResolvedFileStat: IFileStatWithMetadata | undefined; // !!! DO NOT MARK PRIVATE! USED IN TESTS !!!\n\n\tprivate readonly saveSequentializer = new TaskSequentializer();\n\n\tprivate dirty = false;\n\tprivate inConflictMode = false;\n\tprivate inOrphanMode = false;\n\tprivate inErrorMode = false;\n\n\tconstructor(\n\t\treadonly resource: URI,\n\t\tprivate preferredEncoding: string | undefined,\t\t// encoding as chosen by the user\n\t\tprivate preferredLanguageId: string | undefined,\t// language id as chosen by the user\n\t\t@ILanguageService languageService: ILanguageService,\n\t\t@IModelService modelService: IModelService,\n\t\t@IFileService private readonly fileService: IFileService,\n\t\t@ITextFileService private readonly textFileService: ITextFileService,\n\t\t@IWorkingCopyBackupService private readonly workingCopyBackupService: IWorkingCopyBackupService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IWorkingCopyService private readonly workingCopyService: IWorkingCopyService,\n\t\t@IFilesConfigurationService private readonly filesConfigurationService: IFilesConfigurationService,\n\t\t@ILabelService private readonly labelService: ILabelService,\n\t\t@ILanguageDetectionService languageDetectionService: ILanguageDetectionService,\n\t\t@IAccessibilityService accessibilityService: IAccessibilityService,\n\t\t@IPathService private readonly pathService: IPathService,\n\t\t@IExtensionService private readonly extensionService: IExtensionService\n\t) {\n\t\tsuper(modelService, languageService, languageDetectionService, accessibilityService);\n\n\t\t// Make known to working copy service\n\t\tthis._register(this.workingCopyService.registerWorkingCopy(this));\n\n\t\tthis.registerListeners();\n\t}\n\n\tprivate registerListeners(): void {\n\t\tthis._register(this.fileService.onDidFilesChange(e => this.onDidFilesChange(e)));\n\t\tthis._register(this.filesConfigurationService.onFilesAssociationChange(() => this.onFilesAssociationChange()));\n\t\tthis._register(this.filesConfigurationService.onReadonlyChange(() => this._onDidChangeReadonly.fire()));\n\t}\n\n\tprivate async onDidFilesChange(e: FileChangesEvent): Promise<void> {\n\t\tlet fileEventImpactsModel = false;\n\t\tlet newInOrphanModeGuess: boolean | undefined;\n\n\t\t// If we are currently orphaned, we check if the model file was added back\n\t\tif (this.inOrphanMode) {\n\t\t\tconst modelFileAdded = e.contains(this.resource, FileChangeType.ADDED);\n\t\t\tif (modelFileAdded) {\n\t\t\t\tnewInOrphanModeGuess = false;\n\t\t\t\tfileEventImpactsModel = true;\n\t\t\t}\n\t\t}\n\n\t\t// Otherwise we check if the model file was deleted\n\t\telse {\n\t\t\tconst modelFileDeleted = e.contains(this.resource, FileChangeType.DELETED);\n\t\t\tif (modelFileDeleted) {\n\t\t\t\tnewInOrphanModeGuess = true;\n\t\t\t\tfileEventImpactsModel = true;\n\t\t\t}\n\t\t}\n\n\t\tif (fileEventImpactsModel && this.inOrphanMode !== newInOrphanModeGuess) {\n\t\t\tlet newInOrphanModeValidated: boolean = false;\n\t\t\tif (newInOrphanModeGuess) {\n\t\t\t\t// We have received reports of users seeing delete events even though the file still\n\t\t\t\t// exists (network shares issue: https://github.com/microsoft/vscode/issues/13665).\n\t\t\t\t// Since we do not want to mark the model as orphaned, we have to check if the\n\t\t\t\t// file is really gone and not just a faulty file event.\n\t\t\t\tawait timeout(100, CancellationToken.None);\n\n\t\t\t\tif (this.isDisposed()) {\n\t\t\t\t\tnewInOrphanModeValidated = true;\n\t\t\t\t} else {\n\t\t\t\t\tconst exists = await this.fileService.exists(this.resource);\n\t\t\t\t\tnewInOrphanModeValidated = !exists;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (this.inOrphanMode !== newInOrphanModeValidated && !this.isDisposed()) {\n\t\t\t\tthis.setOrphaned(newInOrphanModeValidated);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate setOrphaned(orphaned: boolean): void {\n\t\tif (this.inOrphanMode !== orphaned) {\n\t\t\tthis.inOrphanMode = orphaned;\n\t\t\tthis._onDidChangeOrphaned.fire();\n\t\t}\n\t}\n\n\tprivate onFilesAssociationChange(): void {\n\t\tif (!this.isResolved()) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst firstLineText = this.getFirstLineText(this.textEditorModel);\n\t\tconst languageSelection = this.getOrCreateLanguage(this.resource, this.languageService, this.preferredLanguageId, firstLineText);\n\n\t\tthis.textEditorModel.setLanguage(languageSelection);\n\t}\n\n\toverride setLanguageId(languageId: string, source?: string): void {\n\t\tsuper.setLanguageId(languageId, source);\n\n\t\tthis.preferredLanguageId = languageId;\n\t}\n\n\t//#region Backup\n\n\tasync backup(token: CancellationToken): Promise<IWorkingCopyBackup> {\n\n\t\t// Fill in metadata if we are resolved\n\t\tlet meta: IBackupMetaData | undefined = undefined;\n\t\tif (this.lastResolvedFileStat) {\n\t\t\tmeta = {\n\t\t\t\tmtime: this.lastResolvedFileStat.mtime,\n\t\t\t\tctime: this.lastResolvedFileStat.ctime,\n\t\t\t\tsize: this.lastResolvedFileStat.size,\n\t\t\t\tetag: this.lastResolvedFileStat.etag,\n\t\t\t\torphaned: this.inOrphanMode\n\t\t\t};\n\t\t}\n\n\t\t// Fill in content the same way we would do when\n\t\t// saving the file via the text file service\n\t\t// encoding support (hardcode UTF-8)\n\t\tconst content = await this.textFileService.getEncodedReadable(this.resource, this.createSnapshot() ?? undefined, { encoding: UTF8 });\n\n\t\treturn { meta, content };\n\t}\n\n\t//#endregion\n\n\t//#region Revert\n\n\tasync revert(options?: IRevertOptions): Promise<void> {\n\t\tif (!this.isResolved()) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Unset flags\n\t\tconst wasDirty = this.dirty;\n\t\tconst undo = this.doSetDirty(false);\n\n\t\t// Force read from disk unless reverting soft\n\t\tconst softUndo = options?.soft;\n\t\tif (!softUndo) {\n\t\t\ttry {\n\t\t\t\tawait this.forceResolveFromFile();\n\t\t\t} catch (error) {\n\n\t\t\t\t// FileNotFound means the file got deleted meanwhile, so ignore it\n\t\t\t\tif ((<FileOperationError>error).fileOperationResult !== FileOperationResult.FILE_NOT_FOUND) {\n\n\t\t\t\t\t// Set flags back to previous values, we are still dirty if revert failed\n\t\t\t\t\tundo();\n\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Emit file change event\n\t\tthis._onDidRevert.fire();\n\n\t\t// Emit dirty change event\n\t\tif (wasDirty) {\n\t\t\tthis._onDidChangeDirty.fire();\n\t\t}\n\t}\n\n\t//#endregion\n\n\t//#region Resolve\n\n\toverride async resolve(options?: ITextFileResolveOptions): Promise<void> {\n\t\tthis.trace('resolve() - enter');\n\t\tmark('code/willResolveTextFileEditorModel');\n\n\t\t// Return early if we are disposed\n\t\tif (this.isDisposed()) {\n\t\t\tthis.trace('resolve() - exit - without resolving because model is disposed');\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Unless there are explicit contents provided, it is important that we do not\n\t\t// resolve a model that is dirty or is in the process of saving to prevent data\n\t\t// loss.\n\t\tif (!options?.contents && (this.dirty || this.saveSequentializer.isRunning())) {\n\t\t\tthis.trace('resolve() - exit - without resolving because model is dirty or being saved');\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Resolve either from backup or from file\n\t\tawait this.doResolve(options);\n\n\t\tmark('code/didResolveTextFileEditorModel');\n\t}\n\n\tprivate async doResolve(options?: ITextFileResolveOptions): Promise<void> {\n\n\t\t// First check if we have contents to use for the model\n\t\tif (options?.contents) {\n\t\t\treturn this.resolveFromBuffer(options.contents, options);\n\t\t}\n\n\t\t// Second, check if we have a backup to resolve from (only for new models)\n\t\tconst isNewModel = !this.isResolved();\n\t\tif (isNewModel) {\n\t\t\tconst resolvedFromBackup = await this.resolveFromBackup(options);\n\t\t\tif (resolvedFromBackup) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\n\t\t// Finally, resolve from file resource\n\t\treturn this.resolveFromFile(options);\n\t}\n\n\tprivate async resolveFromBuffer(buffer: ITextBufferFactory, options?: ITextFileResolveOptions): Promise<void> {\n\t\tthis.trace('resolveFromBuffer()');\n\n\t\t// Try to resolve metdata from disk\n\t\tlet mtime: number;\n\t\tlet ctime: number;\n\t\tlet size: number;\n\t\tlet etag: string;\n\t\ttry {\n\t\t\tconst metadata = await this.fileService.stat(this.resource);\n\t\t\tmtime = metadata.mtime;\n\t\t\tctime = metadata.ctime;\n\t\t\tsize = metadata.size;\n\t\t\tetag = metadata.etag;\n\n\t\t\t// Clear orphaned state when resolving was successful\n\t\t\tthis.setOrphaned(false);\n\t\t} catch (error) {\n\n\t\t\t// Put some fallback values in error case\n\t\t\tmtime = Date.now();\n\t\t\tctime = Date.now();\n\t\t\tsize = 0;\n\t\t\tetag = ETAG_DISABLED;\n\n\t\t\t// Apply orphaned state based on error code\n\t\t\tthis.setOrphaned(error.fileOperationResult === FileOperationResult.FILE_NOT_FOUND);\n\t\t}\n\n\t\tconst preferredEncoding = await this.textFileService.encoding.getPreferredWriteEncoding(this.resource, this.preferredEncoding);\n\n\t\t// Resolve with buffer\n\t\tthis.resolveFromContent({\n\t\t\tresource: this.resource,\n\t\t\tname: this.name,\n\t\t\tmtime,\n\t\t\tctime,\n\t\t\tsize,\n\t\t\tetag,\n\t\t\tvalue: buffer,\n\t\t\tencoding: preferredEncoding.encoding,\n\t\t\treadonly: false,\n\t\t\tlocked: false\n\t\t}, true /* dirty (resolved from buffer) */, options);\n\t}\n\n\tprivate async resolveFromBackup(options?: ITextFileResolveOptions): Promise<boolean> {\n\n\t\t// Resolve backup if any\n\t\tconst backup = await this.workingCopyBackupService.resolve<IBackupMetaData>(this);\n\n\t\t// Resolve preferred encoding if we need it\n\t\tlet encoding = UTF8;\n\t\tif (backup) {\n\t\t\tencoding = (await this.textFileService.encoding.getPreferredWriteEncoding(this.resource, this.preferredEncoding)).encoding;\n\t\t}\n\n\t\t// Abort if someone else managed to resolve the model by now\n\t\tconst isNewModel = !this.isResolved();\n\t\tif (!isNewModel) {\n\t\t\tthis.trace('resolveFromBackup() - exit - without resolving because previously new model got created meanwhile');\n\n\t\t\treturn true; // imply that resolving has happened in another operation\n\t\t}\n\n\t\t// Try to resolve from backup if we have any\n\t\tif (backup) {\n\t\t\tawait this.doResolveFromBackup(backup, encoding, options);\n\n\t\t\treturn true;\n\t\t}\n\n\t\t// Otherwise signal back that resolving did not happen\n\t\treturn false;\n\t}\n\n\tprivate async doResolveFromBackup(backup: IResolvedWorkingCopyBackup<IBackupMetaData>, encoding: string, options?: ITextFileResolveOptions): Promise<void> {\n\t\tthis.trace('doResolveFromBackup()');\n\n\t\t// Resolve with backup\n\t\tthis.resolveFromContent({\n\t\t\tresource: this.resource,\n\t\t\tname: this.name,\n\t\t\tmtime: backup.meta ? backup.meta.mtime : Date.now(),\n\t\t\tctime: backup.meta ? backup.meta.ctime : Date.now(),\n\t\t\tsize: backup.meta ? backup.meta.size : 0,\n\t\t\tetag: backup.meta ? backup.meta.etag : ETAG_DISABLED, // etag disabled if unknown!\n\t\t\tvalue: await createTextBufferFactoryFromStream(await this.textFileService.getDecodedStream(this.resource, backup.value, { encoding: UTF8 })),\n\t\t\tencoding,\n\t\t\treadonly: false,\n\t\t\tlocked: false\n\t\t}, true /* dirty (resolved from backup) */, options);\n\n\t\t// Restore orphaned flag based on state\n\t\tif (backup.meta?.orphaned) {\n\t\t\tthis.setOrphaned(true);\n\t\t}\n\t}\n\n\tprivate async resolveFromFile(options?: ITextFileResolveOptions): Promise<void> {\n\t\tthis.trace('resolveFromFile()');\n\n\t\tconst forceReadFromFile = options?.forceReadFromFile;\n\t\tconst allowBinary = this.isResolved() /* always allow if we resolved previously */ || options?.allowBinary;\n\n\t\t// Decide on etag\n\t\tlet etag: string | undefined;\n\t\tif (forceReadFromFile) {\n\t\t\tetag = ETAG_DISABLED; // disable ETag if we enforce to read from disk\n\t\t} else if (this.lastResolvedFileStat) {\n\t\t\tetag = this.lastResolvedFileStat.etag; // otherwise respect etag to support caching\n\t\t}\n\n\t\t// Remember current version before doing any long running operation\n\t\t// to ensure we are not changing a model that was changed meanwhile\n\t\tconst currentVersionId = this.versionId;\n\n\t\t// Resolve Content\n\t\ttry {\n\t\t\tconst content = await this.textFileService.readStream(this.resource, {\n\t\t\t\tacceptTextOnly: !allowBinary,\n\t\t\t\tetag, encoding: this.preferredEncoding,\n\t\t\t\tlimits: options?.limits\n\t\t\t});\n\n\t\t\t// Clear orphaned state when resolving was successful\n\t\t\tthis.setOrphaned(false);\n\n\t\t\t// Return early if the model content has changed\n\t\t\t// meanwhile to prevent loosing any changes\n\t\t\tif (currentVersionId !== this.versionId) {\n\t\t\t\tthis.trace('resolveFromFile() - exit - without resolving because model content changed');\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn this.resolveFromContent(content, false /* not dirty (resolved from file) */, options);\n\t\t} catch (error) {\n\t\t\tconst result = error.fileOperationResult;\n\n\t\t\t// Apply orphaned state based on error code\n\t\t\tthis.setOrphaned(result === FileOperationResult.FILE_NOT_FOUND);\n\n\t\t\t// NotModified status is expected and can be handled gracefully\n\t\t\t// if we are resolved. We still want to update our last resolved\n\t\t\t// stat to e.g. detect changes to the file's readonly state\n\t\t\tif (this.isResolved() && result === FileOperationResult.FILE_NOT_MODIFIED_SINCE) {\n\t\t\t\tif (error instanceof NotModifiedSinceFileOperationError) {\n\t\t\t\t\tthis.updateLastResolvedFileStat(error.stat);\n\t\t\t\t}\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Unless we are forced to read from the file, Ignore when a model has been resolved once\n\t\t\t// and the file was deleted meanwhile. Since we already have the model resolved, we can return\n\t\t\t// to this state and update the orphaned flag to indicate that this model has no version on\n\t\t\t// disk anymore.\n\t\t\tif (this.isResolved() && result === FileOperationResult.FILE_NOT_FOUND && !forceReadFromFile) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Otherwise bubble up the error\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\tprivate resolveFromContent(content: ITextFileStreamContent, dirty: boolean, options?: ITextFileResolveOptions): void {\n\t\tthis.trace('resolveFromContent() - enter');\n\n\t\t// Return early if we are disposed\n\t\tif (this.isDisposed()) {\n\t\t\tthis.trace('resolveFromContent() - exit - because model is disposed');\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Update our resolved disk stat model\n\t\tthis.updateLastResolvedFileStat({\n\t\t\tresource: this.resource,\n\t\t\tname: content.name,\n\t\t\tmtime: content.mtime,\n\t\t\tctime: content.ctime,\n\t\t\tsize: content.size,\n\t\t\tetag: content.etag,\n\t\t\treadonly: content.readonly,\n\t\t\tlocked: content.locked,\n\t\t\tisFile: true,\n\t\t\tisDirectory: false,\n\t\t\tisSymbolicLink: false,\n\t\t\tchildren: undefined\n\t\t});\n\n\t\t// Keep the original encoding to not loose it when saving\n\t\tconst oldEncoding = this.contentEncoding;\n\t\tthis.contentEncoding = content.encoding;\n\n\t\t// Handle events if encoding changed\n\t\tif (this.preferredEncoding) {\n\t\t\tthis.updatePreferredEncoding(this.contentEncoding); // make sure to reflect the real encoding of the file (never out of sync)\n\t\t} else if (oldEncoding !== this.contentEncoding) {\n\t\t\tthis._onDidChangeEncoding.fire();\n\t\t}\n\n\t\t// Update Existing Model\n\t\tif (this.textEditorModel) {\n\t\t\tthis.doUpdateTextModel(content.value);\n\t\t}\n\n\t\t// Create New Model\n\t\telse {\n\t\t\tthis.doCreateTextModel(content.resource, content.value);\n\t\t}\n\n\t\t// Update model dirty flag. This is very important to call\n\t\t// in both cases of dirty or not because it conditionally\n\t\t// updates the `bufferSavedVersionId` to determine the\n\t\t// version when to consider the model as saved again (e.g.\n\t\t// when undoing back to the saved state)\n\t\tthis.setDirty(!!dirty);\n\n\t\t// Emit as event\n\t\tthis._onDidResolve.fire(options?.reason ?? TextFileResolveReason.OTHER);\n\t}\n\n\tprivate doCreateTextModel(resource: URI, value: ITextBufferFactory): void {\n\t\tthis.trace('doCreateTextModel()');\n\n\t\t// Create model\n\t\tconst textModel = this.createTextEditorModel(value, resource, this.preferredLanguageId);\n\n\t\t// Model Listeners\n\t\tthis.installModelListeners(textModel);\n\n\t\t// Detect language from content\n\t\tthis.autoDetectLanguage();\n\t}\n\n\tprivate doUpdateTextModel(value: ITextBufferFactory): void {\n\t\tthis.trace('doUpdateTextModel()');\n\n\t\t// Update model value in a block that ignores content change events for dirty tracking\n\t\tthis.ignoreDirtyOnModelContentChange = true;\n\t\ttry {\n\t\t\tthis.updateTextEditorModel(value, this.preferredLanguageId);\n\t\t} finally {\n\t\t\tthis.ignoreDirtyOnModelContentChange = false;\n\t\t}\n\t}\n\n\tprotected override installModelListeners(model: ITextModel): void {\n\n\t\t// See https://github.com/microsoft/vscode/issues/30189\n\t\t// This code has been extracted to a different method because it caused a memory leak\n\t\t// where `value` was captured in the content change listener closure scope.\n\n\t\tthis._register(model.onDidChangeContent(e => this.onModelContentChanged(model, e.isUndoing || e.isRedoing)));\n\t\tthis._register(model.onDidChangeLanguage(() => this.onMaybeShouldChangeEncoding())); // detect possible encoding change via language specific settings\n\n\t\tsuper.installModelListeners(model);\n\t}\n\n\tprivate onModelContentChanged(model: ITextModel, isUndoingOrRedoing: boolean): void {\n\t\tthis.trace(`onModelContentChanged() - enter`);\n\n\t\t// In any case increment the version id because it tracks the textual content state of the model at all times\n\t\tthis.versionId++;\n\t\tthis.trace(`onModelContentChanged() - new versionId ${this.versionId}`);\n\n\t\t// Remember when the user changed the model through a undo/redo operation.\n\t\t// We need this information to throttle save participants to fix\n\t\t// https://github.com/microsoft/vscode/issues/102542\n\t\tif (isUndoingOrRedoing) {\n\t\t\tthis.lastModelContentChangeFromUndoRedo = Date.now();\n\t\t}\n\n\t\t// We mark check for a dirty-state change upon model content change, unless:\n\t\t// - explicitly instructed to ignore it (e.g. from model.resolve())\n\t\t// - the model is readonly (in that case we never assume the change was done by the user)\n\t\tif (!this.ignoreDirtyOnModelContentChange && !this.isReadonly()) {\n\n\t\t\t// The contents changed as a matter of Undo and the version reached matches the saved one\n\t\t\t// In this case we clear the dirty flag and emit a SAVED event to indicate this state.\n\t\t\tif (model.getAlternativeVersionId() === this.bufferSavedVersionId) {\n\t\t\t\tthis.trace('onModelContentChanged() - model content changed back to last saved version');\n\n\t\t\t\t// Clear flags\n\t\t\t\tconst wasDirty = this.dirty;\n\t\t\t\tthis.setDirty(false);\n\n\t\t\t\t// Emit revert event if we were dirty\n\t\t\t\tif (wasDirty) {\n\t\t\t\t\tthis._onDidRevert.fire();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Otherwise the content has changed and we signal this as becoming dirty\n\t\t\telse {\n\t\t\t\tthis.trace('onModelContentChanged() - model content changed and marked as dirty');\n\n\t\t\t\t// Mark as dirty\n\t\t\t\tthis.setDirty(true);\n\t\t\t}\n\t\t}\n\n\t\t// Emit as event\n\t\tthis._onDidChangeContent.fire();\n\n\t\t// Detect language from content\n\t\tthis.autoDetectLanguage();\n\t}\n\n\tprotected override async autoDetectLanguage(): Promise<void> {\n\n\t\t// Wait to be ready to detect language\n\t\tawait this.extensionService?.whenInstalledExtensionsRegistered();\n\n\t\t// Only perform language detection conditionally\n\t\tconst languageId = this.getLanguageId();\n\t\tif (\n\t\t\tthis.resource.scheme === this.pathService.defaultUriScheme &&\t// make sure to not detect language for non-user visible documents\n\t\t\t(!languageId || languageId === PLAINTEXT_LANGUAGE_ID) &&\t\t// only run on files with plaintext language set or no language set at all\n\t\t\t!this.resourceHasExtension\t\t\t\t\t\t\t\t\t\t// only run if this particular file doesn't have an extension\n\t\t) {\n\t\t\treturn super.autoDetectLanguage();\n\t\t}\n\t}\n\n\tprivate async forceResolveFromFile(): Promise<void> {\n\t\tif (this.isDisposed()) {\n\t\t\treturn; // return early when the model is invalid\n\t\t}\n\n\t\t// We go through the text file service to make\n\t\t// sure this kind of `resolve` is properly\n\t\t// running in sequence with any other running\n\t\t// `resolve` if any, including subsequent runs\n\t\t// that are triggered right after.\n\n\t\tawait this.textFileService.files.resolve(this.resource, {\n\t\t\treload: { async: false },\n\t\t\tforceReadFromFile: true\n\t\t});\n\t}\n\n\t//#endregion\n\n\t//#region Dirty\n\n\tisDirty(): this is IResolvedTextFileEditorModel {\n\t\treturn this.dirty;\n\t}\n\n\tisModified(): boolean {\n\t\treturn this.isDirty();\n\t}\n\n\tsetDirty(dirty: boolean): void {\n\t\tif (!this.isResolved()) {\n\t\t\treturn; // only resolved models can be marked dirty\n\t\t}\n\n\t\t// Track dirty state and version id\n\t\tconst wasDirty = this.dirty;\n\t\tthis.doSetDirty(dirty);\n\n\t\t// Emit as Event if dirty changed\n\t\tif (dirty !== wasDirty) {\n\t\t\tthis._onDidChangeDirty.fire();\n\t\t}\n\t}\n\n\tprivate doSetDirty(dirty: boolean): () => void {\n\t\tconst wasDirty = this.dirty;\n\t\tconst wasInConflictMode = this.inConflictMode;\n\t\tconst wasInErrorMode = this.inErrorMode;\n\t\tconst oldBufferSavedVersionId = this.bufferSavedVersionId;\n\n\t\tif (!dirty) {\n\t\t\tthis.dirty = false;\n\t\t\tthis.inConflictMode = false;\n\t\t\tthis.inErrorMode = false;\n\t\t\tthis.updateSavedVersionId();\n\t\t} else {\n\t\t\tthis.dirty = true;\n\t\t}\n\n\t\t// Return function to revert this call\n\t\treturn () => {\n\t\t\tthis.dirty = wasDirty;\n\t\t\tthis.inConflictMode = wasInConflictMode;\n\t\t\tthis.inErrorMode = wasInErrorMode;\n\t\t\tthis.bufferSavedVersionId = oldBufferSavedVersionId;\n\t\t};\n\t}\n\n\t//#endregion\n\n\t//#region Save\n\n\tasync save(options: ITextFileSaveOptions = Object.create(null)): Promise<boolean> {\n\t\tif (!this.isResolved()) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.isReadonly()) {\n\t\t\tthis.trace('save() - ignoring request for readonly resource');\n\n\t\t\treturn false; // if model is readonly we do not attempt to save at all\n\t\t}\n\n\t\tif (\n\t\t\t(this.hasState(TextFileEditorModelState.CONFLICT) || this.hasState(TextFileEditorModelState.ERROR)) &&\n\t\t\t(options.reason === SaveReason.AUTO || options.reason === SaveReason.FOCUS_CHANGE || options.reason === SaveReason.WINDOW_CHANGE)\n\t\t) {\n\t\t\tthis.trace('save() - ignoring auto save request for model that is in conflict or error');\n\n\t\t\treturn false; // if model is in save conflict or error, do not save unless save reason is explicit\n\t\t}\n\n\t\t// Actually do save and log\n\t\tthis.trace('save() - enter');\n\t\tawait this.doSave(options);\n\t\tthis.trace('save() - exit');\n\n\t\treturn this.hasState(TextFileEditorModelState.SAVED);\n\t}\n\n\tprivate async doSave(options: ITextFileSaveOptions): Promise<void> {\n\t\tif (typeof options.reason !== 'number') {\n\t\t\toptions.reason = SaveReason.EXPLICIT;\n\t\t}\n\n\t\tlet versionId = this.versionId;\n\t\tthis.trace(`doSave(${versionId}) - enter with versionId ${versionId}`);\n\n\t\t// Return early if saved from within save participant to break recursion\n\t\t//\n\t\t// Scenario: a save participant triggers a save() on the model\n\t\tif (this.ignoreSaveFromSaveParticipants) {\n\t\t\tthis.trace(`doSave(${versionId}) - exit - refusing to save() recursively from save participant`);\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Lookup any running save for this versionId and return it if found\n\t\t//\n\t\t// Scenario: user invoked the save action multiple times quickly for the same contents\n\t\t//           while the save was not yet finished to disk\n\t\t//\n\t\tif (this.saveSequentializer.isRunning(versionId)) {\n\t\t\tthis.trace(`doSave(${versionId}) - exit - found a running save for versionId ${versionId}`);\n\n\t\t\treturn this.saveSequentializer.running;\n\t\t}\n\n\t\t// Return early if not dirty (unless forced)\n\t\t//\n\t\t// Scenario: user invoked save action even though the model is not dirty\n\t\tif (!options.force && !this.dirty) {\n\t\t\tthis.trace(`doSave(${versionId}) - exit - because not dirty and/or versionId is different (this.isDirty: ${this.dirty}, this.versionId: ${this.versionId})`);\n\n\t\t\treturn;\n\t\t}\n\n\t\t// Return if currently saving by storing this save request as the next save that should happen.\n\t\t// Never ever must 2 saves execute at the same time because this can lead to dirty writes and race conditions.\n\t\t//\n\t\t// Scenario A: auto save was triggered and is currently busy saving to disk. this takes long enough that another auto save\n\t\t//             kicks in.\n\t\t// Scenario B: save is very slow (e.g. network share) and the user manages to change the buffer and trigger another save\n\t\t//             while the first save has not returned yet.\n\t\t//\n\t\tif (this.saveSequentializer.isRunning()) {\n\t\t\tthis.trace(`doSave(${versionId}) - exit - because busy saving`);\n\n\t\t\t// Indicate to the save sequentializer that we want to\n\t\t\t// cancel the running operation so that ours can run\n\t\t\t// before the running one finishes.\n\t\t\t// Currently this will try to cancel running save\n\t\t\t// participants but never a running save.\n\t\t\tthis.saveSequentializer.cancelRunning();\n\n\t\t\t// Queue this as the upcoming save and return\n\t\t\treturn this.saveSequentializer.queue(() => this.doSave(options));\n\t\t}\n\n\t\t// Push all edit operations to the undo stack so that the user has a chance to\n\t\t// Ctrl+Z back to the saved version.\n\t\tif (this.isResolved()) {\n\t\t\tthis.textEditorModel.pushStackElement();\n\t\t}\n\n\t\tconst saveCancellation = new CancellationTokenSource();\n\n\t\treturn this.saveSequentializer.run(versionId, (async () => {\n\n\t\t\t// A save participant can still change the model now and since we are so close to saving\n\t\t\t// we do not want to trigger another auto save or similar, so we block this\n\t\t\t// In addition we update our version right after in case it changed because of a model change\n\t\t\t//\n\t\t\t// Save participants can also be skipped through API.\n\t\t\tif (this.isResolved() && !options.skipSaveParticipants) {\n\t\t\t\ttry {\n\n\t\t\t\t\t// Measure the time it took from the last undo/redo operation to this save. If this\n\t\t\t\t\t// time is below `UNDO_REDO_SAVE_PARTICIPANTS_THROTTLE_THRESHOLD`, we make sure to\n\t\t\t\t\t// delay the save participant for the remaining time if the reason is auto save.\n\t\t\t\t\t//\n\t\t\t\t\t// This fixes the following issue:\n\t\t\t\t\t// - the user has configured auto save with delay of 100ms or shorter\n\t\t\t\t\t// - the user has a save participant enabled that modifies the file on each save\n\t\t\t\t\t// - the user types into the file and the file gets saved\n\t\t\t\t\t// - the user triggers undo operation\n\t\t\t\t\t// - this will undo the save participant change but trigger the save participant right after\n\t\t\t\t\t// - the user has no chance to undo over the save participant\n\t\t\t\t\t//\n\t\t\t\t\t// Reported as: https://github.com/microsoft/vscode/issues/102542\n\t\t\t\t\tif (options.reason === SaveReason.AUTO && typeof this.lastModelContentChangeFromUndoRedo === 'number') {\n\t\t\t\t\t\tconst timeFromUndoRedoToSave = Date.now() - this.lastModelContentChangeFromUndoRedo;\n\t\t\t\t\t\tif (timeFromUndoRedoToSave < TextFileEditorModel.UNDO_REDO_SAVE_PARTICIPANTS_AUTO_SAVE_THROTTLE_THRESHOLD) {\n\t\t\t\t\t\t\tawait timeout(TextFileEditorModel.UNDO_REDO_SAVE_PARTICIPANTS_AUTO_SAVE_THROTTLE_THRESHOLD - timeFromUndoRedoToSave);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\t// Run save participants unless save was cancelled meanwhile\n\t\t\t\t\tif (!saveCancellation.token.isCancellationRequested) {\n\t\t\t\t\t\tthis.ignoreSaveFromSaveParticipants = true;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tawait this.textFileService.files.runSaveParticipants(this, { reason: options.reason ?? SaveReason.EXPLICIT }, saveCancellation.token);\n\t\t\t\t\t\t} finally {\n\t\t\t\t\t\t\tthis.ignoreSaveFromSaveParticipants = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.logService.error(`[text file model] runSaveParticipants(${versionId}) - resulted in an error: ${error.toString()}`, this.resource.toString());\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// It is possible that a subsequent save is cancelling this\n\t\t\t// running save. As such we return early when we detect that\n\t\t\t// However, we do not pass the token into the file service\n\t\t\t// because that is an atomic operation currently without\n\t\t\t// cancellation support, so we dispose the cancellation if\n\t\t\t// it was not cancelled yet.\n\t\t\tif (saveCancellation.token.isCancellationRequested) {\n\t\t\t\treturn;\n\t\t\t} else {\n\t\t\t\tsaveCancellation.dispose();\n\t\t\t}\n\n\t\t\t// We have to protect against being disposed at this point. It could be that the save() operation\n\t\t\t// was triggerd followed by a dispose() operation right after without waiting. Typically we cannot\n\t\t\t// be disposed if we are dirty, but if we are not dirty, save() and dispose() can still be triggered\n\t\t\t// one after the other without waiting for the save() to complete. If we are disposed(), we risk\n\t\t\t// saving contents to disk that are stale (see https://github.com/microsoft/vscode/issues/50942).\n\t\t\t// To fix this issue, we will not store the contents to disk when we got disposed.\n\t\t\tif (this.isDisposed()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// We require a resolved model from this point on, since we are about to write data to disk.\n\t\t\tif (!this.isResolved()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// update versionId with its new value (if pre-save changes happened)\n\t\t\tversionId = this.versionId;\n\n\t\t\t// Clear error flag since we are trying to save again\n\t\t\tthis.inErrorMode = false;\n\n\t\t\t// Save to Disk. We mark the save operation as currently running with\n\t\t\t// the latest versionId because it might have changed from a save\n\t\t\t// participant triggering\n\t\t\tthis.trace(`doSave(${versionId}) - before write()`);\n\t\t\tconst lastResolvedFileStat = assertIsDefined(this.lastResolvedFileStat);\n\t\t\tconst resolvedTextFileEditorModel = this;\n\t\t\treturn this.saveSequentializer.run(versionId, (async () => {\n\t\t\t\ttry {\n\t\t\t\t\tconst stat = await this.textFileService.write(lastResolvedFileStat.resource, resolvedTextFileEditorModel.createSnapshot(), {\n\t\t\t\t\t\tmtime: lastResolvedFileStat.mtime,\n\t\t\t\t\t\tencoding: this.getEncoding(),\n\t\t\t\t\t\tetag: (options.ignoreModifiedSince || !this.filesConfigurationService.preventSaveConflicts(lastResolvedFileStat.resource, resolvedTextFileEditorModel.getLanguageId())) ? ETAG_DISABLED : lastResolvedFileStat.etag,\n\t\t\t\t\t\tunlock: options.writeUnlock,\n\t\t\t\t\t\twriteElevated: options.writeElevated\n\t\t\t\t\t});\n\n\t\t\t\t\tthis.handleSaveSuccess(stat, versionId, options);\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis.handleSaveError(error, versionId, options);\n\t\t\t\t}\n\t\t\t})());\n\t\t})(), () => saveCancellation.cancel());\n\t}\n\n\tprivate handleSaveSuccess(stat: IFileStatWithMetadata, versionId: number, options: ITextFileSaveOptions): void {\n\n\t\t// Updated resolved stat with updated stat\n\t\tthis.updateLastResolvedFileStat(stat);\n\n\t\t// Update dirty state unless model has changed meanwhile\n\t\tif (versionId === this.versionId) {\n\t\t\tthis.trace(`handleSaveSuccess(${versionId}) - setting dirty to false because versionId did not change`);\n\t\t\tthis.setDirty(false);\n\t\t} else {\n\t\t\tthis.trace(`handleSaveSuccess(${versionId}) - not setting dirty to false because versionId did change meanwhile`);\n\t\t}\n\n\t\t// Update orphan state given save was successful\n\t\tthis.setOrphaned(false);\n\n\t\t// Emit Save Event\n\t\tthis._onDidSave.fire({ reason: options.reason, stat, source: options.source });\n\t}\n\n\tprivate handleSaveError(error: Error, versionId: number, options: ITextFileSaveOptions): void {\n\t\t(options.ignoreErrorHandler ? this.logService.trace : this.logService.error).apply(this.logService, [`[text file model] handleSaveError(${versionId}) - exit - resulted in a save error: ${error.toString()}`, this.resource.toString()]);\n\n\t\t// Return early if the save() call was made asking to\n\t\t// handle the save error itself.\n\t\tif (options.ignoreErrorHandler) {\n\t\t\tthrow error;\n\t\t}\n\n\t\t// In any case of an error, we mark the model as dirty to prevent data loss\n\t\t// It could be possible that the write corrupted the file on disk (e.g. when\n\t\t// an error happened after truncating the file) and as such we want to preserve\n\t\t// the model contents to prevent data loss.\n\t\tthis.setDirty(true);\n\n\t\t// Flag as error state in the model\n\t\tthis.inErrorMode = true;\n\n\t\t// Look out for a save conflict\n\t\tif ((<FileOperationError>error).fileOperationResult === FileOperationResult.FILE_MODIFIED_SINCE) {\n\t\t\tthis.inConflictMode = true;\n\t\t}\n\n\t\t// Show to user\n\t\tthis.textFileService.files.saveErrorHandler.onSaveError(error, this);\n\n\t\t// Emit as event\n\t\tthis._onDidSaveError.fire();\n\t}\n\n\tprivate updateSavedVersionId(): void {\n\t\t// we remember the models alternate version id to remember when the version\n\t\t// of the model matches with the saved version on disk. we need to keep this\n\t\t// in order to find out if the model changed back to a saved version (e.g.\n\t\t// when undoing long enough to reach to a version that is saved and then to\n\t\t// clear the dirty flag)\n\t\tif (this.isResolved()) {\n\t\t\tthis.bufferSavedVersionId = this.textEditorModel.getAlternativeVersionId();\n\t\t}\n\t}\n\n\tprivate updateLastResolvedFileStat(newFileStat: IFileStatWithMetadata): void {\n\t\tconst oldReadonly = this.isReadonly();\n\n\t\t// First resolve - just take\n\t\tif (!this.lastResolvedFileStat) {\n\t\t\tthis.lastResolvedFileStat = newFileStat;\n\t\t}\n\n\t\t// Subsequent resolve - make sure that we only assign it if the mtime is equal or has advanced.\n\t\t// This prevents race conditions from resolving and saving. If a save comes in late after a revert\n\t\t// was called, the mtime could be out of sync.\n\t\telse if (this.lastResolvedFileStat.mtime <= newFileStat.mtime) {\n\t\t\tthis.lastResolvedFileStat = newFileStat;\n\t\t}\n\n\t\t// Signal that the readonly state changed\n\t\tif (this.isReadonly() !== oldReadonly) {\n\t\t\tthis._onDidChangeReadonly.fire();\n\t\t}\n\t}\n\n\t//#endregion\n\n\thasState(state: TextFileEditorModelState): boolean {\n\t\tswitch (state) {\n\t\t\tcase TextFileEditorModelState.CONFLICT:\n\t\t\t\treturn this.inConflictMode;\n\t\t\tcase TextFileEditorModelState.DIRTY:\n\t\t\t\treturn this.dirty;\n\t\t\tcase TextFileEditorModelState.ERROR:\n\t\t\t\treturn this.inErrorMode;\n\t\t\tcase TextFileEditorModelState.ORPHAN:\n\t\t\t\treturn this.inOrphanMode;\n\t\t\tcase TextFileEditorModelState.PENDING_SAVE:\n\t\t\t\treturn this.saveSequentializer.isRunning();\n\t\t\tcase TextFileEditorModelState.SAVED:\n\t\t\t\treturn !this.dirty;\n\t\t}\n\t}\n\n\tasync joinState(state: TextFileEditorModelState.PENDING_SAVE): Promise<void> {\n\t\treturn this.saveSequentializer.running;\n\t}\n\n\toverride getLanguageId(this: IResolvedTextFileEditorModel): string;\n\toverride getLanguageId(): string | undefined;\n\toverride getLanguageId(): string | undefined {\n\t\tif (this.textEditorModel) {\n\t\t\treturn this.textEditorModel.getLanguageId();\n\t\t}\n\n\t\treturn this.preferredLanguageId;\n\t}\n\n\t//#region Encoding\n\n\tprivate async onMaybeShouldChangeEncoding(): Promise<void> {\n\n\t\t// This is a bit of a hack but there is a narrow case where\n\t\t// per-language configured encodings are not working:\n\t\t//\n\t\t// On startup we may not yet have all languages resolved so\n\t\t// we pick a wrong encoding. We never used to re-apply the\n\t\t// encoding when the language was then resolved, because that\n\t\t// is an operation that is will have to fetch the contents\n\t\t// again from disk.\n\t\t//\n\t\t// To mitigate this issue, when we detect the model language\n\t\t// changes, we see if there is a specific encoding configured\n\t\t// for the new language and apply it, only if the model is\n\t\t// not dirty and only if the encoding was not explicitly set.\n\t\t//\n\t\t// (see https://github.com/microsoft/vscode/issues/127936)\n\n\t\tif (this.hasEncodingSetExplicitly) {\n\t\t\tthis.trace('onMaybeShouldChangeEncoding() - ignoring because encoding was set explicitly');\n\n\t\t\treturn; // never change the user's choice of encoding\n\t\t}\n\n\t\tif (this.contentEncoding === UTF8_with_bom || this.contentEncoding === UTF16be || this.contentEncoding === UTF16le) {\n\t\t\tthis.trace('onMaybeShouldChangeEncoding() - ignoring because content encoding has a BOM');\n\n\t\t\treturn; // never change an encoding that we can detect 100% via BOMs\n\t\t}\n\n\t\tconst { encoding } = await this.textFileService.encoding.getPreferredReadEncoding(this.resource);\n\t\tif (typeof encoding !== 'string' || !this.isNewEncoding(encoding)) {\n\t\t\tthis.trace(`onMaybeShouldChangeEncoding() - ignoring because preferred encoding ${encoding} is not new`);\n\n\t\t\treturn; // return early if encoding is invalid or did not change\n\t\t}\n\n\t\tif (this.isDirty()) {\n\t\t\tthis.trace('onMaybeShouldChangeEncoding() - ignoring because model is dirty');\n\n\t\t\treturn; // return early to prevent accident saves in this case\n\t\t}\n\n\t\tthis.logService.info(`Adjusting encoding based on configured language override to '${encoding}' for ${this.resource.toString(true)}.`);\n\n\t\t// Re-open with new encoding\n\t\treturn this.setEncodingInternal(encoding, EncodingMode.Decode);\n\t}\n\n\tprivate hasEncodingSetExplicitly: boolean = false;\n\n\tsetEncoding(encoding: string, mode: EncodingMode): Promise<void> {\n\n\t\t// Remember that an explicit encoding was set\n\t\tthis.hasEncodingSetExplicitly = true;\n\n\t\treturn this.setEncodingInternal(encoding, mode);\n\t}\n\n\tprivate async setEncodingInternal(encoding: string, mode: EncodingMode): Promise<void> {\n\n\t\t// Encode: Save with encoding\n\t\tif (mode === EncodingMode.Encode) {\n\t\t\tthis.updatePreferredEncoding(encoding);\n\n\t\t\t// Save\n\t\t\tif (!this.isDirty()) {\n\t\t\t\tthis.versionId++; // needs to increment because we change the model potentially\n\t\t\t\tthis.setDirty(true);\n\t\t\t}\n\n\t\t\tif (!this.inConflictMode) {\n\t\t\t\tawait this.save({ source: TextFileEditorModel.TEXTFILE_SAVE_ENCODING_SOURCE });\n\t\t\t}\n\t\t}\n\n\t\t// Decode: Resolve with encoding\n\t\telse {\n\t\t\tif (!this.isNewEncoding(encoding)) {\n\t\t\t\treturn; // return early if the encoding is already the same\n\t\t\t}\n\n\t\t\tif (this.isDirty() && !this.inConflictMode) {\n\t\t\t\tawait this.save();\n\t\t\t}\n\n\t\t\tthis.updatePreferredEncoding(encoding);\n\n\t\t\tawait this.forceResolveFromFile();\n\t\t}\n\t}\n\n\tupdatePreferredEncoding(encoding: string | undefined): void {\n\t\tif (!this.isNewEncoding(encoding)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.preferredEncoding = encoding;\n\n\t\t// Emit\n\t\tthis._onDidChangeEncoding.fire();\n\t}\n\n\tprivate isNewEncoding(encoding: string | undefined): boolean {\n\t\tif (this.preferredEncoding === encoding) {\n\t\t\treturn false; // return early if the encoding is already the same\n\t\t}\n\n\t\tif (!this.preferredEncoding && this.contentEncoding === encoding) {\n\t\t\treturn false; // also return if we don't have a preferred encoding but the content encoding is already the same\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tgetEncoding(): string | undefined {\n\t\treturn this.preferredEncoding || this.contentEncoding;\n\t}\n\n\t//#endregion\n\n\tprivate trace(msg: string): void {\n\t\tthis.logService.trace(`[text file model] ${msg}`, this.resource.toString());\n\t}\n\n\toverride isResolved(): this is IResolvedTextFileEditorModel {\n\t\treturn !!this.textEditorModel;\n\t}\n\n\toverride isReadonly(): boolean | IMarkdownString {\n\t\treturn this.filesConfigurationService.isReadonly(this.resource, this.lastResolvedFileStat);\n\t}\n\n\toverride dispose(): void {\n\t\tthis.trace('dispose()');\n\n\t\tthis.inConflictMode = false;\n\t\tthis.inOrphanMode = false;\n\t\tthis.inErrorMode = false;\n\n\t\tsuper.dispose();\n\t}\n}\n"]}