{"version":3,"sources":["vs/workbench/api/browser/mainThreadTunnelService.ts"],"names":[],"mappings":"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","file":"mainThreadTunnelService.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from 'vs/nls';\nimport { MainThreadTunnelServiceShape, MainContext, ExtHostContext, ExtHostTunnelServiceShape, CandidatePortSource, PortAttributesSelector, TunnelDto } from 'vs/workbench/api/common/extHost.protocol';\nimport { TunnelDtoConverter } from 'vs/workbench/api/common/extHostTunnelService';\nimport { extHostNamedCustomer, IExtHostContext } from 'vs/workbench/services/extensions/common/extHostCustomers';\nimport { IRemoteExplorerService, PORT_AUTO_FORWARD_SETTING, PORT_AUTO_SOURCE_SETTING, PORT_AUTO_SOURCE_SETTING_OUTPUT } from 'vs/workbench/services/remote/common/remoteExplorerService';\nimport { ITunnelProvider, ITunnelService, TunnelCreationOptions, TunnelProviderFeatures, TunnelOptions, RemoteTunnel, ProvidedPortAttributes, PortAttributesProvider, TunnelProtocol } from 'vs/platform/tunnel/common/tunnel';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport type { TunnelDescription } from 'vs/platform/remote/common/remoteAuthorityResolver';\nimport { INotificationService, Severity } from 'vs/platform/notification/common/notification';\nimport { IConfigurationService } from 'vs/platform/configuration/common/configuration';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { IRemoteAgentService } from 'vs/workbench/services/remote/common/remoteAgentService';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { Registry } from 'vs/platform/registry/common/platform';\nimport { IConfigurationRegistry, Extensions as ConfigurationExtensions } from 'vs/platform/configuration/common/configurationRegistry';\nimport { IContextKeyService } from 'vs/platform/contextkey/common/contextkey';\nimport { CandidatePort, TunnelCloseReason, TunnelSource, forwardedPortsViewEnabled, makeAddress } from 'vs/workbench/services/remote/common/tunnelModel';\n\n@extHostNamedCustomer(MainContext.MainThreadTunnelService)\nexport class MainThreadTunnelService extends Disposable implements MainThreadTunnelServiceShape, PortAttributesProvider {\n\tprivate readonly _proxy: ExtHostTunnelServiceShape;\n\tprivate elevateionRetry: boolean = false;\n\tprivate portsAttributesProviders: Map<number, PortAttributesSelector> = new Map();\n\n\tconstructor(\n\t\textHostContext: IExtHostContext,\n\t\t@IRemoteExplorerService private readonly remoteExplorerService: IRemoteExplorerService,\n\t\t@ITunnelService private readonly tunnelService: ITunnelService,\n\t\t@INotificationService private readonly notificationService: INotificationService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@ILogService private readonly logService: ILogService,\n\t\t@IRemoteAgentService private readonly remoteAgentService: IRemoteAgentService,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService\n\t) {\n\t\tsuper();\n\t\tthis._proxy = extHostContext.getProxy(ExtHostContext.ExtHostTunnelService);\n\t\tthis._register(tunnelService.onTunnelOpened(() => this._proxy.$onDidTunnelsChange()));\n\t\tthis._register(tunnelService.onTunnelClosed(() => this._proxy.$onDidTunnelsChange()));\n\t}\n\n\tprivate processFindingEnabled(): boolean {\n\t\treturn (!!this.configurationService.getValue(PORT_AUTO_FORWARD_SETTING) || this.tunnelService.hasTunnelProvider)\n\t\t\t&& (this.configurationService.getValue(PORT_AUTO_SOURCE_SETTING) !== PORT_AUTO_SOURCE_SETTING_OUTPUT);\n\t}\n\n\tasync $setRemoteTunnelService(processId: number): Promise<void> {\n\t\tthis.remoteExplorerService.namedProcesses.set(processId, 'Code Extension Host');\n\t\tif (this.remoteExplorerService.portsFeaturesEnabled) {\n\t\t\tthis._proxy.$registerCandidateFinder(this.processFindingEnabled());\n\t\t} else {\n\t\t\tthis._register(this.remoteExplorerService.onEnabledPortsFeatures(() => this._proxy.$registerCandidateFinder(this.configurationService.getValue(PORT_AUTO_FORWARD_SETTING))));\n\t\t}\n\t\tthis._register(this.configurationService.onDidChangeConfiguration(async (e) => {\n\t\t\tif (e.affectsConfiguration(PORT_AUTO_FORWARD_SETTING) || e.affectsConfiguration(PORT_AUTO_SOURCE_SETTING)) {\n\t\t\t\treturn this._proxy.$registerCandidateFinder(this.processFindingEnabled());\n\t\t\t}\n\t\t}));\n\t\tthis._register(this.tunnelService.onAddedTunnelProvider(() => {\n\t\t\treturn this._proxy.$registerCandidateFinder(this.processFindingEnabled());\n\t\t}));\n\t}\n\n\tprivate _alreadyRegistered: boolean = false;\n\tasync $registerPortsAttributesProvider(selector: PortAttributesSelector, providerHandle: number): Promise<void> {\n\t\tthis.portsAttributesProviders.set(providerHandle, selector);\n\t\tif (!this._alreadyRegistered) {\n\t\t\tthis.remoteExplorerService.tunnelModel.addAttributesProvider(this);\n\t\t\tthis._alreadyRegistered = true;\n\t\t}\n\t}\n\n\tasync $unregisterPortsAttributesProvider(providerHandle: number): Promise<void> {\n\t\tthis.portsAttributesProviders.delete(providerHandle);\n\t}\n\n\tasync providePortAttributes(ports: number[], pid: number | undefined, commandLine: string | undefined, token: CancellationToken): Promise<ProvidedPortAttributes[]> {\n\t\tif (this.portsAttributesProviders.size === 0) {\n\t\t\treturn [];\n\t\t}\n\n\t\t// Check all the selectors to make sure it's worth going to the extension host.\n\t\tconst appropriateHandles = Array.from(this.portsAttributesProviders.entries()).filter(entry => {\n\t\t\tconst selector = entry[1];\n\t\t\tconst portRange = (typeof selector.portRange === 'number') ? [selector.portRange, selector.portRange + 1] : selector.portRange;\n\t\t\tconst portInRange = portRange ? ports.some(port => portRange[0] <= port && port < portRange[1]) : true;\n\t\t\tconst commandMatches = !selector.commandPattern || (commandLine && (commandLine.match(selector.commandPattern)));\n\t\t\treturn portInRange && commandMatches;\n\t\t}).map(entry => entry[0]);\n\n\t\tif (appropriateHandles.length === 0) {\n\t\t\treturn [];\n\t\t}\n\t\treturn this._proxy.$providePortAttributes(appropriateHandles, ports, pid, commandLine, token);\n\t}\n\n\tasync $openTunnel(tunnelOptions: TunnelOptions, source: string): Promise<TunnelDto | undefined> {\n\t\tconst tunnel = await this.remoteExplorerService.forward({\n\t\t\tremote: tunnelOptions.remoteAddress,\n\t\t\tlocal: tunnelOptions.localAddressPort,\n\t\t\tname: tunnelOptions.label,\n\t\t\tsource: {\n\t\t\t\tsource: TunnelSource.Extension,\n\t\t\t\tdescription: source\n\t\t\t},\n\t\t\televateIfNeeded: false\n\t\t});\n\t\tif (!tunnel || (typeof tunnel === 'string')) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (!this.elevateionRetry\n\t\t\t&& (tunnelOptions.localAddressPort !== undefined)\n\t\t\t&& (tunnel.tunnelLocalPort !== undefined)\n\t\t\t&& this.tunnelService.isPortPrivileged(tunnelOptions.localAddressPort)\n\t\t\t&& (tunnel.tunnelLocalPort !== tunnelOptions.localAddressPort)\n\t\t\t&& this.tunnelService.canElevate) {\n\n\t\t\tthis.elevationPrompt(tunnelOptions, tunnel, source);\n\t\t}\n\t\treturn TunnelDtoConverter.fromServiceTunnel(tunnel);\n\t}\n\n\tprivate async elevationPrompt(tunnelOptions: TunnelOptions, tunnel: RemoteTunnel, source: string) {\n\t\treturn this.notificationService.prompt(Severity.Info,\n\t\t\tnls.localize('remote.tunnel.openTunnel', \"The extension {0} has forwarded port {1}. You'll need to run as superuser to use port {2} locally.\", source, tunnelOptions.remoteAddress.port, tunnelOptions.localAddressPort),\n\t\t\t[{\n\t\t\t\tlabel: nls.localize('remote.tunnelsView.elevationButton', \"Use Port {0} as Sudo...\", tunnel.tunnelRemotePort),\n\t\t\t\trun: async () => {\n\t\t\t\t\tthis.elevateionRetry = true;\n\t\t\t\t\tawait this.remoteExplorerService.close({ host: tunnel.tunnelRemoteHost, port: tunnel.tunnelRemotePort }, TunnelCloseReason.Other);\n\t\t\t\t\tawait this.remoteExplorerService.forward({\n\t\t\t\t\t\tremote: tunnelOptions.remoteAddress,\n\t\t\t\t\t\tlocal: tunnelOptions.localAddressPort,\n\t\t\t\t\t\tname: tunnelOptions.label,\n\t\t\t\t\t\tsource: {\n\t\t\t\t\t\t\tsource: TunnelSource.Extension,\n\t\t\t\t\t\t\tdescription: source\n\t\t\t\t\t\t},\n\t\t\t\t\t\televateIfNeeded: true\n\t\t\t\t\t});\n\t\t\t\t\tthis.elevateionRetry = false;\n\t\t\t\t}\n\t\t\t}]);\n\t}\n\n\tasync $closeTunnel(remote: { host: string; port: number }): Promise<void> {\n\t\treturn this.remoteExplorerService.close(remote, TunnelCloseReason.Other);\n\t}\n\n\tasync $getTunnels(): Promise<TunnelDescription[]> {\n\t\treturn (await this.tunnelService.tunnels).map(tunnel => {\n\t\t\treturn {\n\t\t\t\tremoteAddress: { port: tunnel.tunnelRemotePort, host: tunnel.tunnelRemoteHost },\n\t\t\t\tlocalAddress: tunnel.localAddress,\n\t\t\t\tprivacy: tunnel.privacy,\n\t\t\t\tprotocol: tunnel.protocol\n\t\t\t};\n\t\t});\n\t}\n\n\tasync $onFoundNewCandidates(candidates: CandidatePort[]): Promise<void> {\n\t\tthis.remoteExplorerService.onFoundNewCandidates(candidates);\n\t}\n\n\tasync $setTunnelProvider(features?: TunnelProviderFeatures): Promise<void> {\n\t\tconst tunnelProvider: ITunnelProvider = {\n\t\t\tforwardPort: (tunnelOptions: TunnelOptions, tunnelCreationOptions: TunnelCreationOptions) => {\n\t\t\t\tconst forward = this._proxy.$forwardPort(tunnelOptions, tunnelCreationOptions);\n\t\t\t\treturn forward.then(tunnelOrError => {\n\t\t\t\t\tif (!tunnelOrError) {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t} else if (typeof tunnelOrError === 'string') {\n\t\t\t\t\t\treturn tunnelOrError;\n\t\t\t\t\t}\n\t\t\t\t\tconst tunnel = tunnelOrError;\n\t\t\t\t\tthis.logService.trace(`ForwardedPorts: (MainThreadTunnelService) New tunnel established by tunnel provider: ${tunnel?.remoteAddress.host}:${tunnel?.remoteAddress.port}`);\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\ttunnelRemotePort: tunnel.remoteAddress.port,\n\t\t\t\t\t\ttunnelRemoteHost: tunnel.remoteAddress.host,\n\t\t\t\t\t\tlocalAddress: typeof tunnel.localAddress === 'string' ? tunnel.localAddress : makeAddress(tunnel.localAddress.host, tunnel.localAddress.port),\n\t\t\t\t\t\ttunnelLocalPort: typeof tunnel.localAddress !== 'string' ? tunnel.localAddress.port : undefined,\n\t\t\t\t\t\tpublic: tunnel.public,\n\t\t\t\t\t\tprivacy: tunnel.privacy,\n\t\t\t\t\t\tprotocol: tunnel.protocol ?? TunnelProtocol.Http,\n\t\t\t\t\t\tdispose: async (silent?: boolean) => {\n\t\t\t\t\t\t\tthis.logService.trace(`ForwardedPorts: (MainThreadTunnelService) Closing tunnel from tunnel provider: ${tunnel?.remoteAddress.host}:${tunnel?.remoteAddress.port}`);\n\t\t\t\t\t\t\treturn this._proxy.$closeTunnel({ host: tunnel.remoteAddress.host, port: tunnel.remoteAddress.port }, silent);\n\t\t\t\t\t\t}\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t\tif (features) {\n\t\t\tthis.tunnelService.setTunnelFeatures(features);\n\t\t}\n\t\tthis.tunnelService.setTunnelProvider(tunnelProvider);\n\t\t// At this point we clearly want the ports view/features since we have a tunnel factory\n\t\tthis.contextKeyService.createKey(forwardedPortsViewEnabled.key, true);\n\t}\n\n\tasync $setCandidateFilter(): Promise<void> {\n\t\tthis.remoteExplorerService.setCandidateFilter((candidates: CandidatePort[]): Promise<CandidatePort[]> => {\n\t\t\treturn this._proxy.$applyCandidateFilter(candidates);\n\t\t});\n\t}\n\n\tasync $setCandidatePortSource(source: CandidatePortSource): Promise<void> {\n\t\t// Must wait for the remote environment before trying to set settings there.\n\t\tthis.remoteAgentService.getEnvironment().then(() => {\n\t\t\tswitch (source) {\n\t\t\t\tcase CandidatePortSource.None: {\n\t\t\t\t\tRegistry.as<IConfigurationRegistry>(ConfigurationExtensions.Configuration)\n\t\t\t\t\t\t.registerDefaultConfigurations([{ overrides: { 'remote.autoForwardPorts': false } }]);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcase CandidatePortSource.Output: {\n\t\t\t\t\tRegistry.as<IConfigurationRegistry>(ConfigurationExtensions.Configuration)\n\t\t\t\t\t\t.registerDefaultConfigurations([{ overrides: { 'remote.autoForwardPortsSource': PORT_AUTO_SOURCE_SETTING_OUTPUT } }]);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdefault: // Do nothing, the defaults for these settings should be used.\n\t\t\t}\n\t\t}).catch(() => {\n\t\t\t// The remote failed to get setup. Errors from that area will already be surfaced to the user.\n\t\t});\n\t}\n}\n"]}