{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/api/node/extHostSearch.ts"],"names":[],"mappings":"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","file":"extHostSearch.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DisposableStore, IDisposable, toDisposable } from 'vs/base/common/lifecycle';\nimport { Schemas } from 'vs/base/common/network';\nimport { URI } from 'vs/base/common/uri';\nimport * as pfs from 'vs/base/node/pfs';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { IExtHostInitDataService } from 'vs/workbench/api/common/extHostInitDataService';\nimport { IExtHostRpcService } from 'vs/workbench/api/common/extHostRpcService';\nimport { ExtHostSearch, reviveQuery } from 'vs/workbench/api/common/extHostSearch';\nimport { IURITransformerService } from 'vs/workbench/api/common/extHostUriTransformerService';\nimport { IFileQuery, IRawFileQuery, ISearchCompleteStats, ISerializedSearchProgressItem, isSerializedFileMatch, ITextQuery } from 'vs/workbench/services/search/common/search';\nimport { TextSearchManager } from 'vs/workbench/services/search/common/textSearchManager';\nimport { SearchService } from 'vs/workbench/services/search/node/rawSearchService';\nimport { RipgrepSearchProvider } from 'vs/workbench/services/search/node/ripgrepSearchProvider';\nimport { OutputChannel } from 'vs/workbench/services/search/node/ripgrepSearchUtils';\nimport { NativeTextSearchManager } from 'vs/workbench/services/search/node/textSearchManager';\nimport type * as vscode from 'vscode';\n\nexport class NativeExtHostSearch extends ExtHostSearch implements IDisposable {\n\n\tprotected _pfs: typeof pfs = pfs; // allow extending for tests\n\n\tprivate _internalFileSearchHandle: number = -1;\n\tprivate _internalFileSearchProvider: SearchService | null = null;\n\n\tprivate _registeredEHSearchProvider = false;\n\n\tprivate readonly _disposables = new DisposableStore();\n\n\tconstructor(\n\t\t@IExtHostRpcService extHostRpc: IExtHostRpcService,\n\t\t@IExtHostInitDataService initData: IExtHostInitDataService,\n\t\t@IURITransformerService _uriTransformer: IURITransformerService,\n\t\t@ILogService _logService: ILogService,\n\t) {\n\t\tsuper(extHostRpc, _uriTransformer, _logService);\n\n\t\tconst outputChannel = new OutputChannel('RipgrepSearchUD', this._logService);\n\t\tthis._disposables.add(this.registerTextSearchProvider(Schemas.vscodeUserData, new RipgrepSearchProvider(outputChannel)));\n\t\tif (initData.remote.isRemote && initData.remote.authority) {\n\t\t\tthis._registerEHSearchProviders();\n\t\t}\n\t}\n\n\tdispose(): void {\n\t\tthis._disposables.dispose();\n\t}\n\n\toverride $enableExtensionHostSearch(): void {\n\t\tthis._registerEHSearchProviders();\n\t}\n\n\tprivate _registerEHSearchProviders(): void {\n\t\tif (this._registeredEHSearchProvider) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._registeredEHSearchProvider = true;\n\t\tconst outputChannel = new OutputChannel('RipgrepSearchEH', this._logService);\n\t\tthis._disposables.add(this.registerTextSearchProvider(Schemas.file, new RipgrepSearchProvider(outputChannel)));\n\t\tthis._disposables.add(this.registerInternalFileSearchProvider(Schemas.file, new SearchService('fileSearchProvider')));\n\t}\n\n\tprivate registerInternalFileSearchProvider(scheme: string, provider: SearchService): IDisposable {\n\t\tconst handle = this._handlePool++;\n\t\tthis._internalFileSearchProvider = provider;\n\t\tthis._internalFileSearchHandle = handle;\n\t\tthis._proxy.$registerFileSearchProvider(handle, this._transformScheme(scheme));\n\t\treturn toDisposable(() => {\n\t\t\tthis._internalFileSearchProvider = null;\n\t\t\tthis._proxy.$unregisterProvider(handle);\n\t\t});\n\t}\n\n\toverride $provideFileSearchResults(handle: number, session: number, rawQuery: IRawFileQuery, token: vscode.CancellationToken): Promise<ISearchCompleteStats> {\n\t\tconst query = reviveQuery(rawQuery);\n\t\tif (handle === this._internalFileSearchHandle) {\n\t\t\treturn this.doInternalFileSearch(handle, session, query, token);\n\t\t}\n\n\t\treturn super.$provideFileSearchResults(handle, session, rawQuery, token);\n\t}\n\n\tprivate doInternalFileSearch(handle: number, session: number, rawQuery: IFileQuery, token: vscode.CancellationToken): Promise<ISearchCompleteStats> {\n\t\tconst onResult = (ev: ISerializedSearchProgressItem) => {\n\t\t\tif (isSerializedFileMatch(ev)) {\n\t\t\t\tev = [ev];\n\t\t\t}\n\n\t\t\tif (Array.isArray(ev)) {\n\t\t\t\tthis._proxy.$handleFileMatch(handle, session, ev.map(m => URI.file(m.path)));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (ev.message) {\n\t\t\t\tthis._logService.debug('ExtHostSearch', ev.message);\n\t\t\t}\n\t\t};\n\n\t\tif (!this._internalFileSearchProvider) {\n\t\t\tthrow new Error('No internal file search handler');\n\t\t}\n\n\t\treturn <Promise<ISearchCompleteStats>>this._internalFileSearchProvider.doFileSearch(rawQuery, onResult, token);\n\t}\n\n\toverride $clearCache(cacheKey: string): Promise<void> {\n\t\tthis._internalFileSearchProvider?.clearCache(cacheKey);\n\n\t\treturn super.$clearCache(cacheKey);\n\t}\n\n\tprotected override createTextSearchManager(query: ITextQuery, provider: vscode.TextSearchProvider): TextSearchManager {\n\t\treturn new NativeTextSearchManager(query, provider, undefined, 'textSearchProvider');\n\t}\n}\n"]}