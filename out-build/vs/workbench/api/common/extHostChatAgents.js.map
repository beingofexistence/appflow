{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/api/common/extHostChatAgents.ts"],"names":[],"mappings":"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","file":"extHostChatAgents.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DeferredPromise, raceCancellation } from 'vs/base/common/async';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { IDisposable, toDisposable } from 'vs/base/common/lifecycle';\nimport { ExtensionIdentifier } from 'vs/platform/extensions/common/extensions';\nimport { ILogService } from 'vs/platform/log/common/log';\nimport { Progress } from 'vs/platform/progress/common/progress';\nimport { ExtHostChatAgentsShape, IMainContext, MainContext, MainThreadChatAgentsShape } from 'vs/workbench/api/common/extHost.protocol';\nimport { ExtHostChatProvider } from 'vs/workbench/api/common/extHostChatProvider';\nimport * as typeConvert from 'vs/workbench/api/common/extHostTypeConverters';\nimport { ChatMessageRole } from 'vs/workbench/api/common/extHostTypes';\nimport { IChatMessage } from 'vs/workbench/contrib/chat/common/chatProvider';\nimport type * as vscode from 'vscode';\n\nexport class ExtHostChatAgents implements ExtHostChatAgentsShape {\n\n\tprivate static _idPool = 0;\n\n\tprivate readonly _agents = new Map<number, { extension: ExtensionIdentifier; agent: vscode.ChatAgent }>();\n\tprivate readonly _proxy: MainThreadChatAgentsShape;\n\n\tconstructor(\n\t\tmainContext: IMainContext,\n\t\tprivate readonly _extHostChatProvider: ExtHostChatProvider,\n\t\tprivate readonly _logService: ILogService,\n\t) {\n\t\tthis._proxy = mainContext.getProxy(MainContext.MainThreadChatAgents);\n\t}\n\n\tregisterAgent(extension: ExtensionIdentifier, name: string, agent: vscode.ChatAgent, metadata: vscode.ChatAgentMetadata): IDisposable {\n\t\tconst handle = ExtHostChatAgents._idPool++;\n\t\tthis._agents.set(handle, { extension, agent });\n\t\tthis._proxy.$registerAgent(handle, name, metadata);\n\n\t\treturn toDisposable(() => {\n\t\t\tthis._proxy.$unregisterAgent(handle);\n\t\t\tthis._agents.delete(handle);\n\t\t});\n\t}\n\n\tasync $invokeAgent(handle: number, requestId: number, prompt: string, context: { history: IChatMessage[] }, token: CancellationToken): Promise<any> {\n\t\tconst data = this._agents.get(handle);\n\t\tif (!data) {\n\t\t\tthis._logService.warn(`[CHAT](${handle}) CANNOT invoke agent because the agent is not registered`);\n\t\t\treturn;\n\t\t}\n\n\t\tlet done = false;\n\t\tfunction throwIfDone() {\n\t\t\tif (done) {\n\t\t\t\tthrow new Error('Only valid while executing the command');\n\t\t\t}\n\t\t}\n\n\t\tconst commandExecution = new DeferredPromise<void>();\n\t\ttoken.onCancellationRequested(() => commandExecution.complete());\n\t\tsetTimeout(() => commandExecution.complete(), 3 * 1000);\n\t\tthis._extHostChatProvider.allowListExtensionWhile(data.extension, commandExecution.p);\n\n\t\tconst task = data.agent(\n\t\t\t{ role: ChatMessageRole.User, content: prompt },\n\t\t\t{ history: context.history.map(typeConvert.ChatMessage.to) },\n\t\t\tnew Progress<vscode.ChatAgentResponse>(p => {\n\t\t\t\tthrowIfDone();\n\t\t\t\tthis._proxy.$handleProgressChunk(requestId, { content: isInteractiveProgressFileTree(p.message) ? p.message : p.message.value });\n\t\t\t}),\n\t\t\ttoken\n\t\t);\n\n\t\ttry {\n\t\t\treturn await raceCancellation(Promise.resolve(task).then((v) => {\n\t\t\t\tif (v && 'followUp' in v) {\n\t\t\t\t\tconst convertedFollowup = v?.followUp?.map(f => typeConvert.ChatFollowup.from(f));\n\t\t\t\t\treturn { followUp: convertedFollowup };\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t}), token);\n\t\t} finally {\n\t\t\tdone = true;\n\t\t\tcommandExecution.complete();\n\t\t}\n\t}\n}\n\nfunction isInteractiveProgressFileTree(thing: unknown): thing is vscode.InteractiveProgressFileTree {\n\treturn !!thing && typeof thing === 'object' && 'treeData' in thing;\n}\n"]}