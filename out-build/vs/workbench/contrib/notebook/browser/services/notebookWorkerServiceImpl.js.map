{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/contrib/notebook/browser/services/notebookWorkerServiceImpl.ts"],"names":[],"mappings":"AAAA;;;gGAGgG;;;;;;;;;;;;;;IAazF,IAAM,IAAI,GAAV,MAAM,IAAgC,SAAQ,eAAG;QAKvD,YACmB,eAAqB;YAEvC,KAAK,EAAE,CAAC;YAER,IAAI,CAAC,CAAC,GAAgB,IAAI,CAAC,CAAC,CAAS,IAAI,aAAa,CAAC,eAAe,CAAC,CAAC,CAAC;QAC1E,CAAC;QACD,cAAc,CAAC,QAAa,EAAE,QAAa;YAC1C,MAAM,IAAI,KAAK,CAAC,yBAAyB,CAAC,CAAC;QAC5C,CAAC;QAED,WAAW,CAAC,QAAa,EAAE,QAAa;YACvC,OAAO,IAAI,CAAC,CAAC,CAAc,UAAU,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;gBACrD,OAAO,MAAM,CAAC,WAAW,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;YAC/C,CAAC,CAAC,CAAC;QACJ,CAAC;QAED,uBAAuB,CAAC,KAAU;YACjC,OAAO,IAAI,CAAC,CAAC,CAAc,UAAU,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC,EAAE;gBACrD,OAAO,MAAM,CAAC,uBAAuB,CAAC,KAAK,CAAC,CAAC;YAC9C,CAAC,CAAC,CAAC;QACJ,CAAC;KACD,CAAA;IA3BY,oBAAI;mBAAJ,IAAI;QAMd,WAAA,sBAAI,CAAA;OANM,IAAI,CA2BhB;IAED,MAAM,aAAc,SAAQ,eAAG;QAE9B,uCAAuC;QAEvC,YACkB,CAAsB;YAEvC,KAAK,EAAE,CAAC;YAFS,MAAC,GAAD,CAAC,CAAqB;YAGvC,IAAI,CAAC,CAAC,GAAqB,IAAI,CAAC;YAChC,qDAAqD;QACtD,CAAC;QAED,UAAU;YACT,qDAAqD;YACrD,IAAI,CAAC,IAAI,CAAC,CAAC,EAAoB;gBAC9B,IAAI,CAAC,CAAC,GAAqB,IAAI,oBAAoB,CAAC,IAAI,CAAC,CAAC,EAAiB,6BAA6B,CAAC,CAAC;aAC1G;YACD,OAAO,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAmB,CAAC;QAClD,CAAC;KACD;IAOD,MAAM,0BAA2B,SAAQ,eAAG;QAI3C,YACkB,CAAkC,EAClC,CAAsB;YAEvC,KAAK,EAAE,CAAC;YAHS,MAAC,GAAD,CAAC,CAAiC;YAClC,MAAC,GAAD,CAAC,CAAqB;YALhC,MAAC,GAAoD,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;YACzE,MAAC,GAA2D,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;QAOxF,CAAC;QAEM,qBAAqB,CAAC,SAAgB;YAC5C,KAAK,MAAM,QAAQ,IAAI,SAAS,EAAE;gBACjC,MAAM,WAAW,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;gBAExC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAa,WAAW,CAAC,EAAE;oBACrC,IAAI,CAAC,CAAC,CAAe,QAAQ,CAAC,CAAC;iBAC/B;gBACD,IAAI,IAAI,CAAC,CAAC,CAAa,WAAW,CAAC,EAAE;oBACpC,IAAI,CAAC,CAAC,CAAyB,WAAW,CAAC,GAAG,CAAC,IAAI,IAAI,EAAE,CAAC,CAAC,OAAO,EAAE,CAAC;iBACrE;aACD;QACF,CAAC;QAEO,CAAC,CAAe,QAAa;YACpC,MAAM,KAAK,GAAG,IAAI,CAAC,CAAC,CAAgB,qBAAqB,EAAE,CAAC,IAAI,CAAC,QAAQ,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,CAAC,QAAQ,EAAE,KAAK,QAAQ,CAAC,QAAQ,EAAE,CAAC,CAAC;YAC9H,IAAI,CAAC,KAAK,EAAE;gBACX,OAAO;aACP;YAED,MAAM,QAAQ,GAAG,QAAQ,CAAC,QAAQ,EAAE,CAAC;YAErC,IAAI,CAAC,CAAC,CAAM,cAAc,CACzB,KAAK,CAAC,GAAG,CAAC,QAAQ,EAAE,EACpB;gBACC,KAAK,EAAE,KAAK,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;oBAC/B,MAAM,EAAE,IAAI,CAAC,MAAM;oBACnB,GAAG,EAAE,IAAI,CAAC,GAAG;oBACb,MAAM,EAAE,IAAI,CAAC,QAAQ,EAAE;oBACvB,GAAG,EAAE,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE;oBAC7B,QAAQ,EAAE,IAAI,CAAC,QAAQ;oBACvB,IAAI,EAAE,IAAI,CAAC,IAAI;oBACf,QAAQ,EAAE,IAAI,CAAC,QAAQ;oBACvB,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,EAAE,QAAQ,EAAE,EAAE,CAAC,QAAQ,EAAE,OAAO,EAAE,EAAE,CAAC,OAAO,EAAE,CAAC,CAAC;oBACjF,QAAQ,EAAE,IAAI,CAAC,QAAQ;oBACvB,gBAAgB,EAAE,IAAI,CAAC,gBAAgB;iBACvC,CAAC,CAAC;gBACH,QAAQ,EAAE,KAAK,CAAC,QAAQ;aACxB,CACD,CAAC;YAEF,MAAM,SAAS,GAAG,IAAI,eAAG,EAAc,CAAC;YAExC,MAAM,SAAS,GAAG,CAAC,IAAS,EAAkC,EAAE;gBAC/D,OAAO;oBACN,MAAM,EAAE,IAAI,CAAC,MAAM;oBACnB,GAAG,EAAE,IAAI,CAAC,GAAG;oBACb,MAAM,EAAE,IAAI,CAAC,UAAU,CAAC,eAAe,EAAE;oBACzC,GAAG,EAAE,IAAI,CAAC,UAAU,CAAC,MAAM,EAAE;oBAC7B,QAAQ,EAAE,IAAI,CAAC,QAAQ;oBACvB,QAAQ,EAAE,IAAI,CAAC,QAAQ;oBACvB,OAAO,EAAE,IAAI,CAAC,OAAO,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,CAAC,CAAC,EAAE,QAAQ,EAAE,EAAE,CAAC,QAAQ,EAAE,OAAO,EAAE,EAAE,CAAC,OAAO,EAAE,CAAC,CAAC;oBACjF,QAAQ,EAAE,IAAI,CAAC,QAAQ;oBACvB,gBAAgB,EAAE,IAAI,CAAC,gBAAgB;iBACvC,CAAC;YACH,CAAC,CAAC;YAEF,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,kBAAkB,CAAC,CAAC,KAAK,EAAE,EAAE;gBAChD,MAAM,GAAG,GAAG,KAAK,CAAC,SAAS,CAAC,GAAG,CAAC,CAAC,CAAC,EAAE;oBACnC,MAAM,IAAI,GACT,CAAC,CAAC,IAAI,KAAK,wCAAuB,CAAC,WAAW,IAAI,CAAC,CAAC,IAAI,KAAK,wCAAuB,CAAC,UAAU;wBAC9F,CAAC,CAAC;4BACD,IAAI,EAAE,CAAC,CAAC,IAAI;4BACZ,SAAS,EAAE,KAAK,CAAC,SAAS;4BAC1B,OAAO,EAAE,CAAC,CAAC,OAAO,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,SAAS,CAAC,IAAW,CAAmB,CAAC,CAAqC,CAAC;yBACrJ;wBACD,CAAC,CAAC,CACD,CAAC,CAAC,IAAI,KAAK,wCAAuB,CAAC,IAAI;4BACtC,CAAC,CAAC;gCACD,IAAI,EAAE,CAAC,CAAC,IAAI;gCACZ,KAAK,EAAE,CAAC,CAAC,KAAK;gCACd,MAAM,EAAE,CAAC,CAAC,MAAM;gCAChB,MAAM,EAAE,CAAC,CAAC,MAAM;gCAChB,SAAS,EAAE,KAAK,CAAC,SAAS;gCAC1B,KAAK,EAAE,CAAC,CAAC,KAAK,CAAC,GAAG,CAAC,IAAI,CAAC,EAAE,CAAC,SAAS,CAAC,IAAW,CAAmB,CAAC;6BACpE;4BACD,CAAC,CAAC,CAAC,CACJ,CAAC;oBAEJ,OAAO,IAAI,CAAC;gBACb,CAAC,CAAC,CAAC;gBAEH,IAAI,CAAC,CAAC,CAAM,kBAAkB,CAAC,QAAQ,CAAC,QAAQ,EAAE,EAAE;oBACnD,SAAS,EAAE,GAAG;oBACd,SAAS,EAAE,KAAK,CAAC,SAAS;iBAC1B,CAAC,CAAC;YACJ,CAAC,CAAC,CAAC,CAAC;YAEJ,SAAS,CAAC,GAAG,CAAC,KAAK,CAAC,aAAa,CAAC,GAAG,EAAE;gBACtC,IAAI,CAAC,CAAC,CAAc,QAAQ,CAAC,CAAC;YAC/B,CAAC,CAAC,CAAC,CAAC;YACJ,SAAS,CAAC,GAAG,CAAC,IAAA,eAAG,EAAU,GAAG,EAAE;gBAC/B,IAAI,CAAC,CAAC,CAAM,kBAAkB,CAAC,QAAQ,CAAC,CAAC;YAC1C,CAAC,CAAC,CAAC,CAAC;YAEJ,IAAI,CAAC,CAAC,CAAa,QAAQ,CAAC,GAAG,SAAS,CAAC;QAC1C,CAAC;QAEO,CAAC,CAAc,QAAgB;YACtC,MAAM,SAAS,GAAG,IAAI,CAAC,CAAC,CAAa,QAAQ,CAAC,CAAC;YAC/C,OAAO,IAAI,CAAC,CAAC,CAAa,QAAQ,CAAC,CAAC;YACpC,OAAO,IAAI,CAAC,CAAC,CAAyB,QAAQ,CAAC,CAAC;YAChD,IAAA,eAAG,EAAK,SAAS,CAAC,CAAC;QACpB,CAAC;KACD;IAED,MAAM,kBAAkB;QAIvB,YAAY,YAAkC;YAC7C,IAAI,CAAC,CAAC,GAAe,YAAY,CAAC;QACnC,CAAC;QAED,uBAAuB;QAChB,GAAG,CAAC,MAAc,EAAE,IAAW;YACrC,OAAO,IAAI,CAAC,CAAC,CAAa,GAAG,CAAC,MAAM,EAAE,IAAI,CAAC,CAAC;QAC7C,CAAC;KACD;IAED,MAAM,oBAAqB,SAAQ,eAAG;QAMrC,YAA6B,CAAsB,EAAc,KAAa;YAC7E,KAAK,EAAE,CAAC;YADoB,MAAC,GAAD,CAAC,CAAqB;YAElD,IAAI,CAAC,CAAC,GAAgB,IAAI,0BAAG,CAAkB,KAAK,CAAC,CAAC;YACtD,IAAI,CAAC,CAAC,GAAS,IAAI,CAAC;YACpB,IAAI,CAAC,CAAC,GAAe,IAAI,CAAC;QAE3B,CAAC;QAED,uBAAuB;QAChB,GAAG,CAAC,MAAc,EAAE,IAAW;YACrC,MAAM,IAAI,KAAK,CAAC,kBAAkB,CAAC,CAAC;QACrC,CAAC;QAED,WAAW,CAAC,QAAa,EAAE,QAAa;YACvC,OAAO,IAAI,CAAC,CAAC,CAAoB,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;gBACnE,OAAO,KAAK,CAAC,WAAW,CAAC,QAAQ,CAAC,QAAQ,EAAE,EAAE,QAAQ,CAAC,QAAQ,EAAE,CAAC,CAAC;YACpE,CAAC,CAAC,CAAC;QACJ,CAAC;QAED,uBAAuB,CAAC,QAAa;YACpC,OAAO,IAAI,CAAC,CAAC,CAAoB,CAAC,QAAQ,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,EAAE;gBACzD,OAAO,KAAK,CAAC,uBAAuB,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC,CAAC;YAC3D,CAAC,CAAC,CAAC;QACJ,CAAC;QAEO,CAAC,CAAwB,KAAiC;YACjE,IAAI,CAAC,IAAI,CAAC,CAAC,EAAc;gBACxB,IAAI,CAAC,CAAC,GAAe,IAAI,CAAC,CAAC,CAAS,IAAI,0BAA0B,CAAC,KAAK,EAAE,IAAI,CAAC,CAAC,CAAgB,CAAC,CAAC;aAClG;YACD,OAAO,IAAI,CAAC,CAAC,CAAa;QAC3B,CAAC;QAES,CAAC,CAAoB,SAAgB;YAC9C,OAAO,IAAI,CAAC,CAAC,EAAU,CAAC,IAAI,CAAC,CAAC,KAAK,EAAE,EAAE;gBACtC,IAAI,CAAC,CAAC,CAAwB,KAAK,CAAC,CAAC,qBAAqB,CAAC,SAAS,CAAC,CAAC;gBACtE,OAAO,KAAK,CAAC;YACd,CAAC,CAAC,CAAC;QACJ,CAAC;QAEO,CAAC;YACR,IAAI,CAAC,IAAI,CAAC,CAAC,EAAQ;gBAClB,IAAI;oBACH,IAAI,CAAC,CAAC,GAAS,IAAI,CAAC,CAAC,CAAS,IAAI,iCAAkB,CACnD,IAAI,CAAC,CAAC,EACN,oEAAoE,EACpE,IAAI,kBAAkB,CAAC,IAAI,CAAC,CAC5B,CAAC,CAAC;iBACH;gBAAC,OAAO,GAAG,EAAE;oBACb,gCAAgC;oBAChC,wGAAwG;oBACxG,MAAM,CAAC,GAAG,CAAC,CAAC;iBACZ;aACD;YACD,OAAO,IAAI,CAAC,CAAC,CAAO;QACrB,CAAC;QAES,CAAC;YACV,OAAO,IAAI,CAAC,CAAC,EAAmB,CAAC,cAAc,EAAE,CAAC,IAAI,CAAC,SAAS,EAAE,CAAC,GAAG,EAAE,EAAE;gBACzE,gCAAgC;gBAChC,wGAAwG;gBACxG,qDAAqD;gBACrD,MAAM,CAAC,GAAG,CAAC,CAAC;YACb,CAAC,CAAC,CAAC;QACJ,CAAC;KAGD","file":"notebookWorkerServiceImpl.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable, DisposableStore, dispose, IDisposable, toDisposable } from 'vs/base/common/lifecycle';\nimport { URI } from 'vs/base/common/uri';\nimport { SimpleWorkerClient } from 'vs/base/common/worker/simpleWorker';\nimport { DefaultWorkerFactory } from 'vs/base/browser/defaultWorkerFactory';\nimport { NotebookCellTextModel } from 'vs/workbench/contrib/notebook/common/model/notebookCellTextModel';\nimport { IMainCellDto, INotebookDiffResult, NotebookCellsChangeType } from 'vs/workbench/contrib/notebook/common/notebookCommon';\nimport { INotebookService } from 'vs/workbench/contrib/notebook/common/notebookService';\nimport { NotebookEditorSimpleWorker } from 'vs/workbench/contrib/notebook/common/services/notebookSimpleWorker';\nimport { INotebookWorkerHost } from 'vs/workbench/contrib/notebook/common/services/notebookWorkerHost';\nimport { INotebookEditorWorkerService } from 'vs/workbench/contrib/notebook/common/services/notebookWorkerService';\n\nexport class NotebookEditorWorkerServiceImpl extends Disposable implements INotebookEditorWorkerService {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _workerManager: WorkerManager;\n\n\tconstructor(\n\t\t@INotebookService notebookService: INotebookService\n\t) {\n\t\tsuper();\n\n\t\tthis._workerManager = this._register(new WorkerManager(notebookService));\n\t}\n\tcanComputeDiff(original: URI, modified: URI): boolean {\n\t\tthrow new Error('Method not implemented.');\n\t}\n\n\tcomputeDiff(original: URI, modified: URI): Promise<INotebookDiffResult> {\n\t\treturn this._workerManager.withWorker().then(client => {\n\t\t\treturn client.computeDiff(original, modified);\n\t\t});\n\t}\n\n\tcanPromptRecommendation(model: URI): Promise<boolean> {\n\t\treturn this._workerManager.withWorker().then(client => {\n\t\t\treturn client.canPromptRecommendation(model);\n\t\t});\n\t}\n}\n\nclass WorkerManager extends Disposable {\n\tprivate _editorWorkerClient: NotebookWorkerClient | null;\n\t// private _lastWorkerUsedTime: number;\n\n\tconstructor(\n\t\tprivate readonly _notebookService: INotebookService\n\t) {\n\t\tsuper();\n\t\tthis._editorWorkerClient = null;\n\t\t// this._lastWorkerUsedTime = (new Date()).getTime();\n\t}\n\n\twithWorker(): Promise<NotebookWorkerClient> {\n\t\t// this._lastWorkerUsedTime = (new Date()).getTime();\n\t\tif (!this._editorWorkerClient) {\n\t\t\tthis._editorWorkerClient = new NotebookWorkerClient(this._notebookService, 'notebookEditorWorkerService');\n\t\t}\n\t\treturn Promise.resolve(this._editorWorkerClient);\n\t}\n}\n\ninterface IWorkerClient<W> {\n\tgetProxyObject(): Promise<W>;\n\tdispose(): void;\n}\n\nclass NotebookEditorModelManager extends Disposable {\n\tprivate _syncedModels: { [modelUrl: string]: IDisposable } = Object.create(null);\n\tprivate _syncedModelsLastUsedTime: { [modelUrl: string]: number } = Object.create(null);\n\n\tconstructor(\n\t\tprivate readonly _proxy: NotebookEditorSimpleWorker,\n\t\tprivate readonly _notebookService: INotebookService\n\t) {\n\t\tsuper();\n\t}\n\n\tpublic ensureSyncedResources(resources: URI[]): void {\n\t\tfor (const resource of resources) {\n\t\t\tconst resourceStr = resource.toString();\n\n\t\t\tif (!this._syncedModels[resourceStr]) {\n\t\t\t\tthis._beginModelSync(resource);\n\t\t\t}\n\t\t\tif (this._syncedModels[resourceStr]) {\n\t\t\t\tthis._syncedModelsLastUsedTime[resourceStr] = (new Date()).getTime();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _beginModelSync(resource: URI): void {\n\t\tconst model = this._notebookService.listNotebookDocuments().find(document => document.uri.toString() === resource.toString());\n\t\tif (!model) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst modelUrl = resource.toString();\n\n\t\tthis._proxy.acceptNewModel(\n\t\t\tmodel.uri.toString(),\n\t\t\t{\n\t\t\t\tcells: model.cells.map(cell => ({\n\t\t\t\t\thandle: cell.handle,\n\t\t\t\t\turi: cell.uri,\n\t\t\t\t\tsource: cell.getValue(),\n\t\t\t\t\teol: cell.textBuffer.getEOL(),\n\t\t\t\t\tlanguage: cell.language,\n\t\t\t\t\tmime: cell.mime,\n\t\t\t\t\tcellKind: cell.cellKind,\n\t\t\t\t\toutputs: cell.outputs.map(op => ({ outputId: op.outputId, outputs: op.outputs })),\n\t\t\t\t\tmetadata: cell.metadata,\n\t\t\t\t\tinternalMetadata: cell.internalMetadata,\n\t\t\t\t})),\n\t\t\t\tmetadata: model.metadata\n\t\t\t}\n\t\t);\n\n\t\tconst toDispose = new DisposableStore();\n\n\t\tconst cellToDto = (cell: NotebookCellTextModel): IMainCellDto => {\n\t\t\treturn {\n\t\t\t\thandle: cell.handle,\n\t\t\t\turi: cell.uri,\n\t\t\t\tsource: cell.textBuffer.getLinesContent(),\n\t\t\t\teol: cell.textBuffer.getEOL(),\n\t\t\t\tlanguage: cell.language,\n\t\t\t\tcellKind: cell.cellKind,\n\t\t\t\toutputs: cell.outputs.map(op => ({ outputId: op.outputId, outputs: op.outputs })),\n\t\t\t\tmetadata: cell.metadata,\n\t\t\t\tinternalMetadata: cell.internalMetadata,\n\t\t\t};\n\t\t};\n\n\t\ttoDispose.add(model.onDidChangeContent((event) => {\n\t\t\tconst dto = event.rawEvents.map(e => {\n\t\t\t\tconst data =\n\t\t\t\t\te.kind === NotebookCellsChangeType.ModelChange || e.kind === NotebookCellsChangeType.Initialize\n\t\t\t\t\t\t? {\n\t\t\t\t\t\t\tkind: e.kind,\n\t\t\t\t\t\t\tversionId: event.versionId,\n\t\t\t\t\t\t\tchanges: e.changes.map(diff => [diff[0], diff[1], diff[2].map(cell => cellToDto(cell as NotebookCellTextModel))] as [number, number, IMainCellDto[]])\n\t\t\t\t\t\t}\n\t\t\t\t\t\t: (\n\t\t\t\t\t\t\te.kind === NotebookCellsChangeType.Move\n\t\t\t\t\t\t\t\t? {\n\t\t\t\t\t\t\t\t\tkind: e.kind,\n\t\t\t\t\t\t\t\t\tindex: e.index,\n\t\t\t\t\t\t\t\t\tlength: e.length,\n\t\t\t\t\t\t\t\t\tnewIdx: e.newIdx,\n\t\t\t\t\t\t\t\t\tversionId: event.versionId,\n\t\t\t\t\t\t\t\t\tcells: e.cells.map(cell => cellToDto(cell as NotebookCellTextModel))\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t: e\n\t\t\t\t\t\t);\n\n\t\t\t\treturn data;\n\t\t\t});\n\n\t\t\tthis._proxy.acceptModelChanged(modelUrl.toString(), {\n\t\t\t\trawEvents: dto,\n\t\t\t\tversionId: event.versionId\n\t\t\t});\n\t\t}));\n\n\t\ttoDispose.add(model.onWillDispose(() => {\n\t\t\tthis._stopModelSync(modelUrl);\n\t\t}));\n\t\ttoDispose.add(toDisposable(() => {\n\t\t\tthis._proxy.acceptRemovedModel(modelUrl);\n\t\t}));\n\n\t\tthis._syncedModels[modelUrl] = toDispose;\n\t}\n\n\tprivate _stopModelSync(modelUrl: string): void {\n\t\tconst toDispose = this._syncedModels[modelUrl];\n\t\tdelete this._syncedModels[modelUrl];\n\t\tdelete this._syncedModelsLastUsedTime[modelUrl];\n\t\tdispose(toDispose);\n\t}\n}\n\nclass NotebookWorkerHost implements INotebookWorkerHost {\n\n\tprivate readonly _workerClient: NotebookWorkerClient;\n\n\tconstructor(workerClient: NotebookWorkerClient) {\n\t\tthis._workerClient = workerClient;\n\t}\n\n\t// foreign host request\n\tpublic fhr(method: string, args: any[]): Promise<any> {\n\t\treturn this._workerClient.fhr(method, args);\n\t}\n}\n\nclass NotebookWorkerClient extends Disposable {\n\tprivate _worker: IWorkerClient<NotebookEditorSimpleWorker> | null;\n\tprivate readonly _workerFactory: DefaultWorkerFactory;\n\tprivate _modelManager: NotebookEditorModelManager | null;\n\n\n\tconstructor(private readonly _notebookService: INotebookService, label: string) {\n\t\tsuper();\n\t\tthis._workerFactory = new DefaultWorkerFactory(label);\n\t\tthis._worker = null;\n\t\tthis._modelManager = null;\n\n\t}\n\n\t// foreign host request\n\tpublic fhr(method: string, args: any[]): Promise<any> {\n\t\tthrow new Error(`Not implemented!`);\n\t}\n\n\tcomputeDiff(original: URI, modified: URI) {\n\t\treturn this._withSyncedResources([original, modified]).then(proxy => {\n\t\t\treturn proxy.computeDiff(original.toString(), modified.toString());\n\t\t});\n\t}\n\n\tcanPromptRecommendation(modelUri: URI) {\n\t\treturn this._withSyncedResources([modelUri]).then(proxy => {\n\t\t\treturn proxy.canPromptRecommendation(modelUri.toString());\n\t\t});\n\t}\n\n\tprivate _getOrCreateModelManager(proxy: NotebookEditorSimpleWorker): NotebookEditorModelManager {\n\t\tif (!this._modelManager) {\n\t\t\tthis._modelManager = this._register(new NotebookEditorModelManager(proxy, this._notebookService));\n\t\t}\n\t\treturn this._modelManager;\n\t}\n\n\tprotected _withSyncedResources(resources: URI[]): Promise<NotebookEditorSimpleWorker> {\n\t\treturn this._getProxy().then((proxy) => {\n\t\t\tthis._getOrCreateModelManager(proxy).ensureSyncedResources(resources);\n\t\t\treturn proxy;\n\t\t});\n\t}\n\n\tprivate _getOrCreateWorker(): IWorkerClient<NotebookEditorSimpleWorker> {\n\t\tif (!this._worker) {\n\t\t\ttry {\n\t\t\t\tthis._worker = this._register(new SimpleWorkerClient<NotebookEditorSimpleWorker, NotebookWorkerHost>(\n\t\t\t\t\tthis._workerFactory,\n\t\t\t\t\t'vs/workbench/contrib/notebook/common/services/notebookSimpleWorker',\n\t\t\t\t\tnew NotebookWorkerHost(this)\n\t\t\t\t));\n\t\t\t} catch (err) {\n\t\t\t\t// logOnceWebWorkerWarning(err);\n\t\t\t\t// this._worker = new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this), null));\n\t\t\t\tthrow (err);\n\t\t\t}\n\t\t}\n\t\treturn this._worker;\n\t}\n\n\tprotected _getProxy(): Promise<NotebookEditorSimpleWorker> {\n\t\treturn this._getOrCreateWorker().getProxyObject().then(undefined, (err) => {\n\t\t\t// logOnceWebWorkerWarning(err);\n\t\t\t// this._worker = new SynchronousWorkerClient(new EditorSimpleWorker(new EditorWorkerHost(this), null));\n\t\t\t// return this._getOrCreateWorker().getProxyObject();\n\t\t\tthrow (err);\n\t\t});\n\t}\n\n\n}\n"]}