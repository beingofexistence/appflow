{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/contrib/notebook/browser/view/cellParts/cellComments.ts"],"names":[],"mappings":"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","file":"cellComments.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { coalesce } from 'vs/base/common/arrays';\nimport { DisposableStore } from 'vs/base/common/lifecycle';\nimport { EDITOR_FONT_DEFAULTS, IEditorOptions } from 'vs/editor/common/config/editorOptions';\nimport * as languages from 'vs/editor/common/languages';\nimport { IConfigurationService } from 'vs/platform/configuration/common/configuration';\nimport { IContextKeyService } from 'vs/platform/contextkey/common/contextkey';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { IThemeService } from 'vs/platform/theme/common/themeService';\nimport { ICommentService } from 'vs/workbench/contrib/comments/browser/commentService';\nimport { CommentThreadWidget } from 'vs/workbench/contrib/comments/browser/commentThreadWidget';\nimport { ICellViewModel, INotebookEditorDelegate } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';\nimport { CellContentPart } from 'vs/workbench/contrib/notebook/browser/view/cellPart';\nimport { CodeCellViewModel } from 'vs/workbench/contrib/notebook/browser/viewModel/codeCellViewModel';\nimport { CellKind } from 'vs/workbench/contrib/notebook/common/notebookCommon';\nimport { ICellRange } from 'vs/workbench/contrib/notebook/common/notebookRange';\n\nexport class CellComments extends CellContentPart {\n\tprivate _initialized: boolean = false;\n\tprivate _commentThreadWidget: CommentThreadWidget<ICellRange> | null = null;\n\tprivate currentElement: CodeCellViewModel | undefined;\n\tprivate readonly commentTheadDisposables = this._register(new DisposableStore());\n\n\tconstructor(\n\t\tprivate readonly notebookEditor: INotebookEditorDelegate,\n\t\tprivate readonly container: HTMLElement,\n\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IThemeService private readonly themeService: IThemeService,\n\t\t@ICommentService private readonly commentService: ICommentService,\n\t\t@IConfigurationService private readonly configurationService: IConfigurationService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tthis.container.classList.add('review-widget');\n\n\t\tthis._register(this.themeService.onDidColorThemeChange(this._applyTheme, this));\n\t\t// TODO @rebornix onDidChangeLayout (font change)\n\t\t// this._register(this.notebookEditor.onDidchangeLa)\n\t\tthis._applyTheme();\n\t}\n\n\tprivate async initialize(element: ICellViewModel) {\n\t\tif (this._initialized) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._initialized = true;\n\t\tconst info = await this._getCommentThreadForCell(element);\n\n\t\tif (info) {\n\t\t\tthis._createCommentTheadWidget(info.owner, info.thread);\n\t\t}\n\t}\n\n\tprivate _createCommentTheadWidget(owner: string, commentThread: languages.CommentThread<ICellRange>) {\n\t\tthis._commentThreadWidget?.dispose();\n\t\tthis.commentTheadDisposables.clear();\n\t\tthis._commentThreadWidget = this.instantiationService.createInstance(\n\t\t\tCommentThreadWidget,\n\t\t\tthis.container,\n\t\t\towner,\n\t\t\tthis.notebookEditor.textModel!.uri,\n\t\t\tthis.contextKeyService,\n\t\t\tthis.instantiationService,\n\t\t\tcommentThread,\n\t\t\tundefined,\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tcodeBlockFontFamily: this.configurationService.getValue<IEditorOptions>('editor').fontFamily || EDITOR_FONT_DEFAULTS.fontFamily\n\t\t\t},\n\t\t\tundefined,\n\t\t\t{\n\t\t\t\tactionRunner: () => {\n\t\t\t\t},\n\t\t\t\tcollapse: () => { }\n\t\t\t}\n\t\t) as unknown as CommentThreadWidget<ICellRange>;\n\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tthis._commentThreadWidget.display(layoutInfo.fontInfo.lineHeight);\n\t\tthis._applyTheme();\n\n\t\tthis.commentTheadDisposables.add(this._commentThreadWidget.onDidResize(() => {\n\t\t\tif (this.currentElement?.cellKind === CellKind.Code && this._commentThreadWidget) {\n\t\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.getDimensions().height);\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate _bindListeners() {\n\t\tthis.cellDisposables.add(this.commentService.onDidUpdateCommentThreads(async () => {\n\t\t\tif (this.currentElement) {\n\t\t\t\tconst info = await this._getCommentThreadForCell(this.currentElement);\n\t\t\t\tif (!this._commentThreadWidget && info) {\n\t\t\t\t\tthis._createCommentTheadWidget(info.owner, info.thread);\n\t\t\t\t\tconst layoutInfo = (this.currentElement as CodeCellViewModel).layoutInfo;\n\t\t\t\t\tthis.container.style.top = `${layoutInfo.outputContainerOffset + layoutInfo.outputTotalHeight}px`;\n\t\t\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget!.getDimensions().height);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (this._commentThreadWidget) {\n\t\t\t\t\tif (!info) {\n\t\t\t\t\t\tthis._commentThreadWidget.dispose();\n\t\t\t\t\t\tthis.currentElement.commentHeight = 0;\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tif (this._commentThreadWidget.commentThread === info.thread) {\n\t\t\t\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.getDimensions().height);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tthis._commentThreadWidget.updateCommentThread(info.thread);\n\t\t\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.getDimensions().height);\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate _calculateCommentThreadHeight(bodyHeight: number) {\n\t\tconst layoutInfo = this.notebookEditor.getLayoutInfo();\n\n\t\tconst headHeight = Math.ceil(layoutInfo.fontInfo.lineHeight * 1.2);\n\t\tconst lineHeight = layoutInfo.fontInfo.lineHeight;\n\t\tconst arrowHeight = Math.round(lineHeight / 3);\n\t\tconst frameThickness = Math.round(lineHeight / 9) * 2;\n\n\t\tconst computedHeight = headHeight + bodyHeight + arrowHeight + frameThickness + 8 /** margin bottom to avoid margin collapse */;\n\t\treturn computedHeight;\n\n\t}\n\n\tprivate async _getCommentThreadForCell(element: ICellViewModel): Promise<{ thread: languages.CommentThread<ICellRange>; owner: string } | null> {\n\t\tif (this.notebookEditor.hasModel()) {\n\t\t\tconst commentInfos = coalesce(await this.commentService.getNotebookComments(element.uri));\n\t\t\tif (commentInfos.length && commentInfos[0].threads.length) {\n\t\t\t\treturn { owner: commentInfos[0].owner, thread: commentInfos[0].threads[0] };\n\t\t\t}\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tprivate _applyTheme() {\n\t\tconst theme = this.themeService.getColorTheme();\n\t\tconst fontInfo = this.notebookEditor.getLayoutInfo().fontInfo;\n\t\tthis._commentThreadWidget?.applyTheme(theme, fontInfo);\n\t}\n\n\toverride didRenderCell(element: ICellViewModel): void {\n\t\tif (element.cellKind === CellKind.Code) {\n\t\t\tthis.currentElement = element as CodeCellViewModel;\n\t\t\tthis.initialize(element);\n\t\t\tthis._bindListeners();\n\t\t}\n\n\t}\n\n\toverride prepareLayout(): void {\n\t\tif (this.currentElement?.cellKind === CellKind.Code && this._commentThreadWidget) {\n\t\t\tthis.currentElement.commentHeight = this._calculateCommentThreadHeight(this._commentThreadWidget.getDimensions().height);\n\t\t}\n\t}\n\n\toverride updateInternalLayoutNow(element: ICellViewModel): void {\n\t\tif (this.currentElement?.cellKind === CellKind.Code && this._commentThreadWidget) {\n\t\t\tconst layoutInfo = (element as CodeCellViewModel).layoutInfo;\n\t\t\tthis.container.style.top = `${layoutInfo.outputContainerOffset + layoutInfo.outputTotalHeight}px`;\n\t\t}\n\t}\n}\n\n"]}