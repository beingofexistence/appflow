{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/contrib/notebook/browser/contrib/viewportWarmup/viewportWarmup.ts"],"names":[],"mappings":"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","file":"viewportWarmup.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { RunOnceScheduler } from 'vs/base/common/async';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { IAccessibilityService } from 'vs/platform/accessibility/common/accessibility';\nimport { CellEditState, IInsetRenderOutput, INotebookEditor, INotebookEditorContribution, INotebookEditorDelegate, RenderOutputType } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';\nimport { registerNotebookContribution } from 'vs/workbench/contrib/notebook/browser/notebookEditorExtensions';\nimport { CodeCellViewModel, outputDisplayLimit } from 'vs/workbench/contrib/notebook/browser/viewModel/codeCellViewModel';\nimport { CellKind } from 'vs/workbench/contrib/notebook/common/notebookCommon';\nimport { cellRangesToIndexes } from 'vs/workbench/contrib/notebook/common/notebookRange';\nimport { INotebookService } from 'vs/workbench/contrib/notebook/common/notebookService';\n\nclass NotebookViewportContribution extends Disposable implements INotebookEditorContribution {\n\tstatic id: string = 'workbench.notebook.viewportWarmup';\n\tprivate readonly _warmupViewport: RunOnceScheduler;\n\tprivate readonly _warmupDocument: RunOnceScheduler | null = null;\n\n\tconstructor(\n\t\tprivate readonly _notebookEditor: INotebookEditor,\n\t\t@INotebookService private readonly _notebookService: INotebookService,\n\t\t@IAccessibilityService accessibilityService: IAccessibilityService,\n\t) {\n\t\tsuper();\n\n\t\tthis._warmupViewport = new RunOnceScheduler(() => this._warmupViewportNow(), 200);\n\t\tthis._register(this._warmupViewport);\n\t\tthis._register(this._notebookEditor.onDidScroll(() => {\n\t\t\tthis._warmupViewport.schedule();\n\t\t}));\n\n\t\tthis._warmupDocument = new RunOnceScheduler(() => this._warmupDocumentNow(), 200);\n\t\tthis._register(this._warmupDocument);\n\t\tthis._register(this._notebookEditor.onDidAttachViewModel(() => {\n\t\t\tif (this._notebookEditor.hasModel()) {\n\t\t\t\tthis._warmupDocument?.schedule();\n\t\t\t}\n\t\t}));\n\n\t\tif (this._notebookEditor.hasModel()) {\n\t\t\tthis._warmupDocument?.schedule();\n\t\t}\n\t}\n\n\tprivate _warmupDocumentNow() {\n\t\tif (this._notebookEditor.hasModel()) {\n\t\t\tfor (let i = 0; i < this._notebookEditor.getLength(); i++) {\n\t\t\t\tconst cell = this._notebookEditor.cellAt(i);\n\n\t\t\t\tif (cell?.cellKind === CellKind.Markup && cell?.getEditState() === CellEditState.Preview && !cell.isInputCollapsed) {\n\t\t\t\t\t// TODO@rebornix currently we disable markdown cell rendering in webview for accessibility\n\t\t\t\t\t// this._notebookEditor.createMarkupPreview(cell);\n\t\t\t\t} else if (cell?.cellKind === CellKind.Code) {\n\t\t\t\t\tthis._warmupCodeCell((cell as CodeCellViewModel));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _warmupViewportNow() {\n\t\tif (this._notebookEditor.isDisposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this._notebookEditor.hasModel()) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst visibleRanges = this._notebookEditor.getVisibleRangesPlusViewportAboveAndBelow();\n\t\tcellRangesToIndexes(visibleRanges).forEach(index => {\n\t\t\tconst cell = this._notebookEditor.cellAt(index);\n\n\t\t\tif (cell?.cellKind === CellKind.Markup && cell?.getEditState() === CellEditState.Preview && !cell.isInputCollapsed) {\n\t\t\t\t(this._notebookEditor as INotebookEditorDelegate).createMarkupPreview(cell);\n\t\t\t} else if (cell?.cellKind === CellKind.Code) {\n\t\t\t\tthis._warmupCodeCell((cell as CodeCellViewModel));\n\t\t\t}\n\t\t});\n\t}\n\n\tprivate _warmupCodeCell(viewCell: CodeCellViewModel) {\n\t\tif (viewCell.isOutputCollapsed) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst outputs = viewCell.outputsViewModels;\n\t\tfor (const output of outputs.slice(0, outputDisplayLimit)) {\n\t\t\tconst [mimeTypes, pick] = output.resolveMimeTypes(this._notebookEditor.textModel!, undefined);\n\t\t\tif (!mimeTypes.find(mimeType => mimeType.isTrusted) || mimeTypes.length === 0) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tconst pickedMimeTypeRenderer = mimeTypes[pick];\n\n\t\t\tif (!pickedMimeTypeRenderer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this._notebookEditor.hasModel()) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst renderer = this._notebookService.getRendererInfo(pickedMimeTypeRenderer.rendererId);\n\n\t\t\tif (!renderer) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst result: IInsetRenderOutput = { type: RenderOutputType.Extension, renderer, source: output, mimeType: pickedMimeTypeRenderer.mimeType };\n\t\t\tthis._notebookEditor.createOutput(viewCell, result, 0, true);\n\t\t}\n\n\t}\n}\n\nregisterNotebookContribution(NotebookViewportContribution.id, NotebookViewportContribution);\n"]}