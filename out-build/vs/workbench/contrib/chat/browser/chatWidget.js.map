{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/contrib/chat/browser/chatWidget.ts"],"names":[],"mappings":"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","file":"chatWidget.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from 'vs/base/browser/dom';\nimport { ITreeContextMenuEvent, ITreeElement } from 'vs/base/browser/ui/tree/tree';\nimport { disposableTimeout } from 'vs/base/common/async';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { Emitter } from 'vs/base/common/event';\nimport { Disposable, DisposableStore, IDisposable, MutableDisposable, combinedDisposable, toDisposable } from 'vs/base/common/lifecycle';\nimport { isEqual } from 'vs/base/common/resources';\nimport { URI } from 'vs/base/common/uri';\nimport 'vs/css!./media/chat';\nimport { ICodeEditor } from 'vs/editor/browser/editorBrowser';\nimport { MenuId } from 'vs/platform/actions/common/actions';\nimport { IContextKey, IContextKeyService } from 'vs/platform/contextkey/common/contextkey';\nimport { IContextMenuService } from 'vs/platform/contextview/browser/contextView';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { ServiceCollection } from 'vs/platform/instantiation/common/serviceCollection';\nimport { WorkbenchObjectTree } from 'vs/platform/list/browser/listService';\nimport { IViewsService } from 'vs/workbench/common/views';\nimport { ChatTreeItem, IChatAccessibilityService, IChatCodeBlockInfo, IChatFileTreeInfo, IChatWidget, IChatWidgetService, IChatWidgetViewContext } from 'vs/workbench/contrib/chat/browser/chat';\nimport { ChatInputPart } from 'vs/workbench/contrib/chat/browser/chatInputPart';\nimport { ChatAccessibilityProvider, ChatListDelegate, ChatListItemRenderer, IChatListItemRendererOptions, IChatRendererDelegate } from 'vs/workbench/contrib/chat/browser/chatListRenderer';\nimport { ChatEditorOptions } from 'vs/workbench/contrib/chat/browser/chatOptions';\nimport { ChatViewPane } from 'vs/workbench/contrib/chat/browser/chatViewPane';\nimport { CONTEXT_CHAT_REQUEST_IN_PROGRESS, CONTEXT_IN_CHAT_LIST, CONTEXT_IN_CHAT_SESSION } from 'vs/workbench/contrib/chat/common/chatContextKeys';\nimport { IChatContributionService } from 'vs/workbench/contrib/chat/common/chatContributionService';\nimport { IChatModel } from 'vs/workbench/contrib/chat/common/chatModel';\nimport { IChatReplyFollowup, IChatService, ISlashCommand } from 'vs/workbench/contrib/chat/common/chatService';\nimport { ChatViewModel, IChatResponseViewModel, isRequestVM, isResponseVM, isWelcomeVM } from 'vs/workbench/contrib/chat/common/chatViewModel';\n\nconst $ = dom.$;\n\nfunction revealLastElement(list: WorkbenchObjectTree<any>) {\n\tlist.scrollTop = list.scrollHeight - list.renderHeight;\n}\n\nexport interface IViewState {\n\tinputValue?: string;\n\t// renderData\n}\n\nexport interface IChatWidgetStyles {\n\tlistForeground: string;\n\tlistBackground: string;\n\tinputEditorBackground: string;\n\tresultEditorBackground: string;\n}\n\nexport class ChatWidget extends Disposable implements IChatWidget {\n\tpublic static readonly CONTRIBS: { new(...args: [IChatWidget, ...any]): any }[] = [];\n\n\tprivate _onDidFocus = this._register(new Emitter<void>());\n\treadonly onDidFocus = this._onDidFocus.event;\n\n\tprivate _onDidChangeViewModel = this._register(new Emitter<void>());\n\treadonly onDidChangeViewModel = this._onDidChangeViewModel.event;\n\n\tprivate _onDidClear = this._register(new Emitter<void>());\n\treadonly onDidClear = this._onDidClear.event;\n\n\tprivate _onDidAcceptInput = this._register(new Emitter<void>());\n\treadonly onDidAcceptInput = this._onDidAcceptInput.event;\n\n\tprivate _onDidChangeHeight = this._register(new Emitter<number>());\n\treadonly onDidChangeHeight = this._onDidChangeHeight.event;\n\n\tprivate tree!: WorkbenchObjectTree<ChatTreeItem>;\n\tprivate renderer!: ChatListItemRenderer;\n\n\tprivate inputPart!: ChatInputPart;\n\tprivate editorOptions!: ChatEditorOptions;\n\n\tprivate listContainer!: HTMLElement;\n\tprivate container!: HTMLElement;\n\n\tprivate bodyDimension: dom.Dimension | undefined;\n\tprivate visibleChangeCount = 0;\n\tprivate requestInProgress: IContextKey<boolean>;\n\tprivate _visible = false;\n\tpublic get visible() {\n\t\treturn this._visible;\n\t}\n\n\tprivate previousTreeScrollHeight: number = 0;\n\n\tprivate viewModelDisposables = this._register(new DisposableStore());\n\tprivate _viewModel: ChatViewModel | undefined;\n\tprivate set viewModel(viewModel: ChatViewModel | undefined) {\n\t\tif (this._viewModel === viewModel) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.viewModelDisposables.clear();\n\n\t\tthis._viewModel = viewModel;\n\t\tif (viewModel) {\n\t\t\tthis.viewModelDisposables.add(viewModel);\n\t\t}\n\n\t\tthis.slashCommandsPromise = undefined;\n\t\tthis.lastSlashCommands = undefined;\n\n\t\tthis.getSlashCommands().then(() => {\n\t\t\tif (!this._isDisposed) {\n\t\t\t\tthis.onDidChangeItems();\n\t\t\t}\n\t\t});\n\n\t\tthis._onDidChangeViewModel.fire();\n\t}\n\n\tget viewModel() {\n\t\treturn this._viewModel;\n\t}\n\n\tprivate lastSlashCommands: ISlashCommand[] | undefined;\n\tprivate slashCommandsPromise: Promise<ISlashCommand[] | undefined> | undefined;\n\n\tprivate readonly chatListFocused: IContextKey<boolean>;\n\n\tconstructor(\n\t\treadonly viewContext: IChatWidgetViewContext,\n\t\tprivate readonly styles: IChatWidgetStyles,\n\t\t@IContextKeyService private readonly contextKeyService: IContextKeyService,\n\t\t@IInstantiationService private readonly instantiationService: IInstantiationService,\n\t\t@IChatService private readonly chatService: IChatService,\n\t\t@IChatWidgetService chatWidgetService: IChatWidgetService,\n\t\t@IContextMenuService private readonly contextMenuService: IContextMenuService,\n\t\t@IChatAccessibilityService private readonly _chatAccessibilityService: IChatAccessibilityService,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService\n\t) {\n\t\tsuper();\n\t\tCONTEXT_IN_CHAT_SESSION.bindTo(contextKeyService).set(true);\n\t\tthis.chatListFocused = CONTEXT_IN_CHAT_LIST.bindTo(contextKeyService);\n\t\tthis.requestInProgress = CONTEXT_CHAT_REQUEST_IN_PROGRESS.bindTo(contextKeyService);\n\n\t\tthis._register((chatWidgetService as ChatWidgetService).register(this));\n\t}\n\n\tget providerId(): string {\n\t\treturn this.viewModel?.providerId || '';\n\t}\n\n\tget inputEditor(): ICodeEditor {\n\t\treturn this.inputPart.inputEditor!;\n\t}\n\n\tget inputUri(): URI {\n\t\treturn this.inputPart.inputUri;\n\t}\n\n\tprivate _isDisposed: boolean = false;\n\tpublic override dispose(): void {\n\t\tthis._isDisposed = true;\n\t\tsuper.dispose();\n\t}\n\n\trender(parent: HTMLElement): void {\n\t\tconst viewId = 'viewId' in this.viewContext ? this.viewContext.viewId : undefined;\n\t\tthis.editorOptions = this._register(this.instantiationService.createInstance(ChatEditorOptions, viewId, this.styles.listForeground, this.styles.inputEditorBackground, this.styles.resultEditorBackground));\n\t\tconst renderInputOnTop = this.viewContext.renderInputOnTop ?? false;\n\t\tconst renderStyle = this.viewContext.renderStyle;\n\n\t\tthis.container = dom.append(parent, $('.interactive-session'));\n\t\tif (renderInputOnTop) {\n\t\t\tthis.createInput(this.container, { renderFollowups: false, renderStyle });\n\t\t\tthis.listContainer = dom.append(this.container, $(`.interactive-list`));\n\t\t} else {\n\t\t\tthis.listContainer = dom.append(this.container, $(`.interactive-list`));\n\t\t\tthis.createInput(this.container);\n\t\t}\n\n\t\tthis.createList(this.listContainer, { renderStyle });\n\n\t\tthis._register(this.editorOptions.onDidChange(() => this.onDidStyleChange()));\n\t\tthis.onDidStyleChange();\n\n\t\t// Do initial render\n\t\tif (this.viewModel) {\n\t\t\tthis.onDidChangeItems();\n\t\t\trevealLastElement(this.tree);\n\t\t}\n\n\t\tChatWidget.CONTRIBS.forEach(contrib => this._register(this.instantiationService.createInstance(contrib, this)));\n\t}\n\n\tfocusInput(): void {\n\t\tthis.inputPart.focus();\n\t}\n\n\thasInputFocus(): boolean {\n\t\treturn this.inputPart.hasFocus();\n\t}\n\n\tmoveFocus(item: ChatTreeItem, type: 'next' | 'previous'): void {\n\t\tconst items = this.viewModel?.getItems();\n\t\tif (!items) {\n\t\t\treturn;\n\t\t}\n\t\tconst responseItems = items.filter(i => isResponseVM(i));\n\t\tconst targetIndex = responseItems.indexOf(item);\n\t\tif (targetIndex === undefined) {\n\t\t\treturn;\n\t\t}\n\t\tconst indexToFocus = type === 'next' ? targetIndex + 1 : targetIndex - 1;\n\t\tif (indexToFocus < 0 || indexToFocus > responseItems.length - 1) {\n\t\t\treturn;\n\t\t}\n\t\tthis.focus(responseItems[indexToFocus]);\n\t}\n\n\tclear(): void {\n\t\tif (this._dynamicMessageLayoutData) {\n\t\t\tthis._dynamicMessageLayoutData.enabled = true;\n\t\t}\n\t\tthis._onDidClear.fire();\n\t}\n\n\tprivate onDidChangeItems(skipDynamicLayout?: boolean) {\n\t\tif (this.tree && this._visible) {\n\t\t\tconst treeItems = (this.viewModel?.getItems() ?? [])\n\t\t\t\t.map(item => {\n\t\t\t\t\treturn <ITreeElement<ChatTreeItem>>{\n\t\t\t\t\t\telement: item,\n\t\t\t\t\t\tcollapsed: false,\n\t\t\t\t\t\tcollapsible: false\n\t\t\t\t\t};\n\t\t\t\t});\n\n\t\t\tthis.tree.setChildren(null, treeItems, {\n\t\t\t\tdiffIdentityProvider: {\n\t\t\t\t\tgetId: (element) => {\n\t\t\t\t\t\treturn ((isResponseVM(element) || isRequestVM(element)) ? element.dataId : element.id) +\n\t\t\t\t\t\t\t// TODO? We can give the welcome message a proper VM or get rid of the rest of the VMs\n\t\t\t\t\t\t\t((isWelcomeVM(element) && !this.viewModel?.isInitialized) ? '_initializing' : '') +\n\t\t\t\t\t\t\t// Ensure re-rendering an element once slash commands are loaded, so the colorization can be applied.\n\t\t\t\t\t\t\t`${(isRequestVM(element) || isWelcomeVM(element)) && !!this.lastSlashCommands ? '_scLoaded' : ''}` +\n\t\t\t\t\t\t\t// If a response is in the process of progressive rendering, we need to ensure that it will\n\t\t\t\t\t\t\t// be re-rendered so progressive rendering is restarted, even if the model wasn't updated.\n\t\t\t\t\t\t\t`${isResponseVM(element) && element.renderData ? `_${this.visibleChangeCount}` : ''}`;\n\t\t\t\t\t},\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (!skipDynamicLayout && this._dynamicMessageLayoutData) {\n\t\t\t\tthis.layoutDynamicChatTreeItemMode();\n\t\t\t}\n\n\t\t\tconst lastItem = treeItems[treeItems.length - 1]?.element;\n\t\t\tif (lastItem && isResponseVM(lastItem) && lastItem.isComplete) {\n\t\t\t\tthis.renderFollowups(lastItem.replyFollowups);\n\t\t\t} else {\n\t\t\t\tthis.renderFollowups(undefined);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate async renderFollowups(items?: IChatReplyFollowup[]): Promise<void> {\n\t\tthis.inputPart.renderFollowups(items);\n\n\t\tif (this.bodyDimension) {\n\t\t\tthis.layout(this.bodyDimension.height, this.bodyDimension.width);\n\t\t}\n\t}\n\n\tsetVisible(visible: boolean): void {\n\t\tthis._visible = visible;\n\t\tthis.visibleChangeCount++;\n\t\tthis.renderer.setVisible(visible);\n\n\t\tif (visible) {\n\t\t\tthis._register(disposableTimeout(() => {\n\t\t\t\t// Progressive rendering paused while hidden, so start it up again.\n\t\t\t\t// Do it after a timeout because the container is not visible yet (it should be but offsetHeight returns 0 here)\n\t\t\t\tif (this._visible) {\n\t\t\t\t\tthis.onDidChangeItems(true);\n\t\t\t\t}\n\t\t\t}, 0));\n\t\t}\n\t}\n\n\tasync getSlashCommands(): Promise<ISlashCommand[] | undefined> {\n\t\tif (!this.viewModel) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.slashCommandsPromise) {\n\t\t\tthis.slashCommandsPromise = this.chatService.getSlashCommands(this.viewModel.sessionId, CancellationToken.None).then(commands => {\n\t\t\t\tthis.lastSlashCommands = commands ?? [];\n\t\t\t\treturn this.lastSlashCommands;\n\t\t\t});\n\t\t}\n\n\t\treturn this.slashCommandsPromise;\n\t}\n\n\tprivate createList(listContainer: HTMLElement, options: IChatListItemRendererOptions): void {\n\t\tconst scopedInstantiationService = this.instantiationService.createChild(new ServiceCollection([IContextKeyService, this.contextKeyService]));\n\t\tconst delegate = scopedInstantiationService.createInstance(ChatListDelegate);\n\t\tconst rendererDelegate: IChatRendererDelegate = {\n\t\t\tgetListLength: () => this.tree.getNode(null).visibleChildrenCount,\n\t\t\tgetSlashCommands: () => this.lastSlashCommands ?? [],\n\t\t};\n\t\tthis.renderer = this._register(scopedInstantiationService.createInstance(\n\t\t\tChatListItemRenderer,\n\t\t\tthis.editorOptions,\n\t\t\toptions,\n\t\t\trendererDelegate\n\t\t));\n\t\tthis._register(this.renderer.onDidClickFollowup(item => {\n\t\t\tthis.acceptInput(item);\n\t\t}));\n\n\t\tthis.tree = <WorkbenchObjectTree<ChatTreeItem>>scopedInstantiationService.createInstance(\n\t\t\tWorkbenchObjectTree,\n\t\t\t'Chat',\n\t\t\tlistContainer,\n\t\t\tdelegate,\n\t\t\t[this.renderer],\n\t\t\t{\n\t\t\t\tidentityProvider: { getId: (e: ChatTreeItem) => e.id },\n\t\t\t\thorizontalScrolling: false,\n\t\t\t\tsupportDynamicHeights: true,\n\t\t\t\thideTwistiesOfChildlessElements: true,\n\t\t\t\taccessibilityProvider: this._instantiationService.createInstance(ChatAccessibilityProvider),\n\t\t\t\tkeyboardNavigationLabelProvider: { getKeyboardNavigationLabel: (e: ChatTreeItem) => isRequestVM(e) ? e.message : isResponseVM(e) ? e.response.value : '' }, // TODO\n\t\t\t\tsetRowLineHeight: false,\n\t\t\t\toverrideStyles: {\n\t\t\t\t\tlistFocusBackground: this.styles.listBackground,\n\t\t\t\t\tlistInactiveFocusBackground: this.styles.listBackground,\n\t\t\t\t\tlistActiveSelectionBackground: this.styles.listBackground,\n\t\t\t\t\tlistFocusAndSelectionBackground: this.styles.listBackground,\n\t\t\t\t\tlistInactiveSelectionBackground: this.styles.listBackground,\n\t\t\t\t\tlistHoverBackground: this.styles.listBackground,\n\t\t\t\t\tlistBackground: this.styles.listBackground,\n\t\t\t\t\tlistFocusForeground: this.styles.listForeground,\n\t\t\t\t\tlistHoverForeground: this.styles.listForeground,\n\t\t\t\t\tlistInactiveFocusForeground: this.styles.listForeground,\n\t\t\t\t\tlistInactiveSelectionForeground: this.styles.listForeground,\n\t\t\t\t\tlistActiveSelectionForeground: this.styles.listForeground,\n\t\t\t\t\tlistFocusAndSelectionForeground: this.styles.listForeground,\n\t\t\t\t}\n\t\t\t});\n\t\tthis.tree.onContextMenu(e => this.onContextMenu(e));\n\n\t\tthis._register(this.tree.onDidChangeContentHeight(() => {\n\t\t\tthis.onDidChangeTreeContentHeight();\n\t\t}));\n\t\tthis._register(this.renderer.onDidChangeItemHeight(e => {\n\t\t\tthis.tree.updateElementHeight(e.element, e.height);\n\t\t}));\n\t\tthis._register(this.tree.onDidFocus(() => {\n\t\t\tthis._onDidFocus.fire();\n\t\t\tthis.chatListFocused.set(this.tree.isDOMFocused());\n\t\t}));\n\t\tthis._register(this.tree.onDidBlur(() => this.chatListFocused.set(false)));\n\t}\n\n\tprivate onContextMenu(e: ITreeContextMenuEvent<ChatTreeItem | null>): void {\n\t\te.browserEvent.preventDefault();\n\t\te.browserEvent.stopPropagation();\n\n\t\tthis.contextMenuService.showContextMenu({\n\t\t\tmenuId: MenuId.ChatContext,\n\t\t\tmenuActionOptions: { shouldForwardArgs: true },\n\t\t\tcontextKeyService: this.contextKeyService,\n\t\t\tgetAnchor: () => e.anchor,\n\t\t\tgetActionsContext: () => e.element,\n\t\t});\n\t}\n\n\tprivate onDidChangeTreeContentHeight(): void {\n\t\tif (this.tree.scrollHeight !== this.previousTreeScrollHeight) {\n\t\t\t// Due to rounding, the scrollTop + renderHeight will not exactly match the scrollHeight.\n\t\t\t// Consider the tree to be scrolled all the way down if it is within 2px of the bottom.\n\t\t\tconst lastElementWasVisible = this.tree.scrollTop + this.tree.renderHeight >= this.previousTreeScrollHeight - 2;\n\t\t\tif (lastElementWasVisible) {\n\t\t\t\tdom.scheduleAtNextAnimationFrame(() => {\n\t\t\t\t\t// Can't set scrollTop during this event listener, the list might overwrite the change\n\t\t\t\t\trevealLastElement(this.tree);\n\t\t\t\t}, 0);\n\t\t\t}\n\t\t}\n\n\t\tthis.previousTreeScrollHeight = this.tree.scrollHeight;\n\t}\n\n\tprivate createInput(container: HTMLElement, options?: { renderFollowups: boolean; renderStyle?: 'default' | 'compact' }): void {\n\t\tthis.inputPart = this._register(this.instantiationService.createInstance(ChatInputPart, {\n\t\t\trenderFollowups: options?.renderFollowups ?? true,\n\t\t\trenderStyle: options?.renderStyle,\n\t\t}));\n\t\tthis.inputPart.render(container, '', this);\n\n\t\tthis._register(this.inputPart.onDidFocus(() => this._onDidFocus.fire()));\n\t\tthis._register(this.inputPart.onDidAcceptFollowup(followup => this.acceptInput(followup)));\n\t\tthis._register(this.inputPart.onDidChangeHeight(() => this.bodyDimension && this.layout(this.bodyDimension.height, this.bodyDimension.width)));\n\t}\n\n\tprivate onDidStyleChange(): void {\n\t\tthis.container.style.setProperty('--vscode-interactive-result-editor-background-color', this.editorOptions.configuration.resultEditor.backgroundColor?.toString() ?? '');\n\t\tthis.container.style.setProperty('--vscode-interactive-session-foreground', this.editorOptions.configuration.foreground?.toString() ?? '');\n\t}\n\n\tsetModel(model: IChatModel, viewState: IViewState): void {\n\t\tif (!this.container) {\n\t\t\tthrow new Error('Call render() before setModel()');\n\t\t}\n\n\t\tthis.container.setAttribute('data-session-id', model.sessionId);\n\t\tthis.viewModel = this.instantiationService.createInstance(ChatViewModel, model);\n\t\tthis.viewModelDisposables.add(this.viewModel.onDidChange(e => {\n\t\t\tthis.slashCommandsPromise = undefined;\n\t\t\tthis.requestInProgress.set(this.viewModel!.requestInProgress);\n\t\t\tthis.onDidChangeItems();\n\t\t\tif (e?.kind === 'addRequest') {\n\t\t\t\trevealLastElement(this.tree);\n\t\t\t\tthis.focusInput();\n\t\t\t}\n\t\t}));\n\t\tthis.viewModelDisposables.add(this.viewModel.onDidDisposeModel(() => {\n\t\t\t// Disposes the viewmodel and listeners\n\t\t\tthis.viewModel = undefined;\n\t\t\tthis.onDidChangeItems();\n\t\t}));\n\t\tthis.inputPart.setState(model.providerId, viewState.inputValue ?? '');\n\n\t\tif (this.tree) {\n\t\t\tthis.onDidChangeItems();\n\t\t\trevealLastElement(this.tree);\n\t\t}\n\t}\n\n\tgetFocus(): ChatTreeItem | undefined {\n\t\treturn this.tree.getFocus()[0] ?? undefined;\n\t}\n\n\treveal(item: ChatTreeItem): void {\n\t\tthis.tree.reveal(item);\n\t}\n\n\tfocus(item: ChatTreeItem): void {\n\t\tconst items = this.tree.getNode(null).children;\n\t\tconst node = items.find(i => i.element?.id === item.id);\n\t\tif (!node) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.tree.setFocus([node.element]);\n\t\tthis.tree.domFocus();\n\t}\n\n\tupdateInput(value = ''): void {\n\t\tthis.inputPart.setValue(value);\n\t}\n\n\tasync acceptInput(query?: string | IChatReplyFollowup): Promise<void> {\n\t\tif (this.viewModel) {\n\t\t\tthis._onDidAcceptInput.fire();\n\n\t\t\tconst editorValue = this.inputPart.inputEditor.getValue();\n\t\t\tthis._chatAccessibilityService.acceptRequest();\n\t\t\tconst input = query ?? editorValue;\n\t\t\tconst usedSlashCommand = this.lookupSlashCommand(typeof input === 'string' ? input : input.message);\n\t\t\tconst result = await this.chatService.sendRequest(this.viewModel.sessionId, input, usedSlashCommand);\n\n\t\t\tif (result) {\n\t\t\t\tthis.inputPart.acceptInput(query);\n\t\t\t\tresult.responseCompletePromise.then(async () => {\n\t\t\t\t\tconst responses = this.viewModel?.getItems().filter(isResponseVM);\n\t\t\t\t\tconst lastResponse = responses?.[responses.length - 1];\n\t\t\t\t\tthis._chatAccessibilityService.acceptResponse(lastResponse);\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis._chatAccessibilityService.acceptResponse();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate lookupSlashCommand(input: string): ISlashCommand | undefined {\n\t\treturn this.lastSlashCommands?.find(sc => input.startsWith(`/${sc.command}`));\n\t}\n\n\tgetCodeBlockInfosForResponse(response: IChatResponseViewModel): IChatCodeBlockInfo[] {\n\t\treturn this.renderer.getCodeBlockInfosForResponse(response);\n\t}\n\n\tgetCodeBlockInfoForEditor(uri: URI): IChatCodeBlockInfo | undefined {\n\t\treturn this.renderer.getCodeBlockInfoForEditor(uri);\n\t}\n\n\tgetFileTreeInfosForResponse(response: IChatResponseViewModel): IChatFileTreeInfo[] {\n\t\treturn this.renderer.getFileTreeInfosForResponse(response);\n\t}\n\n\tgetLastFocusedFileTreeForResponse(response: IChatResponseViewModel): IChatFileTreeInfo | undefined {\n\t\treturn this.renderer.getLastFocusedFileTreeForResponse(response);\n\t}\n\n\tfocusLastMessage(): void {\n\t\tif (!this.viewModel) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst items = this.tree.getNode(null).children;\n\t\tconst lastItem = items[items.length - 1];\n\t\tif (!lastItem) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis.tree.setFocus([lastItem.element]);\n\t\tthis.tree.domFocus();\n\t}\n\n\tlayout(height: number, width: number): void {\n\t\twidth = Math.min(width, 850);\n\t\tthis.bodyDimension = new dom.Dimension(width, height);\n\n\t\tconst inputPartHeight = this.inputPart.layout(height, width);\n\t\tconst lastElementVisible = this.tree.scrollTop + this.tree.renderHeight >= this.tree.scrollHeight;\n\n\t\tconst listHeight = height - inputPartHeight;\n\n\t\tthis.tree.layout(listHeight, width);\n\t\tthis.tree.getHTMLElement().style.height = `${listHeight}px`;\n\t\tthis.renderer.layout(width);\n\t\tif (lastElementVisible) {\n\t\t\trevealLastElement(this.tree);\n\t\t}\n\n\t\tthis.listContainer.style.height = `${height - inputPartHeight}px`;\n\n\t\tthis._onDidChangeHeight.fire(height);\n\t}\n\n\tprivate _dynamicMessageLayoutData?: { numOfMessages: number; maxHeight: number; enabled: boolean };\n\n\t// An alternative to layout, this allows you to specify the number of ChatTreeItems\n\t// you want to show, and the max height of the container. It will then layout the\n\t// tree to show that many items.\n\t// TODO@TylerLeonhardt: This could use some refactoring to make it clear which layout strategy is being used\n\tsetDynamicChatTreeItemLayout(numOfChatTreeItems: number, maxHeight: number) {\n\t\tthis._dynamicMessageLayoutData = { numOfMessages: numOfChatTreeItems, maxHeight, enabled: true };\n\t\tthis._register(this.renderer.onDidChangeItemHeight(() => this.layoutDynamicChatTreeItemMode()));\n\n\t\tconst mutableDisposable = this._register(new MutableDisposable());\n\t\tthis._register(this.tree.onDidScroll((e) => {\n\t\t\t// TODO@TylerLeonhardt this should probably just be disposed when this is disabled\n\t\t\t// and then set up again when it is enabled again\n\t\t\tif (!this._dynamicMessageLayoutData?.enabled) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tmutableDisposable.value = dom.scheduleAtNextAnimationFrame(() => {\n\t\t\t\tif (!e.scrollTopChanged || e.heightChanged || e.scrollHeightChanged) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst renderHeight = e.height;\n\t\t\t\tconst diff = e.scrollHeight - renderHeight - e.scrollTop;\n\t\t\t\tif (diff === 0) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tconst possibleMaxHeight = (this._dynamicMessageLayoutData?.maxHeight ?? maxHeight);\n\t\t\t\tconst width = this.bodyDimension?.width ?? this.container.offsetWidth;\n\t\t\t\tconst inputPartHeight = this.inputPart.layout(possibleMaxHeight, width);\n\t\t\t\tconst newHeight = Math.min(renderHeight + diff, possibleMaxHeight - inputPartHeight);\n\t\t\t\tthis.layout(newHeight + inputPartHeight, width);\n\t\t\t});\n\t\t}));\n\t}\n\n\tupdateDynamicChatTreeItemLayout(numOfChatTreeItems: number, maxHeight: number) {\n\t\tthis._dynamicMessageLayoutData = { numOfMessages: numOfChatTreeItems, maxHeight, enabled: true };\n\t\tlet hasChanged = false;\n\t\tlet height = this.bodyDimension!.height;\n\t\tlet width = this.bodyDimension!.width;\n\t\tif (maxHeight < this.bodyDimension!.height) {\n\t\t\theight = maxHeight;\n\t\t\thasChanged = true;\n\t\t}\n\t\tconst containerWidth = this.container.offsetWidth;\n\t\tif (this.bodyDimension?.width !== containerWidth) {\n\t\t\twidth = containerWidth;\n\t\t\thasChanged = true;\n\t\t}\n\t\tif (hasChanged) {\n\t\t\tthis.layout(height, width);\n\t\t}\n\t}\n\n\tget isDynamicChatTreeItemLayoutEnabled(): boolean {\n\t\treturn this._dynamicMessageLayoutData?.enabled ?? false;\n\t}\n\n\tset isDynamicChatTreeItemLayoutEnabled(value: boolean) {\n\t\tif (!this._dynamicMessageLayoutData) {\n\t\t\treturn;\n\t\t}\n\t\tthis._dynamicMessageLayoutData.enabled = value;\n\t}\n\n\tlayoutDynamicChatTreeItemMode(): void {\n\t\tif (!this.viewModel || !this._dynamicMessageLayoutData?.enabled) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst width = this.bodyDimension?.width ?? this.container.offsetWidth;\n\t\tconst inputHeight = this.inputPart.layout(this._dynamicMessageLayoutData!.maxHeight, width);\n\n\t\tconst totalMessages = this.viewModel.getItems();\n\t\t// grab the last N messages\n\t\tconst messages = totalMessages.slice(-this._dynamicMessageLayoutData!.numOfMessages);\n\n\t\tconst needsRerender = messages.some(m => m.currentRenderedHeight === undefined);\n\t\tconst listHeight = needsRerender\n\t\t\t? this._dynamicMessageLayoutData!.maxHeight\n\t\t\t: messages.reduce((acc, message) => acc + message.currentRenderedHeight!, 0);\n\n\t\tthis.layout(\n\t\t\tMath.min(\n\t\t\t\t// we add an additional 18px in order to show that there is scrollable content\n\t\t\t\tinputHeight + listHeight + (totalMessages.length > 2 ? 18 : 0),\n\t\t\t\tthis._dynamicMessageLayoutData!.maxHeight\n\t\t\t),\n\t\t\twidth\n\t\t);\n\n\t\tif (needsRerender || !listHeight) {\n\t\t\t// TODO: figure out a better place to reveal the last element\n\t\t\trevealLastElement(this.tree);\n\t\t}\n\t}\n\n\tsaveState(): void {\n\t\tthis.inputPart.saveState();\n\t}\n\n\tgetViewState(): IViewState {\n\t\tthis.inputPart.saveState();\n\t\treturn { inputValue: this.inputPart.inputEditor.getValue() };\n\t}\n}\n\nexport class ChatWidgetService implements IChatWidgetService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate _widgets: ChatWidget[] = [];\n\tprivate _lastFocusedWidget: ChatWidget | undefined = undefined;\n\n\tget lastFocusedWidget(): ChatWidget | undefined {\n\t\treturn this._lastFocusedWidget;\n\t}\n\n\tconstructor(\n\t\t@IViewsService private readonly viewsService: IViewsService,\n\t\t@IChatContributionService private readonly chatContributionService: IChatContributionService,\n\t) { }\n\n\tgetWidgetByInputUri(uri: URI): ChatWidget | undefined {\n\t\treturn this._widgets.find(w => isEqual(w.inputUri, uri));\n\t}\n\n\tgetWidgetBySessionId(sessionId: string): ChatWidget | undefined {\n\t\treturn this._widgets.find(w => w.viewModel?.sessionId === sessionId);\n\t}\n\n\tasync revealViewForProvider(providerId: string): Promise<ChatWidget | undefined> {\n\t\tconst viewId = this.chatContributionService.getViewIdForProvider(providerId);\n\t\tconst view = await this.viewsService.openView<ChatViewPane>(viewId);\n\n\t\treturn view?.widget;\n\t}\n\n\tprivate setLastFocusedWidget(widget: ChatWidget | undefined): void {\n\t\tif (widget === this._lastFocusedWidget) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._lastFocusedWidget = widget;\n\t}\n\n\tregister(newWidget: ChatWidget): IDisposable {\n\t\tif (this._widgets.some(widget => widget === newWidget)) {\n\t\t\tthrow new Error('Cannot register the same widget multiple times');\n\t\t}\n\n\t\tthis._widgets.push(newWidget);\n\n\t\treturn combinedDisposable(\n\t\t\tnewWidget.onDidFocus(() => this.setLastFocusedWidget(newWidget)),\n\t\t\ttoDisposable(() => this._widgets.splice(this._widgets.indexOf(newWidget), 1))\n\t\t);\n\t}\n}\n"]}