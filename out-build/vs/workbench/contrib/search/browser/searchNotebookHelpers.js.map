{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/contrib/search/browser/searchNotebookHelpers.ts"],"names":[],"mappings":"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","file":"searchNotebookHelpers.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DefaultEndOfLine, FindMatch, IReadonlyTextBuffer } from 'vs/editor/common/model';\nimport { CellWebviewFindMatch, ICellViewModel } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';\nimport { IFileMatch, ITextSearchMatch, TextSearchMatch } from 'vs/workbench/services/search/common/search';\nimport { Range } from 'vs/editor/common/core/range';\nimport { PieceTreeTextBufferBuilder } from 'vs/editor/common/model/pieceTreeTextBuffer/pieceTreeTextBufferBuilder';\nimport { SearchParams } from 'vs/editor/common/model/textModelSearch';\nimport { Disposable } from 'vs/base/common/lifecycle';\nimport { URI } from 'vs/base/common/uri';\nimport { IOutputItemDto } from 'vs/workbench/contrib/notebook/common/notebookCommon';\n\nexport interface IFileMatchWithCells extends IFileMatch {\n\tcellResults: ICellMatch[];\n}\n\nexport interface ICellMatch {\n\tcell: ICellViewModel | CellSearchModel;\n\tindex: number;\n\tcontentResults: ITextSearchMatch[];\n\twebviewResults: ITextSearchMatch[];\n}\nexport function isIFileMatchWithCells(object: IFileMatch): object is IFileMatchWithCells {\n\treturn 'cellResults' in object;\n}\n\n// to text search results\n\nexport function contentMatchesToTextSearchMatches(contentMatches: FindMatch[], cell: ICellViewModel | CellSearchModel): ITextSearchMatch[] {\n\treturn genericCellMatchesToTextSearchMatches(\n\t\tcontentMatches,\n\t\tcell instanceof CellSearchModel ? cell.inputTextBuffer : cell.textBuffer,\n\t\tcell\n\t);\n}\n\nexport function genericCellMatchesToTextSearchMatches(contentMatches: FindMatch[], buffer: IReadonlyTextBuffer, cell: ICellViewModel | CellSearchModel) {\n\tlet previousEndLine = -1;\n\tconst contextGroupings: FindMatch[][] = [];\n\tlet currentContextGrouping: FindMatch[] = [];\n\n\tcontentMatches.forEach((match) => {\n\t\tif (match.range.startLineNumber !== previousEndLine) {\n\t\t\tif (currentContextGrouping.length > 0) {\n\t\t\t\tcontextGroupings.push([...currentContextGrouping]);\n\t\t\t\tcurrentContextGrouping = [];\n\t\t\t}\n\t\t}\n\n\t\tcurrentContextGrouping.push(match);\n\t\tpreviousEndLine = match.range.endLineNumber;\n\t});\n\n\tif (currentContextGrouping.length > 0) {\n\t\tcontextGroupings.push([...currentContextGrouping]);\n\t}\n\n\tconst textSearchResults = contextGroupings.map((grouping) => {\n\t\tconst lineTexts: string[] = [];\n\t\tconst firstLine = grouping[0].range.startLineNumber;\n\t\tconst lastLine = grouping[grouping.length - 1].range.endLineNumber;\n\t\tfor (let i = firstLine; i <= lastLine; i++) {\n\t\t\tlineTexts.push(buffer.getLineContent(i));\n\t\t}\n\t\treturn new TextSearchMatch(\n\t\t\tlineTexts.join('\\n') + '\\n',\n\t\t\tgrouping.map(m => new Range(m.range.startLineNumber - 1, m.range.startColumn - 1, m.range.endLineNumber - 1, m.range.endColumn - 1)),\n\t\t);\n\t});\n\n\treturn textSearchResults;\n}\n\nexport function webviewMatchesToTextSearchMatches(webviewMatches: CellWebviewFindMatch[]): ITextSearchMatch[] {\n\treturn webviewMatches\n\t\t.map(rawMatch =>\n\t\t\t(rawMatch.searchPreviewInfo) ?\n\t\t\t\tnew TextSearchMatch(\n\t\t\t\t\trawMatch.searchPreviewInfo.line,\n\t\t\t\t\tnew Range(0, rawMatch.searchPreviewInfo.range.start, 0, rawMatch.searchPreviewInfo.range.end),\n\t\t\t\t\tundefined,\n\t\t\t\t\trawMatch.index) : undefined\n\t\t).filter((e): e is ITextSearchMatch => !!e);\n}\n\n// experimental\n\ninterface RawOutputFindMatch {\n\ttextBuffer: IReadonlyTextBuffer;\n\tmatches: FindMatch[];\n}\n\nexport const rawCellPrefix = 'rawCell#';\nexport class CellSearchModel extends Disposable {\n\tprivate _outputTextBuffers: IReadonlyTextBuffer[] | undefined = undefined;\n\tconstructor(readonly _source: string, private _inputTextBuffer: IReadonlyTextBuffer | undefined, private _outputs: IOutputItemDto[], private _uri: URI, private _cellIndex: number) {\n\t\tsuper();\n\t}\n\n\tget id() {\n\t\treturn `${rawCellPrefix}${this._cellIndex}`;\n\t}\n\n\tget uri() {\n\t\treturn this._uri;\n\t}\n\n\tprivate _getFullModelRange(buffer: IReadonlyTextBuffer): Range {\n\t\tconst lineCount = buffer.getLineCount();\n\t\treturn new Range(1, 1, lineCount, this._getLineMaxColumn(buffer, lineCount));\n\t}\n\n\tprivate _getLineMaxColumn(buffer: IReadonlyTextBuffer, lineNumber: number): number {\n\t\tif (lineNumber < 1 || lineNumber > buffer.getLineCount()) {\n\t\t\tthrow new Error('Illegal value for lineNumber');\n\t\t}\n\t\treturn buffer.getLineLength(lineNumber) + 1;\n\t}\n\n\tget inputTextBuffer(): IReadonlyTextBuffer {\n\t\tif (!this._inputTextBuffer) {\n\t\t\tconst builder = new PieceTreeTextBufferBuilder();\n\t\t\tbuilder.acceptChunk(this._source);\n\t\t\tconst bufferFactory = builder.finish(true);\n\t\t\tconst { textBuffer, disposable } = bufferFactory.create(DefaultEndOfLine.LF);\n\t\t\tthis._inputTextBuffer = textBuffer;\n\t\t\tthis._register(disposable);\n\t\t}\n\n\t\treturn this._inputTextBuffer;\n\t}\n\n\tget outputTextBuffers(): IReadonlyTextBuffer[] {\n\t\tif (!this._outputTextBuffers) {\n\t\t\tthis._outputTextBuffers = this._outputs.map((output) => {\n\t\t\t\tconst builder = new PieceTreeTextBufferBuilder();\n\t\t\t\tbuilder.acceptChunk(output.data.toString());\n\t\t\t\tconst bufferFactory = builder.finish(true);\n\t\t\t\tconst { textBuffer, disposable } = bufferFactory.create(DefaultEndOfLine.LF);\n\t\t\t\tthis._register(disposable);\n\t\t\t\treturn textBuffer;\n\t\t\t});\n\t\t}\n\t\treturn this._outputTextBuffers;\n\t}\n\n\tfindInInputs(target: string): FindMatch[] {\n\t\tconst searchParams = new SearchParams(target, false, false, null);\n\t\tconst searchData = searchParams.parseSearchRequest();\n\t\tif (!searchData) {\n\t\t\treturn [];\n\t\t}\n\t\tconst fullInputRange = this._getFullModelRange(this.inputTextBuffer);\n\t\treturn this.inputTextBuffer.findMatchesLineByLine(fullInputRange, searchData, true, 5000);\n\t}\n\n\tfindInOutputs(target: string): RawOutputFindMatch[] {\n\t\tconst searchParams = new SearchParams(target, false, false, null);\n\t\tconst searchData = searchParams.parseSearchRequest();\n\t\tif (!searchData) {\n\t\t\treturn [];\n\t\t}\n\t\treturn this.outputTextBuffers.map(buffer => {\n\t\t\tconst matches = buffer.findMatchesLineByLine(\n\t\t\t\tthis._getFullModelRange(buffer),\n\t\t\t\tsearchData,\n\t\t\t\ttrue,\n\t\t\t\t5000\n\t\t\t);\n\t\t\tif (matches.length === 0) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\treturn {\n\t\t\t\ttextBuffer: buffer,\n\t\t\t\tmatches\n\t\t\t};\n\t\t}).filter((item): item is RawOutputFindMatch => !!item);\n\t}\n}\n"]}