{"version":3,"sources":["file:///workspace/appflow/src/vs/workbench/contrib/bulkEdit/browser/bulkCellEdits.ts"],"names":[],"mappings":"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","file":"bulkCellEdits.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { groupBy } from 'vs/base/common/arrays';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { compare } from 'vs/base/common/strings';\nimport { isObject } from 'vs/base/common/types';\nimport { URI } from 'vs/base/common/uri';\nimport { ResourceEdit } from 'vs/editor/browser/services/bulkEditService';\nimport { WorkspaceEditMetadata } from 'vs/editor/common/languages';\nimport { IProgress } from 'vs/platform/progress/common/progress';\nimport { UndoRedoGroup, UndoRedoSource } from 'vs/platform/undoRedo/common/undoRedo';\nimport { getNotebookEditorFromEditorPane } from 'vs/workbench/contrib/notebook/browser/notebookBrowser';\nimport { CellUri, ICellPartialMetadataEdit, ICellReplaceEdit, IDocumentMetadataEdit, ISelectionState, IWorkspaceNotebookCellEdit, SelectionStateType } from 'vs/workbench/contrib/notebook/common/notebookCommon';\nimport { INotebookEditorModelResolverService } from 'vs/workbench/contrib/notebook/common/notebookEditorModelResolverService';\nimport { IEditorService } from 'vs/workbench/services/editor/common/editorService';\n\nexport class ResourceNotebookCellEdit extends ResourceEdit implements IWorkspaceNotebookCellEdit {\n\n\tstatic is(candidate: any): candidate is IWorkspaceNotebookCellEdit {\n\t\tif (candidate instanceof ResourceNotebookCellEdit) {\n\t\t\treturn true;\n\t\t}\n\t\treturn URI.isUri((<IWorkspaceNotebookCellEdit>candidate).resource)\n\t\t\t&& isObject((<IWorkspaceNotebookCellEdit>candidate).cellEdit);\n\t}\n\n\tstatic lift(edit: IWorkspaceNotebookCellEdit): ResourceNotebookCellEdit {\n\t\tif (edit instanceof ResourceNotebookCellEdit) {\n\t\t\treturn edit;\n\t\t}\n\t\treturn new ResourceNotebookCellEdit(edit.resource, edit.cellEdit, edit.notebookVersionId, edit.metadata);\n\t}\n\n\tconstructor(\n\t\treadonly resource: URI,\n\t\treadonly cellEdit: ICellPartialMetadataEdit | IDocumentMetadataEdit | ICellReplaceEdit,\n\t\treadonly notebookVersionId: number | undefined = undefined,\n\t\tmetadata?: WorkspaceEditMetadata\n\t) {\n\t\tsuper(metadata);\n\t}\n}\n\nexport class BulkCellEdits {\n\n\tconstructor(\n\t\tprivate readonly _undoRedoGroup: UndoRedoGroup,\n\t\tundoRedoSource: UndoRedoSource | undefined,\n\t\tprivate readonly _progress: IProgress<void>,\n\t\tprivate readonly _token: CancellationToken,\n\t\tprivate readonly _edits: ResourceNotebookCellEdit[],\n\t\t@IEditorService private readonly _editorService: IEditorService,\n\t\t@INotebookEditorModelResolverService private readonly _notebookModelService: INotebookEditorModelResolverService,\n\t) {\n\t\tthis._edits = this._edits.map(e => {\n\t\t\tif (e.resource.scheme === CellUri.scheme) {\n\t\t\t\tconst uri = CellUri.parse(e.resource)?.notebook;\n\t\t\t\tif (!uri) {\n\t\t\t\t\tthrow new Error(`Invalid notebook URI: ${e.resource}`);\n\t\t\t\t}\n\n\t\t\t\treturn new ResourceNotebookCellEdit(uri, e.cellEdit, e.notebookVersionId, e.metadata);\n\t\t\t} else {\n\t\t\t\treturn e;\n\t\t\t}\n\t\t});\n\t}\n\n\tasync apply(): Promise<readonly URI[]> {\n\t\tconst resources: URI[] = [];\n\t\tconst editsByNotebook = groupBy(this._edits, (a, b) => compare(a.resource.toString(), b.resource.toString()));\n\n\t\tfor (const group of editsByNotebook) {\n\t\t\tif (this._token.isCancellationRequested) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst [first] = group;\n\t\t\tconst ref = await this._notebookModelService.resolve(first.resource);\n\n\t\t\t// check state\n\t\t\tif (typeof first.notebookVersionId === 'number' && ref.object.notebook.versionId !== first.notebookVersionId) {\n\t\t\t\tref.dispose();\n\t\t\t\tthrow new Error(`Notebook '${first.resource}' has changed in the meantime`);\n\t\t\t}\n\n\t\t\t// apply edits\n\t\t\tconst edits = group.map(entry => entry.cellEdit);\n\t\t\tconst computeUndo = !ref.object.isReadonly();\n\t\t\tconst editor = getNotebookEditorFromEditorPane(this._editorService.activeEditorPane);\n\t\t\tconst initialSelectionState: ISelectionState | undefined = editor?.textModel?.uri.toString() === ref.object.notebook.uri.toString() ? {\n\t\t\t\tkind: SelectionStateType.Index,\n\t\t\t\tfocus: editor.getFocus(),\n\t\t\t\tselections: editor.getSelections()\n\t\t\t} : undefined;\n\t\t\tref.object.notebook.applyEdits(edits, true, initialSelectionState, () => undefined, this._undoRedoGroup, computeUndo);\n\t\t\tref.dispose();\n\n\t\t\tthis._progress.report(undefined);\n\n\t\t\tresources.push(first.resource);\n\t\t}\n\n\t\treturn resources;\n\t}\n}\n"]}