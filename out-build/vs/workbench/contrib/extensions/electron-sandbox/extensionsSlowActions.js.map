{"version":3,"sources":["vs/workbench/contrib/extensions/electron-sandbox/extensionsSlowActions.ts"],"names":[],"mappings":"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","file":"extensionsSlowActions.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IProductService } from 'vs/platform/product/common/productService';\nimport { Action } from 'vs/base/common/actions';\nimport { IExtensionDescription } from 'vs/platform/extensions/common/extensions';\nimport { URI } from 'vs/base/common/uri';\nimport { IExtensionHostProfile } from 'vs/workbench/services/extensions/common/extensions';\nimport { IInstantiationService, ServicesAccessor } from 'vs/platform/instantiation/common/instantiation';\nimport { localize } from 'vs/nls';\nimport { CancellationToken } from 'vs/base/common/cancellation';\nimport { IRequestService, asText } from 'vs/platform/request/common/request';\nimport { joinPath } from 'vs/base/common/resources';\nimport { IDialogService } from 'vs/platform/dialogs/common/dialogs';\nimport { IOpenerService } from 'vs/platform/opener/common/opener';\nimport { INativeHostService } from 'vs/platform/native/common/native';\nimport { INativeWorkbenchEnvironmentService } from 'vs/workbench/services/environment/electron-sandbox/environmentService';\nimport { Utils } from 'vs/platform/profiling/common/profiling';\nimport { IFileService } from 'vs/platform/files/common/files';\nimport { VSBuffer } from 'vs/base/common/buffer';\nimport { IRequestContext } from 'vs/base/parts/request/common/request';\n\nabstract class RepoInfo {\n\tabstract get base(): string;\n\tabstract get owner(): string;\n\tabstract get repo(): string;\n\n\tstatic fromExtension(desc: IExtensionDescription): RepoInfo | undefined {\n\n\t\tlet result: RepoInfo | undefined;\n\n\t\t// scheme:auth/OWNER/REPO/issues/\n\t\tif (desc.bugs && typeof desc.bugs.url === 'string') {\n\t\t\tconst base = URI.parse(desc.bugs.url);\n\t\t\tconst match = /\\/([^/]+)\\/([^/]+)\\/issues\\/?$/.exec(desc.bugs.url);\n\t\t\tif (match) {\n\t\t\t\tresult = {\n\t\t\t\t\tbase: base.with({ path: null, fragment: null, query: null }).toString(true),\n\t\t\t\t\towner: match[1],\n\t\t\t\t\trepo: match[2]\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\t// scheme:auth/OWNER/REPO.git\n\t\tif (!result && desc.repository && typeof desc.repository.url === 'string') {\n\t\t\tconst base = URI.parse(desc.repository.url);\n\t\t\tconst match = /\\/([^/]+)\\/([^/]+)(\\.git)?$/.exec(desc.repository.url);\n\t\t\tif (match) {\n\t\t\t\tresult = {\n\t\t\t\t\tbase: base.with({ path: null, fragment: null, query: null }).toString(true),\n\t\t\t\t\towner: match[1],\n\t\t\t\t\trepo: match[2]\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// for now only GH is supported\n\t\tif (result && result.base.indexOf('github') === -1) {\n\t\t\tresult = undefined;\n\t\t}\n\n\t\treturn result;\n\t}\n}\n\nexport class SlowExtensionAction extends Action {\n\n\tconstructor(\n\t\treadonly extension: IExtensionDescription,\n\t\treadonly profile: IExtensionHostProfile,\n\t\t@IInstantiationService private readonly _instantiationService: IInstantiationService,\n\t) {\n\t\tsuper('report.slow', localize('cmd.reportOrShow', \"Performance Issue\"), 'extension-action report-issue');\n\t\tthis.enabled = Boolean(RepoInfo.fromExtension(extension));\n\t}\n\n\toverride async run(): Promise<void> {\n\t\tconst action = await this._instantiationService.invokeFunction(createSlowExtensionAction, this.extension, this.profile);\n\t\tif (action) {\n\t\t\tawait action.run();\n\t\t}\n\t}\n}\n\nexport async function createSlowExtensionAction(\n\taccessor: ServicesAccessor,\n\textension: IExtensionDescription,\n\tprofile: IExtensionHostProfile\n): Promise<Action | undefined> {\n\n\tconst info = RepoInfo.fromExtension(extension);\n\tif (!info) {\n\t\treturn undefined;\n\t}\n\n\tconst requestService = accessor.get(IRequestService);\n\tconst instaService = accessor.get(IInstantiationService);\n\tconst url = `https://api.github.com/search/issues?q=is:issue+state:open+in:title+repo:${info.owner}/${info.repo}+%22Extension+causes+high+cpu+load%22`;\n\tlet res: IRequestContext;\n\ttry {\n\t\tres = await requestService.request({ url }, CancellationToken.None);\n\t} catch {\n\t\treturn undefined;\n\t}\n\tconst rawText = await asText(res);\n\tif (!rawText) {\n\t\treturn undefined;\n\t}\n\n\tconst data = <{ total_count: number }>JSON.parse(rawText);\n\tif (!data || typeof data.total_count !== 'number') {\n\t\treturn undefined;\n\t} else if (data.total_count === 0) {\n\t\treturn instaService.createInstance(ReportExtensionSlowAction, extension, info, profile);\n\t} else {\n\t\treturn instaService.createInstance(ShowExtensionSlowAction, extension, info, profile);\n\t}\n}\n\nclass ReportExtensionSlowAction extends Action {\n\n\tconstructor(\n\t\treadonly extension: IExtensionDescription,\n\t\treadonly repoInfo: RepoInfo,\n\t\treadonly profile: IExtensionHostProfile,\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@IOpenerService private readonly _openerService: IOpenerService,\n\t\t@IProductService private readonly _productService: IProductService,\n\t\t@INativeHostService private readonly _nativeHostService: INativeHostService,\n\t\t@INativeWorkbenchEnvironmentService private readonly _environmentService: INativeWorkbenchEnvironmentService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\t) {\n\t\tsuper('report.slow', localize('cmd.report', \"Report Issue\"));\n\t}\n\n\toverride async run(): Promise<void> {\n\n\t\t// rewrite pii (paths) and store on disk\n\t\tconst data = Utils.rewriteAbsolutePaths(this.profile.data, 'pii_removed');\n\t\tconst path = joinPath(this._environmentService.tmpDir, `${this.extension.identifier.value}-unresponsive.cpuprofile.txt`);\n\t\tawait this._fileService.writeFile(path, VSBuffer.fromString(JSON.stringify(data, undefined, 4)));\n\n\t\t// build issue\n\t\tconst os = await this._nativeHostService.getOSProperties();\n\t\tconst title = encodeURIComponent('Extension causes high cpu load');\n\t\tconst osVersion = `${os.type} ${os.arch} ${os.release}`;\n\t\tconst message = `:warning: Make sure to **attach** this file from your *home*-directory:\\n:warning:\\`${path}\\`\\n\\nFind more details here: https://github.com/microsoft/vscode/wiki/Explain-extension-causes-high-cpu-load`;\n\t\tconst body = encodeURIComponent(`- Issue Type: \\`Performance\\`\n- Extension Name: \\`${this.extension.name}\\`\n- Extension Version: \\`${this.extension.version}\\`\n- OS Version: \\`${osVersion}\\`\n- VS Code version: \\`${this._productService.version}\\`\\n\\n${message}`);\n\n\t\tconst url = `${this.repoInfo.base}/${this.repoInfo.owner}/${this.repoInfo.repo}/issues/new/?body=${body}&title=${title}`;\n\t\tthis._openerService.open(URI.parse(url));\n\n\t\tthis._dialogService.info(\n\t\t\tlocalize('attach.title', \"Did you attach the CPU-Profile?\"),\n\t\t\tlocalize('attach.msg', \"This is a reminder to make sure that you have not forgotten to attach '{0}' to the issue you have just created.\", path.fsPath)\n\t\t);\n\t}\n}\n\nclass ShowExtensionSlowAction extends Action {\n\n\tconstructor(\n\t\treadonly extension: IExtensionDescription,\n\t\treadonly repoInfo: RepoInfo,\n\t\treadonly profile: IExtensionHostProfile,\n\t\t@IDialogService private readonly _dialogService: IDialogService,\n\t\t@IOpenerService private readonly _openerService: IOpenerService,\n\t\t@INativeWorkbenchEnvironmentService private readonly _environmentService: INativeWorkbenchEnvironmentService,\n\t\t@IFileService private readonly _fileService: IFileService,\n\n\t) {\n\t\tsuper('show.slow', localize('cmd.show', \"Show Issues\"));\n\t}\n\n\toverride async run(): Promise<void> {\n\n\t\t// rewrite pii (paths) and store on disk\n\t\tconst data = Utils.rewriteAbsolutePaths(this.profile.data, 'pii_removed');\n\t\tconst path = joinPath(this._environmentService.tmpDir, `${this.extension.identifier.value}-unresponsive.cpuprofile.txt`);\n\t\tawait this._fileService.writeFile(path, VSBuffer.fromString(JSON.stringify(data, undefined, 4)));\n\n\t\t// show issues\n\t\tconst url = `${this.repoInfo.base}/${this.repoInfo.owner}/${this.repoInfo.repo}/issues?utf8=✓&q=is%3Aissue+state%3Aopen+%22Extension+causes+high+cpu+load%22`;\n\t\tthis._openerService.open(URI.parse(url));\n\n\t\tthis._dialogService.info(\n\t\t\tlocalize('attach.title', \"Did you attach the CPU-Profile?\"),\n\t\t\tlocalize('attach.msg2', \"This is a reminder to make sure that you have not forgotten to attach '{0}' to an existing performance issue.\", path.fsPath)\n\t\t);\n\t}\n}\n"]}