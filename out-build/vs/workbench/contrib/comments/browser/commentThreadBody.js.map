{"version":3,"sources":["vs/workbench/contrib/comments/browser/commentThreadBody.ts"],"names":[],"mappings":"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","file":"commentThreadBody.js","sourceRoot":"file:///workspace/appflow/src","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as dom from 'vs/base/browser/dom';\nimport * as nls from 'vs/nls';\nimport { Disposable, IDisposable } from 'vs/base/common/lifecycle';\nimport * as languages from 'vs/editor/common/languages';\nimport { Emitter } from 'vs/base/common/event';\nimport { ICommentService } from 'vs/workbench/contrib/comments/browser/commentService';\nimport { StandardKeyboardEvent } from 'vs/base/browser/keyboardEvent';\nimport { KeyCode } from 'vs/base/common/keyCodes';\nimport { CommentNode } from 'vs/workbench/contrib/comments/browser/commentNode';\nimport { IInstantiationService } from 'vs/platform/instantiation/common/instantiation';\nimport { URI } from 'vs/base/common/uri';\nimport { ICommentThreadWidget } from 'vs/workbench/contrib/comments/common/commentThreadWidget';\nimport { IMarkdownRendererOptions, MarkdownRenderer } from 'vs/editor/contrib/markdownRenderer/browser/markdownRenderer';\nimport { IOpenerService } from 'vs/platform/opener/common/opener';\nimport { ILanguageService } from 'vs/editor/common/languages/language';\nimport { ICellRange } from 'vs/workbench/contrib/notebook/common/notebookRange';\nimport { IRange } from 'vs/editor/common/core/range';\n\nexport class CommentThreadBody<T extends IRange | ICellRange = IRange> extends Disposable {\n\tprivate _commentsElement!: HTMLElement;\n\tprivate _commentElements: CommentNode<T>[] = [];\n\tprivate _resizeObserver: any;\n\tprivate _focusedComment: number | undefined = undefined;\n\tprivate _onDidResize = new Emitter<dom.Dimension>();\n\tonDidResize = this._onDidResize.event;\n\n\tprivate _commentDisposable = new Map<CommentNode<T>, IDisposable>();\n\tprivate _markdownRenderer: MarkdownRenderer;\n\n\tget length() {\n\t\treturn this._commentThread.comments ? this._commentThread.comments.length : 0;\n\t}\n\n\tget activeComment() {\n\t\treturn this._commentElements.filter(node => node.isEditing)[0];\n\t}\n\n\n\tconstructor(\n\t\treadonly owner: string,\n\t\treadonly parentResourceUri: URI,\n\t\treadonly container: HTMLElement,\n\t\tprivate _options: IMarkdownRendererOptions,\n\t\tprivate _commentThread: languages.CommentThread<T>,\n\t\tprivate _pendingEdits: { [key: number]: string } | undefined,\n\t\tprivate _scopedInstatiationService: IInstantiationService,\n\t\tprivate _parentCommentThreadWidget: ICommentThreadWidget,\n\t\t@ICommentService private commentService: ICommentService,\n\t\t@IOpenerService private openerService: IOpenerService,\n\t\t@ILanguageService private languageService: ILanguageService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(dom.addDisposableListener(container, dom.EventType.FOCUS_IN, e => {\n\t\t\t// TODO @rebornix, limit T to IRange | ICellRange\n\t\t\tthis.commentService.setActiveCommentThread(this._commentThread);\n\t\t}));\n\n\t\tthis._markdownRenderer = this._register(new MarkdownRenderer(this._options, this.languageService, this.openerService));\n\t}\n\n\tfocus() {\n\t\tthis._commentsElement.focus();\n\t}\n\n\tdisplay() {\n\t\tthis._commentsElement = dom.append(this.container, dom.$('div.comments-container'));\n\t\tthis._commentsElement.setAttribute('role', 'presentation');\n\t\tthis._commentsElement.tabIndex = 0;\n\t\tthis._updateAriaLabel();\n\n\t\tthis._register(dom.addDisposableListener(this._commentsElement, dom.EventType.KEY_DOWN, (e) => {\n\t\t\tconst event = new StandardKeyboardEvent(e as KeyboardEvent);\n\t\t\tif (event.equals(KeyCode.UpArrow) || event.equals(KeyCode.DownArrow)) {\n\t\t\t\tconst moveFocusWithinBounds = (change: number): number => {\n\t\t\t\t\tif (this._focusedComment === undefined && change >= 0) { return 0; }\n\t\t\t\t\tif (this._focusedComment === undefined && change < 0) { return this._commentElements.length - 1; }\n\t\t\t\t\tconst newIndex = this._focusedComment! + change;\n\t\t\t\t\treturn Math.min(Math.max(0, newIndex), this._commentElements.length - 1);\n\t\t\t\t};\n\n\t\t\t\tthis._setFocusedComment(event.equals(KeyCode.UpArrow) ? moveFocusWithinBounds(-1) : moveFocusWithinBounds(1));\n\t\t\t}\n\t\t}));\n\n\t\tthis._commentElements = [];\n\t\tif (this._commentThread.comments) {\n\t\t\tfor (const comment of this._commentThread.comments) {\n\t\t\t\tconst newCommentNode = this.createNewCommentNode(comment);\n\n\t\t\t\tthis._commentElements.push(newCommentNode);\n\t\t\t\tthis._commentsElement.appendChild(newCommentNode.domNode);\n\t\t\t\tif (comment.mode === languages.CommentMode.Editing) {\n\t\t\t\t\tnewCommentNode.switchToEditMode();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._resizeObserver = new MutationObserver(this._refresh.bind(this));\n\n\t\tthis._resizeObserver.observe(this.container, {\n\t\t\tattributes: true,\n\t\t\tchildList: true,\n\t\t\tcharacterData: true,\n\t\t\tsubtree: true\n\t\t});\n\t}\n\n\tprivate _refresh() {\n\t\tconst dimensions = dom.getClientArea(this.container);\n\t\tthis._onDidResize.fire(dimensions);\n\t}\n\n\tgetDimensions() {\n\t\treturn dom.getClientArea(this.container);\n\t}\n\n\tlayout() {\n\t\tthis._commentElements.forEach(element => {\n\t\t\telement.layout();\n\t\t});\n\t}\n\n\tgetPendingEdits(): { [key: number]: string } {\n\t\tconst pendingEdits: { [key: number]: string } = {};\n\t\tthis._commentElements.forEach(element => {\n\t\t\tif (element.isEditing) {\n\t\t\t\tconst pendingEdit = element.getPendingEdit();\n\t\t\t\tif (pendingEdit) {\n\t\t\t\t\tpendingEdits[element.comment.uniqueIdInThread] = pendingEdit;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn pendingEdits;\n\t}\n\n\tgetCommentCoords(commentUniqueId: number): { thread: dom.IDomNodePagePosition; comment: dom.IDomNodePagePosition } | undefined {\n\t\tconst matchedNode = this._commentElements.filter(commentNode => commentNode.comment.uniqueIdInThread === commentUniqueId);\n\t\tif (matchedNode && matchedNode.length) {\n\t\t\tconst commentThreadCoords = dom.getDomNodePagePosition(this._commentElements[0].domNode);\n\t\t\tconst commentCoords = dom.getDomNodePagePosition(matchedNode[0].domNode);\n\t\t\treturn {\n\t\t\t\tthread: commentThreadCoords,\n\t\t\t\tcomment: commentCoords\n\t\t\t};\n\t\t}\n\n\t\treturn;\n\t}\n\n\tupdateCommentThread(commentThread: languages.CommentThread<T>) {\n\t\tconst oldCommentsLen = this._commentElements.length;\n\t\tconst newCommentsLen = commentThread.comments ? commentThread.comments.length : 0;\n\n\t\tconst commentElementsToDel: CommentNode<T>[] = [];\n\t\tconst commentElementsToDelIndex: number[] = [];\n\t\tfor (let i = 0; i < oldCommentsLen; i++) {\n\t\t\tconst comment = this._commentElements[i].comment;\n\t\t\tconst newComment = commentThread.comments ? commentThread.comments.filter(c => c.uniqueIdInThread === comment.uniqueIdInThread) : [];\n\n\t\t\tif (newComment.length) {\n\t\t\t\tthis._commentElements[i].update(newComment[0]);\n\t\t\t} else {\n\t\t\t\tcommentElementsToDelIndex.push(i);\n\t\t\t\tcommentElementsToDel.push(this._commentElements[i]);\n\t\t\t}\n\t\t}\n\n\t\t// del removed elements\n\t\tfor (let i = commentElementsToDel.length - 1; i >= 0; i--) {\n\t\t\tconst commentToDelete = commentElementsToDel[i];\n\t\t\tthis._commentDisposable.get(commentToDelete)?.dispose();\n\t\t\tthis._commentDisposable.delete(commentToDelete);\n\n\t\t\tthis._commentElements.splice(commentElementsToDelIndex[i], 1);\n\t\t\tthis._commentsElement.removeChild(commentToDelete.domNode);\n\t\t}\n\n\n\t\tlet lastCommentElement: HTMLElement | null = null;\n\t\tconst newCommentNodeList: CommentNode<T>[] = [];\n\t\tconst newCommentsInEditMode: CommentNode<T>[] = [];\n\t\tfor (let i = newCommentsLen - 1; i >= 0; i--) {\n\t\t\tconst currentComment = commentThread.comments![i];\n\t\t\tconst oldCommentNode = this._commentElements.filter(commentNode => commentNode.comment.uniqueIdInThread === currentComment.uniqueIdInThread);\n\t\t\tif (oldCommentNode.length) {\n\t\t\t\tlastCommentElement = oldCommentNode[0].domNode;\n\t\t\t\tnewCommentNodeList.unshift(oldCommentNode[0]);\n\t\t\t} else {\n\t\t\t\tconst newElement = this.createNewCommentNode(currentComment);\n\n\t\t\t\tnewCommentNodeList.unshift(newElement);\n\t\t\t\tif (lastCommentElement) {\n\t\t\t\t\tthis._commentsElement.insertBefore(newElement.domNode, lastCommentElement);\n\t\t\t\t\tlastCommentElement = newElement.domNode;\n\t\t\t\t} else {\n\t\t\t\t\tthis._commentsElement.appendChild(newElement.domNode);\n\t\t\t\t\tlastCommentElement = newElement.domNode;\n\t\t\t\t}\n\n\t\t\t\tif (currentComment.mode === languages.CommentMode.Editing) {\n\t\t\t\t\tnewElement.switchToEditMode();\n\t\t\t\t\tnewCommentsInEditMode.push(newElement);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tthis._commentThread = commentThread;\n\t\tthis._commentElements = newCommentNodeList;\n\n\t\tif (newCommentsInEditMode.length) {\n\t\t\tconst lastIndex = this._commentElements.indexOf(newCommentsInEditMode[newCommentsInEditMode.length - 1]);\n\t\t\tthis._focusedComment = lastIndex;\n\t\t}\n\n\t\tthis._updateAriaLabel();\n\t\tthis._setFocusedComment(this._focusedComment);\n\t}\n\n\tprivate _updateAriaLabel() {\n\t\tif (this._commentThread.isDocumentCommentThread()) {\n\t\t\tif (this._commentThread.range) {\n\t\t\t\tthis._commentsElement.ariaLabel = nls.localize('commentThreadAria.withRange', \"Comment thread with {0} comments on lines {1} through {2}. {3}.\",\n\t\t\t\t\tthis._commentThread.comments?.length, this._commentThread.range.startLineNumber, this._commentThread.range.endLineNumber,\n\t\t\t\t\tthis._commentThread.label);\n\t\t\t} else {\n\t\t\t\tthis._commentsElement.ariaLabel = nls.localize('commentThreadAria.document', \"Comment thread with {0} comments on the entire document. {1}.\",\n\t\t\t\t\tthis._commentThread.comments?.length, this._commentThread.label);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._commentsElement.ariaLabel = nls.localize('commentThreadAria', \"Comment thread with {0} comments. {1}.\",\n\t\t\t\tthis._commentThread.comments?.length, this._commentThread.label);\n\t\t}\n\t}\n\n\tprivate _setFocusedComment(value: number | undefined) {\n\t\tif (this._focusedComment !== undefined) {\n\t\t\tthis._commentElements[this._focusedComment]?.setFocus(false);\n\t\t}\n\n\t\tif (this._commentElements.length === 0 || value === undefined) {\n\t\t\tthis._focusedComment = undefined;\n\t\t} else {\n\t\t\tthis._focusedComment = Math.min(value, this._commentElements.length - 1);\n\t\t\tthis._commentElements[this._focusedComment].setFocus(true);\n\t\t}\n\t}\n\n\tprivate createNewCommentNode(comment: languages.Comment): CommentNode<T> {\n\t\tconst newCommentNode = this._scopedInstatiationService.createInstance(CommentNode,\n\t\t\tthis._commentThread,\n\t\t\tcomment,\n\t\t\tthis._pendingEdits ? this._pendingEdits[comment.uniqueIdInThread!] : undefined,\n\t\t\tthis.owner,\n\t\t\tthis.parentResourceUri,\n\t\t\tthis._parentCommentThreadWidget,\n\t\t\tthis._markdownRenderer) as unknown as CommentNode<T>;\n\n\t\tthis._register(newCommentNode);\n\t\tthis._commentDisposable.set(newCommentNode, newCommentNode.onDidClick(clickedNode =>\n\t\t\tthis._setFocusedComment(this._commentElements.findIndex(commentNode => commentNode.comment.uniqueIdInThread === clickedNode.comment.uniqueIdInThread))\n\t\t));\n\n\t\treturn newCommentNode;\n\t}\n\n\tpublic override dispose(): void {\n\t\tsuper.dispose();\n\n\t\tif (this._resizeObserver) {\n\t\t\tthis._resizeObserver.disconnect();\n\t\t\tthis._resizeObserver = null;\n\t\t}\n\n\t\tthis._commentDisposable.forEach(v => v.dispose());\n\t}\n}\n"]}