/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/
define(["require", "exports", "assert", "vs/base/test/common/utils", "vs/editor/common/core/range", "vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/beforeEditPositionMapper", "vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/combineTextEditInfos", "vs/editor/common/model/bracketPairsTextModelPart/bracketPairsTree/length", "vs/editor/test/common/testTextModel"], function (require, exports, assert, utils_1, range_1, beforeEditPositionMapper_1, combineTextEditInfos_1, length_1, testTextModel_1) {
    "use strict";
    Object.defineProperty(exports, "__esModule", { value: true });
    suite('combineTextEditInfos', () => {
        (0, utils_1.ensureNoDisposablesAreLeakedInTestSuite)();
        for (let seed = 0; seed < 50; seed++) {
            test('test' + seed, () => {
                runTest(seed);
            });
        }
    });
    function runTest(seed) {
        const rng = new MersenneTwister(seed);
        const str = 'abcde\nfghij\nklmno\npqrst\n';
        const textModelS0 = (0, testTextModel_1.createTextModel)(str);
        const edits1 = getRandomEditInfos(textModelS0, rng.nextIntRange(1, 4), rng);
        const textModelS1 = (0, testTextModel_1.createTextModel)(textModelS0.getValue());
        textModelS1.applyEdits(edits1.map(e => toEdit(e)));
        const edits2 = getRandomEditInfos(textModelS1, rng.nextIntRange(1, 4), rng);
        const textModelS2 = (0, testTextModel_1.createTextModel)(textModelS1.getValue());
        textModelS2.applyEdits(edits2.map(e => toEdit(e)));
        const combinedEdits = (0, combineTextEditInfos_1.combineTextEditInfos)(edits1, edits2);
        for (const edit of combinedEdits) {
            const range = range_1.Range.fromPositions((0, length_1.lengthToPosition)(edit.startOffset), (0, length_1.lengthToPosition)((0, length_1.lengthAdd)(edit.startOffset, edit.newLength)));
            const value = textModelS2.getValueInRange(range);
            if (!value.match(/^(L|C|\n)*$/)) {
                throw new Error('Invalid edit: ' + value);
            }
            textModelS2.applyEdits([{
                    range,
                    text: textModelS0.getValueInRange(range_1.Range.fromPositions((0, length_1.lengthToPosition)(edit.startOffset), (0, length_1.lengthToPosition)(edit.endOffset))),
                }]);
        }
        assert.deepStrictEqual(textModelS2.getValue(), textModelS0.getValue());
        textModelS0.dispose();
        textModelS1.dispose();
        textModelS2.dispose();
    }
    function getRandomEditInfos(textModel, count, rng) {
        const edits = [];
        let i = 0;
        for (let j = 0; j < count; j++) {
            edits.push(getRandomEdit(textModel, i, rng));
            i = textModel.getOffsetAt((0, length_1.lengthToPosition)(edits[j].endOffset));
        }
        return edits;
    }
    function getRandomEdit(textModel, rangeOffsetStart, rng) {
        const textModelLength = textModel.getValueLength();
        const offsetStart = rng.nextIntRange(rangeOffsetStart, textModelLength);
        const offsetEnd = rng.nextIntRange(offsetStart, textModelLength);
        const lineCount = rng.nextIntRange(0, 3);
        const columnCount = rng.nextIntRange(0, 5);
        return new beforeEditPositionMapper_1.TextEditInfo((0, length_1.positionToLength)(textModel.getPositionAt(offsetStart)), (0, length_1.positionToLength)(textModel.getPositionAt(offsetEnd)), (0, length_1.toLength)(lineCount, columnCount));
    }
    function toEdit(editInfo) {
        const l = (0, length_1.lengthToObj)(editInfo.newLength);
        let text = '';
        for (let i = 0; i < l.lineCount; i++) {
            text += 'LLL\n';
        }
        for (let i = 0; i < l.columnCount; i++) {
            text += 'C';
        }
        return {
            range: range_1.Range.fromPositions((0, length_1.lengthToPosition)(editInfo.startOffset), (0, length_1.lengthToPosition)(editInfo.endOffset)),
            text
        };
    }
    // Generated by copilot
    class MersenneTwister {
        constructor(seed) {
            this.mt = new Array(624);
            this.index = 0;
            this.mt[0] = seed >>> 0;
            for (let i = 1; i < 624; i++) {
                const s = this.mt[i - 1] ^ (this.mt[i - 1] >>> 30);
                this.mt[i] = (((((s & 0xffff0000) >>> 16) * 0x6c078965) << 16) + (s & 0x0000ffff) * 0x6c078965 + i) >>> 0;
            }
        }
        nextInt() {
            if (this.index === 0) {
                this.generateNumbers();
            }
            let y = this.mt[this.index];
            y = y ^ (y >>> 11);
            y = y ^ ((y << 7) & 0x9d2c5680);
            y = y ^ ((y << 15) & 0xefc60000);
            y = y ^ (y >>> 18);
            this.index = (this.index + 1) % 624;
            return y >>> 0;
        }
        nextIntRange(start, endExclusive) {
            const range = endExclusive - start;
            return Math.floor(this.nextInt() / (0x100000000 / range)) + start;
        }
        generateNumbers() {
            for (let i = 0; i < 624; i++) {
                const y = (this.mt[i] & 0x80000000) + (this.mt[(i + 1) % 624] & 0x7fffffff);
                this.mt[i] = this.mt[(i + 397) % 624] ^ (y >>> 1);
                if ((y % 2) !== 0) {
                    this.mt[i] = this.mt[i] ^ 0x9908b0df;
                }
            }
        }
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29tYmluZVRleHRFZGl0SW5mb3MudGVzdC5qcyIsInNvdXJjZVJvb3QiOiJmaWxlOi8vL3dvcmtzcGFjZS9hcHBmbG93L3NyYy8iLCJzb3VyY2VzIjpbInZzL2VkaXRvci90ZXN0L2NvbW1vbi9tb2RlbC9icmFja2V0UGFpckNvbG9yaXplci9jb21iaW5lVGV4dEVkaXRJbmZvcy50ZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7Z0dBR2dHOzs7O0lBWWhHLEtBQUssQ0FBQyxzQkFBc0IsRUFBRSxHQUFHLEVBQUU7UUFFbEMsSUFBQSwrQ0FBdUMsR0FBRSxDQUFDO1FBRTFDLEtBQUssSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFLElBQUksR0FBRyxFQUFFLEVBQUUsSUFBSSxFQUFFLEVBQUU7WUFDckMsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLEVBQUUsR0FBRyxFQUFFO2dCQUN4QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDZixDQUFDLENBQUMsQ0FBQztTQUNIO0lBQ0YsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLE9BQU8sQ0FBQyxJQUFZO1FBQzVCLE1BQU0sR0FBRyxHQUFHLElBQUksZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBRXRDLE1BQU0sR0FBRyxHQUFHLDhCQUE4QixDQUFDO1FBQzNDLE1BQU0sV0FBVyxHQUFHLElBQUEsK0JBQWUsRUFBQyxHQUFHLENBQUMsQ0FBQztRQUV6QyxNQUFNLE1BQU0sR0FBRyxrQkFBa0IsQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDNUUsTUFBTSxXQUFXLEdBQUcsSUFBQSwrQkFBZSxFQUFDLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDO1FBQzVELFdBQVcsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFD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